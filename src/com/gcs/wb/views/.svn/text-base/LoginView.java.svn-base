/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * LoginView.java
 *
 * Created on 30-11-2009, 08:14:03
 */
package com.gcs.wb.views;

import com.gcs.wb.WeighBridgeApp;
import com.gcs.wb.bapi.BAPIConfiguration;
import com.gcs.wb.bapi.helper.constants.PlantGeDetailConstants;
import com.gcs.wb.bapi.helper.PlantGetDetailBapi;
import com.gcs.wb.bapi.helper.structure.UserGetDetailAGRStructure;
import com.gcs.wb.bapi.helper.structure.UserGetDetailAddrStructure;
import com.gcs.wb.bapi.helper.UserGetDetailBapi;
import com.gcs.wb.jpa.entity.SAPSetting;
import com.gcs.wb.jpa.entity.SAPSettingPK;
import com.gcs.wb.jpa.entity.User;
import com.gcs.wb.jpa.entity.UserPK;
import com.gcs.wb.model.AppConfig;
import com.sap.conn.jco.JCoException;
import java.awt.Color;
import java.util.HashMap;
import java.util.List;
import javax.persistence.EntityManager;
import javax.swing.JDialog;
import javax.swing.JOptionPane;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;
import javax.swing.text.BadLocationException;
import org.apache.log4j.Level;
import org.apache.log4j.Logger;
import org.hibersap.HibersapException;
import org.hibersap.session.Credentials;
import org.hibersap.session.Session;
import org.hibersap.session.SessionManager;
import org.jdesktop.application.Action;
import org.jdesktop.application.Application;
import org.jdesktop.application.Task;

/**
 *
 * @author Tran-Vu
 */
public class LoginView extends javax.swing.JDialog {

    /** Creates new form LoginView */
    public LoginView(java.awt.Frame parent) {
        super(parent);
        initComponents();
        lblIcon.setVisible(false);
        txtUsr.getDocument().addDocumentListener(new DocumentListener() {

            @Override
            public void insertUpdate(DocumentEvent e) {
                validateUsr(e);
            }

            @Override
            public void removeUpdate(DocumentEvent e) {
                validateUsr(e);
            }

            @Override
            public void changedUpdate(DocumentEvent e) {
                validateUsr(e);
            }
        });
        txtPwd.getDocument().addDocumentListener(new DocumentListener() {

            @Override
            public void insertUpdate(DocumentEvent e) {
                validatePwd(e);
            }

            @Override
            public void removeUpdate(DocumentEvent e) {
                validatePwd(e);
            }

            @Override
            public void changedUpdate(DocumentEvent e) {
                validatePwd(e);
            }
        });
        validateForm();
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {
        bindingGroup = new org.jdesktop.beansbinding.BindingGroup();

        jPanel2 = new javax.swing.JPanel();
        jPanel1 = new javax.swing.JPanel();
        lblUsr = new javax.swing.JLabel();
        txtUsr = new javax.swing.JTextField();
        lblPwd = new javax.swing.JLabel();
        txtPwd = new javax.swing.JPasswordField();
        jPanel3 = new javax.swing.JPanel();
        lblIcon = new org.jdesktop.swingx.JXBusyLabel();
        btnOK = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        org.jdesktop.application.ResourceMap resourceMap = org.jdesktop.application.Application.getInstance(com.gcs.wb.WeighBridgeApp.class).getContext().getResourceMap(LoginView.class);
        setTitle(resourceMap.getString("Form.title")); // NOI18N
        setFont(resourceMap.getFont("Form.font")); // NOI18N
        setModal(true);
        setName("Form"); // NOI18N
        setResizable(false);

        jPanel2.setName("jPanel2"); // NOI18N
        jPanel2.setPreferredSize(new java.awt.Dimension(332, 139));

        jPanel1.setName("jPanel1"); // NOI18N
        jPanel1.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        lblUsr.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        lblUsr.setText(resourceMap.getString("lblUsr.text")); // NOI18N
        lblUsr.setName("lblUsr"); // NOI18N
        jPanel1.add(lblUsr, new org.netbeans.lib.awtextra.AbsoluteConstraints(2, 14, -1, -1));

        txtUsr.setForeground(resourceMap.getColor("txtUsr.foreground")); // NOI18N
        txtUsr.setText(resourceMap.getString("txtUsr.text")); // NOI18N
        txtUsr.setName("txtUsr"); // NOI18N
        txtUsr.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusGained(java.awt.event.FocusEvent evt) {
                txtUsrFocusGained(evt);
            }
            public void focusLost(java.awt.event.FocusEvent evt) {
                txtUsrFocusLost(evt);
            }
        });
        jPanel1.add(txtUsr, new org.netbeans.lib.awtextra.AbsoluteConstraints(89, 11, 220, -1));

        lblPwd.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        lblPwd.setText(resourceMap.getString("lblPwd.text")); // NOI18N
        lblPwd.setName("lblPwd"); // NOI18N
        jPanel1.add(lblPwd, new org.netbeans.lib.awtextra.AbsoluteConstraints(2, 40, 72, -1));

        txtPwd.setText(resourceMap.getString("txtPwd.text")); // NOI18N
        javax.swing.ActionMap actionMap = org.jdesktop.application.Application.getInstance(com.gcs.wb.WeighBridgeApp.class).getContext().getActionMap(LoginView.class, this);
        txtPwd.setAction(actionMap.get("login")); // NOI18N
        txtPwd.setName("txtPwd"); // NOI18N

        org.jdesktop.beansbinding.Binding binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, txtUsr, org.jdesktop.beansbinding.ELProperty.create("${enabled}"), txtPwd, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        txtPwd.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusGained(java.awt.event.FocusEvent evt) {
                txtPwdFocusGained(evt);
            }
        });
        jPanel1.add(txtPwd, new org.netbeans.lib.awtextra.AbsoluteConstraints(89, 37, 220, -1));

        jPanel2.add(jPanel1);

        jPanel3.setName("jPanel3"); // NOI18N

        lblIcon.setBusy(true);
        lblIcon.setLabelFor(btnOK);
        lblIcon.setText(resourceMap.getString("lblIcon.text")); // NOI18N
        lblIcon.setDirection(org.jdesktop.swingx.JXBusyLabel.Direction.RIGHT);
        lblIcon.setName("lblIcon"); // NOI18N
        jPanel3.add(lblIcon);

        btnOK.setAction(actionMap.get("login")); // NOI18N
        btnOK.setText(resourceMap.getString("btnOK.text")); // NOI18N
        btnOK.setName("btnOK"); // NOI18N
        jPanel3.add(btnOK);

        jPanel2.add(jPanel3);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, 120, javax.swing.GroupLayout.PREFERRED_SIZE)
        );

        bindingGroup.bind();

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void txtUsrFocusGained(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_txtUsrFocusGained
        txtUsr.selectAll();
    }//GEN-LAST:event_txtUsrFocusGained

    private void txtPwdFocusGained(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_txtPwdFocusGained
        txtPwd.selectAll();
    }//GEN-LAST:event_txtPwdFocusGained

    private void txtUsrFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_txtUsrFocusLost
        txtUsr.setText(txtUsr.getText().toUpperCase());
    }//GEN-LAST:event_txtUsrFocusLost
    // <editor-fold defaultstate="expanded" desc="Variables Getter/Setter">

    /**
     * @return the authenticated
     */
    public boolean isAuthenticated() {
        return authenticated;
    }
    // </editor-fold>
    // <editor-fold defaultstate="expanded" desc="Event Handlers area">

    @Action
    public void clearForm() {
        txtUsr.setText(null);
        txtPwd.setText(null);
    }

    @Action()
    public Task login() {
        if (!isValidatedForm()) {
            return null;
        } else {
            return new LoginTask(WeighBridgeApp.getApplication(), this);
        }
    }

    private class LoginTask extends org.jdesktop.application.Task<Object, Void> {

        Credentials cre = null;
        AppConfig lconfig = null;
        SAPSetting sSetting = null;
        User usr = null;
        String lclient = null;
        String lplant = null;
        String lusr = null;
        String lpwd = null;
//        boolean lOfflineMode = true;
        boolean lOfflineMode = false;
        JCoException jcoEx = null;

        LoginTask(Application app, JDialog view) {
            super(app);
            lconfig = WeighBridgeApp.getApplication().getConfig();
            lclient = lconfig.getsClient();
            lplant = lconfig.getwPlant().toString();
            lusr = txtUsr.getText().trim();
            lpwd = new String(txtPwd.getPassword()).trim();
            lblIcon.setVisible(true);
            btnOK.setVisible(false);
            txtUsr.setEditable(false);
            txtPwd.setEditable(false);
        }

        @Override
        protected Object doInBackground() throws Exception {
            EntityManager em = WeighBridgeApp.getApplication().getEm();
            cre = new Credentials();
            cre.setClient(lclient);
            cre.setUser(lusr);
            cre.setPassword(lpwd);

            UserGetDetailBapi bUsr = new UserGetDetailBapi();
            bUsr.setUserName(lusr);

            try {
                boolean updateUsr = true;

                usr = em.find(User.class, new UserPK(lclient, lplant, lusr));
                sSetting = em.find(SAPSetting.class, new SAPSettingPK(lclient, lplant));

                Session session = WeighBridgeApp.getApplication().getSAPSession();
                if (session != null) {
                    session.close();
                    session = null;
                }
                SessionManager sesMan = BAPIConfiguration.getSessionManager(lconfig, cre);
                session = sesMan.openSession(cre);
                WeighBridgeApp.getApplication().setSAPSession(session);
                session.execute(bUsr);

                UserGetDetailAddrStructure add = bUsr.getAddress();
                List<UserGetDetailAGRStructure> roles = bUsr.getActgrps();

                StringBuilder sbRoles = new StringBuilder();
                for (int i = 0; i < roles.size(); i++) {
                    UserGetDetailAGRStructure role = roles.get(i);
                    sbRoles.append(role.getAgr_name());
                    if (i < roles.size() - 1) {
                        sbRoles.append(",");
                    }
                }

                em.getTransaction().begin();
                if (usr == null) {
                    updateUsr = false;
                    if (sSetting == null) {
                        PlantGetDetailBapi bPlant = new PlantGetDetailBapi(lclient, lplant);
                        session.execute(bPlant);
                        HashMap vals = bPlant.getEsPlant();

                        sSetting = new SAPSetting(new SAPSettingPK(lclient, lplant));
                        sSetting.setName1((String) vals.get(PlantGeDetailConstants.NAME1));
                        sSetting.setName2((String) vals.get(PlantGeDetailConstants.NAME2));
                        em.persist(sSetting);
                    }
                    usr = new User(new UserPK(lclient, lplant, lusr), lpwd);
                }
                usr.setFullName(add.getFullName());
                usr.setLanguP(add.getLang().length() == 0 ? ' ' : add.getLang().charAt(0));
                usr.setLangupIso(add.getLangISO());
                usr.setPwd(lpwd);
                usr.setRoles(sbRoles.toString());
                usr.setTitle(add.getTitle());
                if (updateUsr) {
                    em.merge(usr);
                } else {
                    em.persist(usr);
                }
                em.getTransaction().commit();
                em.clear();
                succeeded(true);
            } catch (Exception ex) {
                if (em.getTransaction().isActive()) {
                    em.getTransaction().rollback();
                }
                if (ex.getCause() instanceof JCoException) {
                    jcoEx = (JCoException) ex.getCause();
//                    if (jcoEx.getGroup() != JCoException.JCO_ERROR_COMMUNICATION) {
                    failed(jcoEx);
//                    }
                } else {
                    failed(ex);
                }
            }

//            if (usr != null && !usr.getPwd().equals(lpwd)) {
//                failed(new Exception("Authenticated Failed!!!"));
//            }

//            if (usr == null) {
//                failed(jcoEx);
//            } else if (!usr.getPwd().equals(lpwd)) {
//                failed(new Exception("Authenticated Failed!!!"));
//            } else {
//                lOfflineMode = false;
//                succeeded(true);
//            }
            return null;
        }

        @Override
        protected void succeeded(Object result) {
            authenticated = true;
            WeighBridgeApp.getApplication().setCredentials(cre);
            WeighBridgeApp.getApplication().setLogin(usr);
            WeighBridgeApp.getApplication().setOfflineMode(lOfflineMode);
            WeighBridgeApp.getApplication().setSapSetting(sSetting);
            setVisible(false);
        }

        @Override
        protected void failed(Throwable cause) {
            if (cause instanceof HibersapException && cause.getCause() instanceof JCoException) {
                cause = cause.getCause();
                Session ses = WeighBridgeApp.getApplication().getSAPSession();
                if (ses != null) {
                    ses.close();
                    ses = null;
                }
                WeighBridgeApp.getApplication().setSAPSession(ses);
            }

            lblIcon.setVisible(false);
            btnOK.setVisible(true);
            txtUsr.setEditable(true);
            txtPwd.setEditable(true);
            Logger.getLogger(LoginView.class.getName()).log(Level.ERROR, null, cause);
            JOptionPane.showMessageDialog(rootPane, cause.getMessage());
            done();
        }
    }

    public boolean isValidatedForm() {
        return validatedForm;
    }

    private void setValidatedForm(boolean b) {
        boolean old = isValidatedForm();
        this.validatedForm = b;
        firePropertyChange("validatedForm", old, isValidatedForm());
    }

    private void validateUsr(DocumentEvent e) {
        try {
            String text = e.getDocument().getText(0, e.getDocument().getLength()).trim();
            validUsr = text.length() > 0 && text.length() <= 12;
            if (validUsr) {
                lblUsr.setForeground(Color.BLACK);
            } else {
                lblUsr.setForeground(Color.RED);
            }
        } catch (BadLocationException ex) {
            Logger.getLogger(LoginView.class.getName()).log(Level.ERROR, null, ex);
        } finally {
            validateForm();
        }
    }

    private void validatePwd(DocumentEvent e) {
        try {
            String text = e.getDocument().getText(0, e.getDocument().getLength()).trim();
            validPwd = text.length() > 0;
            if (validUsr) {
                lblPwd.setForeground(Color.BLACK);
            } else {
                lblPwd.setForeground(Color.RED);
            }
        } catch (BadLocationException ex) {
            Logger.getLogger(LoginView.class.getName()).log(Level.ERROR, null, ex);
        } finally {
            validateForm();
        }
    }

    public void validateForm() {
        boolean result = false;
        if (validUsr) {
            lblUsr.setForeground(Color.BLACK);
        } else {
            lblUsr.setForeground(Color.RED);
        }
        if (validPwd) {
            lblPwd.setForeground(Color.BLACK);
        } else {
            lblPwd.setForeground(Color.RED);
        }
        result = validUsr && validPwd;
        setValidatedForm(result);
        if (result) {
            btnOK.setEnabled(true);
        } else {
            btnOK.setEnabled(false);
        }
//        return result;
    }
    // </editor-fold>
    // <editor-fold defaultstate="collapsed" desc="Variables declaration area">
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnOK;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private org.jdesktop.swingx.JXBusyLabel lblIcon;
    private javax.swing.JLabel lblPwd;
    private javax.swing.JLabel lblUsr;
    private javax.swing.JPasswordField txtPwd;
    private javax.swing.JTextField txtUsr;
    private org.jdesktop.beansbinding.BindingGroup bindingGroup;
    // End of variables declaration//GEN-END:variables
    private boolean authenticated = false;
    private boolean validUsr = false;
    private boolean validPwd = false;
    private boolean validatedForm = false;
    // </editor-fold >
}
