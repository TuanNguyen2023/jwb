/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * GoodsIssueView.java
 *
 * Created on 26-11-2009, 14:22:57
 */
package com.gcs.wb.views;

import com.gcs.wb.WeighBridgeApp;
import com.gcs.wb.bapi.SAPErrorTransform;
import com.gcs.wb.bapi.goodsmvt.GoodsMvtDoCreateBapi;
import com.gcs.wb.bapi.goodsmvt.GoodsMvtPoCreateBapi;
import com.gcs.wb.bapi.goodsmvt.structure.GoodsMvtCodeStructure;
import com.gcs.wb.bapi.goodsmvt.structure.GoodsMvtHeaderStructure;
import com.gcs.wb.bapi.goodsmvt.structure.GoodsMvtItemDoStructure;
import com.gcs.wb.bapi.goodsmvt.structure.GoodsMvtItemPoStructure;
import com.gcs.wb.bapi.helper.MatAvailableBapi;
import com.gcs.wb.bapi.helper.MvtGetDetailBapi;
import com.gcs.wb.bapi.helper.structure.BatchStocksStructure;
import com.gcs.wb.bapi.helper.MvtReasonsGetListBapi;
import com.gcs.wb.bapi.helper.structure.MvtReasonsGetListStructure;
import com.gcs.wb.bapi.helper.SAP2Local;
import com.gcs.wb.bapi.helper.structure.MatAvailableStructure;
import com.gcs.wb.bapi.outbdlv.DOCreate2PGIBapi;
import com.gcs.wb.bapi.outbdlv.WsDeliveryUpdateBapi;
import com.gcs.wb.bapi.outbdlv.structure.OutbDeliveryCreateStoStructure;
import com.gcs.wb.bapi.outbdlv.structure.VbkokStructure;
import com.gcs.wb.bapi.outbdlv.structure.VbpokStructure;
import com.gcs.wb.jpa.JpaProperties;
import com.gcs.wb.jpa.entity.BatchStocks;
import com.gcs.wb.jpa.entity.BatchStocksPK;
import com.gcs.wb.jpa.entity.Customer;
import com.gcs.wb.jpa.entity.CustomerPK;
import com.gcs.wb.jpa.entity.Movement;
import com.gcs.wb.jpa.entity.MovementPK;
import com.gcs.wb.jpa.entity.OutbDel;
import com.gcs.wb.jpa.entity.OutbDelPK;
import com.gcs.wb.jpa.entity.PurOrder;
import com.gcs.wb.jpa.entity.PurOrderPK;
import com.gcs.wb.jpa.entity.Reason;
import com.gcs.wb.jpa.entity.ReasonPK;
import com.gcs.wb.jpa.entity.SLoc;
import com.gcs.wb.jpa.entity.SLocPK;
import com.gcs.wb.jpa.entity.Vehicle;
import com.gcs.wb.jpa.entity.Vendor;
import com.gcs.wb.jpa.entity.VendorPK;
import com.gcs.wb.jpa.entity.WeightTicket;
import com.gcs.wb.jpa.entity.WeightTicketPK;
import com.gcs.wb.utils.RegexFormatter;
import com.sap.conn.jco.JCoException;
import java.awt.Color;
import java.awt.Component;
import java.math.BigDecimal;
import java.sql.Connection;
import java.sql.DriverManager;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import javax.persistence.NoResultException;
import javax.persistence.TypedQuery;
import javax.swing.DefaultComboBoxModel;
import javax.swing.DefaultListCellRenderer;
import javax.swing.JList;
import javax.swing.JOptionPane;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;
import javax.swing.text.BadLocationException;
import net.sf.jasperreports.engine.JasperFillManager;
import net.sf.jasperreports.engine.JasperPrint;
import net.sf.jasperreports.view.JasperViewer;
import org.apache.log4j.Logger;
import org.eclipse.persistence.config.PersistenceUnitProperties;
import org.hibersap.HibersapException;
import org.hibersap.SapException;
import org.hibersap.session.Session;
import org.hibersap.util.DateUtil;
import org.jdesktop.application.Action;
import org.jdesktop.application.Application;
import org.jdesktop.application.Task;

/**
 *
 * @author Tran-Vu
 */
public class WeightTicketView extends javax.swing.JInternalFrame {

    public WeightTicketView() {
        initComponents();
        txtMatnr.getDocument().addDocumentListener(new DocumentListener() {

            @Override
            public void insertUpdate(DocumentEvent e) {
                getSAPMatData(e);
            }

            @Override
            public void removeUpdate(DocumentEvent e) {
                getSAPMatData(e);
            }

            @Override
            public void changedUpdate(DocumentEvent e) {
                getSAPMatData(e);
            }
        });
        setBridge1(config.getB1Port() != null);
        setBridge2(config.getB2Port() != null);
        formatter = new SimpleDateFormat();
        cbxSLoc.setSelectedIndex(-1);
        cbxReason.setSelectedIndex(-1);
        txfCurScale.setEditable(true); //Set manual input qty in wheighing
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {
        bindingGroup = new org.jdesktop.beansbinding.BindingGroup();

        grbType = new javax.swing.ButtonGroup();
        grbBridge = new javax.swing.ButtonGroup();
        grbCat = new javax.swing.ButtonGroup();
        entityManager = WeighBridgeApp.getApplication().getEm();
        weightTicket = new com.gcs.wb.jpa.entity.WeightTicket();
        purOrder = new com.gcs.wb.jpa.entity.PurOrder();
        outbDel = new com.gcs.wb.jpa.entity.OutbDel();
        config = WeighBridgeApp.getApplication().getConfig();
        setting = java.beans.Beans.isDesignTime() ? null : WeighBridgeApp.getApplication().getSapSetting();
        material = new com.gcs.wb.jpa.entity.Material();
        pnWTFilter = new javax.swing.JPanel();
        lblWTNum = new javax.swing.JLabel();
        rbtPO = new javax.swing.JRadioButton();
        txtPONum = new javax.swing.JTextField();
        rbtMisc = new javax.swing.JRadioButton();
        txtWTNum = new javax.swing.JTextField();
        rbtMb1b = new javax.swing.JRadioButton();
        rbtMvt311 = new javax.swing.JRadioButton();
        pnCurScale = new javax.swing.JPanel();
        pnCurScaleData = new javax.swing.JPanel();
        rbtBridge1 = new javax.swing.JRadioButton();
        rbtBridge2 = new javax.swing.JRadioButton();
        txfCurScale = new javax.swing.JFormattedTextField();
        lblKG = new javax.swing.JLabel();
        btnAccept = new javax.swing.JButton();
        pnScaleData = new javax.swing.JPanel();
        lblIScale = new javax.swing.JLabel();
        lblOScale = new javax.swing.JLabel();
        lblGScale = new javax.swing.JLabel();
        txfInQty = new javax.swing.JFormattedTextField();
        txfOutQty = new javax.swing.JFormattedTextField();
        txfGoodsQty = new javax.swing.JFormattedTextField();
        lblIUnit = new javax.swing.JLabel();
        lblITime = new javax.swing.JLabel();
        lblOUnit = new javax.swing.JLabel();
        lblOTime = new javax.swing.JLabel();
        lblGUnit = new javax.swing.JLabel();
        txtInTime = new javax.swing.JTextField();
        txtOutTime = new javax.swing.JTextField();
        btnIScaleReset = new javax.swing.JButton();
        btnOScaleReset = new javax.swing.JButton();
        pnWTicket = new javax.swing.JPanel();
        lblDName = new javax.swing.JLabel();
        txtDName = new javax.swing.JTextField();
        lblCMNDBL = new javax.swing.JLabel();
        txtCMNDBL = new javax.swing.JTextField();
        lblLicPlate = new javax.swing.JLabel();
        txtLicPlate = new javax.swing.JFormattedTextField(new RegexFormatter("\\d{2}\\w-\\d{4}"));
        lblTrailerPlate = new javax.swing.JLabel();
        txtTrailerPlate = new javax.swing.JFormattedTextField(new RegexFormatter("\\d{2}\\w-\\d{4}"));
        lblRegCat = new javax.swing.JLabel();
        rbtInward = new javax.swing.JRadioButton();
        rbtOutward = new javax.swing.JRadioButton();
        lblRegItem = new javax.swing.JLabel();
        txtRegItem = new javax.swing.JTextField();
        lblMatnr = new javax.swing.JLabel();
        lblDelNum = new javax.swing.JLabel();
        txtDelNum = new javax.swing.JTextField();
        lblSLoc = new javax.swing.JLabel();
        cbxSLoc = new javax.swing.JComboBox();
        lblBatch = new javax.swing.JLabel();
        cbxBatch = new javax.swing.JComboBox();
        lblReason = new javax.swing.JLabel();
        cbxReason = new javax.swing.JComboBox();
        lblCementDesc = new javax.swing.JLabel();
        txtCementDesc = new javax.swing.JTextField();
        lblGRText = new javax.swing.JLabel();
        txtGRText = new javax.swing.JTextField();
        lblComplete = new javax.swing.JLabel();
        cbxCompleted = new javax.swing.JComboBox();
        chkDissolved = new javax.swing.JCheckBox();
        txtMatnr = new javax.swing.JTextField();
        btnSave = new javax.swing.JButton();
        btnReprint = new javax.swing.JButton();

        entityManager.clear();

        org.jdesktop.application.ResourceMap resourceMap = org.jdesktop.application.Application.getInstance(com.gcs.wb.WeighBridgeApp.class).getContext().getResourceMap(WeightTicketView.class);
        setBackground(resourceMap.getColor("Form.background")); // NOI18N
        setClosable(true);
        setMaximizable(true);
        setResizable(true);
        setTitle(resourceMap.getString("Form.title")); // NOI18N
        setName("Form"); // NOI18N

        pnWTFilter.setBorder(javax.swing.BorderFactory.createTitledBorder(resourceMap.getString("pnWTFilter.border.title"))); // NOI18N
        pnWTFilter.setMinimumSize(new java.awt.Dimension(306, 138));
        pnWTFilter.setName("pnWTFilter"); // NOI18N
        pnWTFilter.setPreferredSize(new java.awt.Dimension(306, 138));

        lblWTNum.setText(resourceMap.getString("lblWTNum.text")); // NOI18N
        lblWTNum.setName("lblWTNum"); // NOI18N

        javax.swing.ActionMap actionMap = org.jdesktop.application.Application.getInstance(com.gcs.wb.WeighBridgeApp.class).getContext().getActionMap(WeightTicketView.class, this);
        rbtPO.setAction(actionMap.get("selectRbtPO")); // NOI18N
        grbType.add(rbtPO);
        rbtPO.setText(resourceMap.getString("rbtPO.text")); // NOI18N
        rbtPO.setName("rbtPO"); // NOI18N

        org.jdesktop.beansbinding.Binding binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${withoutDO}"), rbtPO, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        rbtPO.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                rbtPOItemStateChanged(evt);
            }
        });

        txtPONum.setFont(txtPONum.getFont().deriveFont(txtPONum.getFont().getStyle() | java.awt.Font.BOLD, txtPONum.getFont().getSize()+2));
        txtPONum.setForeground(resourceMap.getColor("txtPONum.foreground")); // NOI18N
        txtPONum.setText(resourceMap.getString("txtPONum.text")); // NOI18N
        txtPONum.setAction(actionMap.get("readPO")); // NOI18N
        txtPONum.setName("txtPONum"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, rbtPO, org.jdesktop.beansbinding.ELProperty.create("${selected}"), txtPONum, org.jdesktop.beansbinding.BeanProperty.create("editable"));
        bindingGroup.addBinding(binding);
        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, rbtPO, org.jdesktop.beansbinding.ELProperty.create("${enabled}"), txtPONum, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        txtPONum.getDocument().addDocumentListener(new DocumentListener() {

            public void insertUpdate(DocumentEvent e) {
                checkPONum(e);
            }

            public void removeUpdate(DocumentEvent e) {
                checkPONum(e);
            }

            public void changedUpdate(DocumentEvent e) {
                checkPONum(e);
            }
        });

        rbtMisc.setAction(actionMap.get("selectRbtMisc")); // NOI18N
        grbType.add(rbtMisc);
        rbtMisc.setText(resourceMap.getString("rbtMisc.text")); // NOI18N
        rbtMisc.setMaximumSize(new java.awt.Dimension(67, 20));
        rbtMisc.setMinimumSize(new java.awt.Dimension(67, 20));
        rbtMisc.setName("rbtMisc"); // NOI18N
        rbtMisc.setPreferredSize(new java.awt.Dimension(67, 20));

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${withoutDO}"), rbtMisc, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        rbtMisc.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                rbtMiscItemStateChanged(evt);
            }
        });

        txtWTNum.setFont(txtWTNum.getFont().deriveFont(txtWTNum.getFont().getStyle() | java.awt.Font.BOLD, txtWTNum.getFont().getSize()+2));
        txtWTNum.setForeground(resourceMap.getColor("txtWTNum.foreground")); // NOI18N
        txtWTNum.setText(resourceMap.getString("txtWTNum.text")); // NOI18N
        txtWTNum.setAction(actionMap.get("readWT")); // NOI18N
        txtWTNum.setName("txtWTNum"); // NOI18N
        txtWTNum.getDocument().addDocumentListener(new DocumentListener() {

            public void insertUpdate(DocumentEvent e) {
                checkWTNum(e);
            }

            public void removeUpdate(DocumentEvent e) {
                checkWTNum(e);
            }

            public void changedUpdate(DocumentEvent e) {
                checkWTNum(e);
            }
        });

        rbtMb1b.setAction(actionMap.get("showMB1BOption")); // NOI18N
        grbType.add(rbtMb1b);
        rbtMb1b.setText(resourceMap.getString("rbtMb1b.text")); // NOI18N
        rbtMb1b.setName("rbtMb1b"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${withoutDO}"), rbtMb1b, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        rbtMb1b.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                rbtMb1bItemStateChanged(evt);
            }
        });

        rbtMvt311.setAction(actionMap.get("selectRbtMvt311")); // NOI18N
        grbType.add(rbtMvt311);
        rbtMvt311.setText(resourceMap.getString("rbtMvt311.text")); // NOI18N
        rbtMvt311.setName("rbtMvt311"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${withoutDO}"), rbtMvt311, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        rbtMvt311.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                rbtMvt311ItemStateChanged(evt);
            }
        });

        javax.swing.GroupLayout pnWTFilterLayout = new javax.swing.GroupLayout(pnWTFilter);
        pnWTFilter.setLayout(pnWTFilterLayout);
        pnWTFilterLayout.setHorizontalGroup(
            pnWTFilterLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnWTFilterLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pnWTFilterLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(pnWTFilterLayout.createSequentialGroup()
                        .addComponent(lblWTNum)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(txtWTNum, javax.swing.GroupLayout.DEFAULT_SIZE, 219, Short.MAX_VALUE))
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pnWTFilterLayout.createSequentialGroup()
                        .addGroup(pnWTFilterLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(pnWTFilterLayout.createSequentialGroup()
                                .addComponent(rbtPO)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(txtPONum, javax.swing.GroupLayout.DEFAULT_SIZE, 98, Short.MAX_VALUE))
                            .addComponent(rbtMvt311, javax.swing.GroupLayout.DEFAULT_SIZE, 147, Short.MAX_VALUE))
                        .addGap(18, 18, 18)
                        .addGroup(pnWTFilterLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(rbtMb1b, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(rbtMisc, javax.swing.GroupLayout.DEFAULT_SIZE, 101, Short.MAX_VALUE))))
                .addGap(18, 18, 18))
        );
        pnWTFilterLayout.setVerticalGroup(
            pnWTFilterLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnWTFilterLayout.createSequentialGroup()
                .addGroup(pnWTFilterLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(pnWTFilterLayout.createSequentialGroup()
                        .addGap(5, 5, 5)
                        .addComponent(lblWTNum))
                    .addComponent(txtWTNum, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(pnWTFilterLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(rbtPO)
                    .addComponent(txtPONum, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(rbtMb1b))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnWTFilterLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(rbtMisc, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(rbtMvt311))
                .addContainerGap(31, Short.MAX_VALUE))
        );

        pnCurScale.setBorder(javax.swing.BorderFactory.createTitledBorder(resourceMap.getString("pnCurScale.border.title"))); // NOI18N
        pnCurScale.setFocusable(false);
        pnCurScale.setMinimumSize(new java.awt.Dimension(292, 138));
        pnCurScale.setName("pnCurScale"); // NOI18N
        pnCurScale.setPreferredSize(new java.awt.Dimension(292, 138));
        pnCurScale.setLayout(new java.awt.BorderLayout());

        pnCurScaleData.setBackground(resourceMap.getColor("pnCurScaleData.background")); // NOI18N
        pnCurScaleData.setFocusable(false);
        pnCurScaleData.setMaximumSize(new java.awt.Dimension(281, 89));
        pnCurScaleData.setMinimumSize(new java.awt.Dimension(281, 89));
        pnCurScaleData.setName("pnCurScaleData"); // NOI18N
        pnCurScaleData.setPreferredSize(new java.awt.Dimension(280, 95));

        rbtBridge1.setBackground(resourceMap.getColor("rbtBridge1.background")); // NOI18N
        grbBridge.add(rbtBridge1);
        rbtBridge1.setFont(resourceMap.getFont("rbtBridge2.font")); // NOI18N
        rbtBridge1.setForeground(resourceMap.getColor("rbtBridge2.foreground")); // NOI18N
        rbtBridge1.setText(resourceMap.getString("rbtBridge1.text")); // NOI18N
        rbtBridge1.setToolTipText(resourceMap.getString("rbtBridge1.toolTipText")); // NOI18N
        rbtBridge1.setName("rbtBridge1"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${bridge1}"), rbtBridge1, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        rbtBridge1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                rbtBridge1ActionPerformed(evt);
            }
        });

        rbtBridge2.setAction(actionMap.get("checkedBridge2")); // NOI18N
        rbtBridge2.setBackground(resourceMap.getColor("rbtBridge2.background")); // NOI18N
        grbBridge.add(rbtBridge2);
        rbtBridge2.setFont(resourceMap.getFont("rbtBridge2.font")); // NOI18N
        rbtBridge2.setForeground(resourceMap.getColor("rbtBridge2.foreground")); // NOI18N
        rbtBridge2.setText(resourceMap.getString("rbtBridge2.text")); // NOI18N
        rbtBridge2.setName("rbtBridge2"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${bridge2}"), rbtBridge2, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        rbtBridge2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                rbtBridge2ActionPerformed(evt);
            }
        });

        txfCurScale.setBackground(resourceMap.getColor("txfCurScale.background")); // NOI18N
        txfCurScale.setBorder(null);
        txfCurScale.setEditable(false);
        txfCurScale.setForeground(resourceMap.getColor("txfCurScale.foreground")); // NOI18N
        txfCurScale.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter()));
        txfCurScale.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txfCurScale.setFont(resourceMap.getFont("txfCurScale.font")); // NOI18N
        txfCurScale.setName("txfCurScale"); // NOI18N
        txfCurScale.setPreferredSize(new java.awt.Dimension(227, 38));
        txfCurScale.setValue((Number)0);

        lblKG.setBackground(resourceMap.getColor("lblKG.background")); // NOI18N
        lblKG.setFont(resourceMap.getFont("lblKG.font")); // NOI18N
        lblKG.setForeground(resourceMap.getColor("lblKG.foreground")); // NOI18N
        lblKG.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        lblKG.setText(resourceMap.getString("lblKG.text")); // NOI18N
        lblKG.setName("lblKG"); // NOI18N

        btnAccept.setAction(actionMap.get("acceptScale")); // NOI18N
        btnAccept.setFont(resourceMap.getFont("btnAccept.font")); // NOI18N
        btnAccept.setText(resourceMap.getString("btnAccept.text")); // NOI18N
        btnAccept.setName("btnAccept"); // NOI18N

        javax.swing.GroupLayout pnCurScaleDataLayout = new javax.swing.GroupLayout(pnCurScaleData);
        pnCurScaleData.setLayout(pnCurScaleDataLayout);
        pnCurScaleDataLayout.setHorizontalGroup(
            pnCurScaleDataLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnCurScaleDataLayout.createSequentialGroup()
                .addGroup(pnCurScaleDataLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(pnCurScaleDataLayout.createSequentialGroup()
                        .addComponent(rbtBridge1)
                        .addGap(18, 18, 18)
                        .addComponent(rbtBridge2))
                    .addGroup(pnCurScaleDataLayout.createSequentialGroup()
                        .addContainerGap()
                        .addComponent(txfCurScale, javax.swing.GroupLayout.PREFERRED_SIZE, 221, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(4, 4, 4)
                        .addComponent(lblKG)))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pnCurScaleDataLayout.createSequentialGroup()
                .addContainerGap(172, Short.MAX_VALUE)
                .addComponent(btnAccept)
                .addContainerGap())
        );
        pnCurScaleDataLayout.setVerticalGroup(
            pnCurScaleDataLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnCurScaleDataLayout.createSequentialGroup()
                .addGroup(pnCurScaleDataLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(rbtBridge1)
                    .addComponent(rbtBridge2))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnCurScaleDataLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(txfCurScale, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblKG))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(btnAccept)
                .addGap(20, 20, 20))
        );

        pnCurScale.add(pnCurScaleData, java.awt.BorderLayout.CENTER);

        pnScaleData.setBorder(javax.swing.BorderFactory.createTitledBorder(resourceMap.getString("pnScaleData.border.title"))); // NOI18N
        pnScaleData.setFocusable(false);
        pnScaleData.setName("pnScaleData"); // NOI18N

        lblIScale.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        lblIScale.setText(resourceMap.getString("lblIScale.text")); // NOI18N
        lblIScale.setName("lblIScale"); // NOI18N

        lblOScale.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        lblOScale.setText(resourceMap.getString("lblOScale.text")); // NOI18N
        lblOScale.setName("lblOScale"); // NOI18N

        lblGScale.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        lblGScale.setText(resourceMap.getString("lblGScale.text")); // NOI18N
        lblGScale.setName("lblGScale"); // NOI18N

        txfInQty.setBorder(javax.swing.BorderFactory.createEmptyBorder(1, 1, 1, 1));
        txfInQty.setEditable(false);
        txfInQty.setForeground(resourceMap.getColor("txfInQty.foreground")); // NOI18N
        txfInQty.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter()));
        txfInQty.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txfInQty.setText(resourceMap.getString("txfInQty.text")); // NOI18N
        txfInQty.setFont(resourceMap.getFont("txfGoodsQty.font")); // NOI18N
        txfInQty.setName("txfInQty"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${weightTicket.FScale}"), txfInQty, org.jdesktop.beansbinding.BeanProperty.create("value"));
        bindingGroup.addBinding(binding);

        txfOutQty.setBorder(javax.swing.BorderFactory.createEmptyBorder(1, 1, 1, 1));
        txfOutQty.setEditable(false);
        txfOutQty.setForeground(resourceMap.getColor("txfOutQty.foreground")); // NOI18N
        txfOutQty.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter()));
        txfOutQty.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txfOutQty.setText(resourceMap.getString("txfOutQty.text")); // NOI18N
        txfOutQty.setFont(resourceMap.getFont("txfGoodsQty.font")); // NOI18N
        txfOutQty.setName("txfOutQty"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${weightTicket.SScale}"), txfOutQty, org.jdesktop.beansbinding.BeanProperty.create("value"));
        bindingGroup.addBinding(binding);

        txfGoodsQty.setBorder(javax.swing.BorderFactory.createEmptyBorder(1, 1, 1, 1));
        txfGoodsQty.setEditable(false);
        txfGoodsQty.setForeground(resourceMap.getColor("txfGoodsQty.foreground")); // NOI18N
        txfGoodsQty.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter()));
        txfGoodsQty.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txfGoodsQty.setText(resourceMap.getString("txfGoodsQty.text")); // NOI18N
        txfGoodsQty.setFont(resourceMap.getFont("txfGoodsQty.font")); // NOI18N
        txfGoodsQty.setName("txfGoodsQty"); // NOI18N

        lblIUnit.setText(resourceMap.getString("lblIUnit.text")); // NOI18N
        lblIUnit.setName("lblIUnit"); // NOI18N

        lblITime.setText(resourceMap.getString("lblITime.text")); // NOI18N
        lblITime.setName("lblITime"); // NOI18N

        lblOUnit.setText(resourceMap.getString("lblOUnit.text")); // NOI18N
        lblOUnit.setName("lblOUnit"); // NOI18N

        lblOTime.setText(resourceMap.getString("lblOTime.text")); // NOI18N
        lblOTime.setName("lblOTime"); // NOI18N

        lblGUnit.setText(resourceMap.getString("lblGUnit.text")); // NOI18N
        lblGUnit.setName("lblGUnit"); // NOI18N

        txtInTime.setBackground(resourceMap.getColor("txtInTime.background")); // NOI18N
        txtInTime.setFont(txtInTime.getFont().deriveFont(txtInTime.getFont().getStyle() | java.awt.Font.BOLD, txtInTime.getFont().getSize()+1));
        txtInTime.setForeground(resourceMap.getColor("txtInTime.foreground")); // NOI18N
        txtInTime.setText(resourceMap.getString("txtInTime.text")); // NOI18N
        txtInTime.setBorder(javax.swing.BorderFactory.createEmptyBorder(1, 1, 1, 1));
        txtInTime.setName("txtInTime"); // NOI18N

        txtOutTime.setBackground(resourceMap.getColor("txtOutTime.background")); // NOI18N
        txtOutTime.setFont(txtOutTime.getFont().deriveFont(txtOutTime.getFont().getStyle() | java.awt.Font.BOLD, txtOutTime.getFont().getSize()+1));
        txtOutTime.setForeground(resourceMap.getColor("txtInTime.foreground")); // NOI18N
        txtOutTime.setText(resourceMap.getString("txtOutTime.text")); // NOI18N
        txtOutTime.setBorder(javax.swing.BorderFactory.createEmptyBorder(1, 1, 1, 1));
        txtOutTime.setName("txtOutTime"); // NOI18N

        btnIScaleReset.setText(resourceMap.getString("btnIScaleReset.text")); // NOI18N
        btnIScaleReset.setFocusable(false);
        btnIScaleReset.setName("btnIScaleReset"); // NOI18N
        btnIScaleReset.setPreferredSize(new java.awt.Dimension(61, 21));

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${stage1}"), btnIScaleReset, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        btnIScaleReset.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnIScaleResetActionPerformed(evt);
            }
        });

        btnOScaleReset.setText(resourceMap.getString("btnOScaleReset.text")); // NOI18N
        btnOScaleReset.setFocusable(false);
        btnOScaleReset.setName("btnOScaleReset"); // NOI18N
        btnOScaleReset.setPreferredSize(new java.awt.Dimension(61, 21));

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${stage2}"), btnOScaleReset, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        btnOScaleReset.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnOScaleResetActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout pnScaleDataLayout = new javax.swing.GroupLayout(pnScaleData);
        pnScaleData.setLayout(pnScaleDataLayout);
        pnScaleDataLayout.setHorizontalGroup(
            pnScaleDataLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnScaleDataLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pnScaleDataLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(lblGScale)
                    .addComponent(lblOScale, javax.swing.GroupLayout.PREFERRED_SIZE, 43, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblIScale, javax.swing.GroupLayout.PREFERRED_SIZE, 43, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnScaleDataLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(txfGoodsQty, javax.swing.GroupLayout.DEFAULT_SIZE, 199, Short.MAX_VALUE)
                    .addComponent(txfOutQty, javax.swing.GroupLayout.DEFAULT_SIZE, 199, Short.MAX_VALUE)
                    .addComponent(txfInQty, javax.swing.GroupLayout.DEFAULT_SIZE, 199, Short.MAX_VALUE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnScaleDataLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(pnScaleDataLayout.createSequentialGroup()
                        .addGroup(pnScaleDataLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                            .addComponent(lblIUnit)
                            .addComponent(lblOUnit))
                        .addGap(18, 18, 18)
                        .addGroup(pnScaleDataLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                            .addComponent(lblITime)
                            .addComponent(lblOTime))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(pnScaleDataLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(txtOutTime, javax.swing.GroupLayout.DEFAULT_SIZE, 204, Short.MAX_VALUE)
                            .addComponent(txtInTime, javax.swing.GroupLayout.DEFAULT_SIZE, 204, Short.MAX_VALUE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(pnScaleDataLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                            .addComponent(btnIScaleReset, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(btnOScaleReset, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
                    .addComponent(lblGUnit))
                .addContainerGap())
        );
        pnScaleDataLayout.setVerticalGroup(
            pnScaleDataLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnScaleDataLayout.createSequentialGroup()
                .addGroup(pnScaleDataLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblIScale)
                    .addComponent(txfInQty, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txtInTime, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblITime)
                    .addComponent(lblIUnit)
                    .addComponent(btnIScaleReset, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnScaleDataLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblOScale, javax.swing.GroupLayout.PREFERRED_SIZE, 14, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txfOutQty, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txtOutTime, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblOTime, javax.swing.GroupLayout.PREFERRED_SIZE, 18, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblOUnit, javax.swing.GroupLayout.PREFERRED_SIZE, 14, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(btnOScaleReset, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnScaleDataLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblGScale)
                    .addComponent(txfGoodsQty, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblGUnit))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        pnWTicket.setBorder(javax.swing.BorderFactory.createTitledBorder(resourceMap.getString("pnWTicket.border.title"))); // NOI18N
        pnWTicket.setName("pnWTicket"); // NOI18N

        lblDName.setText(resourceMap.getString("lblDName.text")); // NOI18N
        lblDName.setName("lblDName"); // NOI18N

        txtDName.setEditable(false);
        txtDName.setName("txtDName"); // NOI18N

        lblCMNDBL.setText(resourceMap.getString("lblCMNDBL.text")); // NOI18N
        lblCMNDBL.setName("lblCMNDBL"); // NOI18N

        txtCMNDBL.setEditable(false);
        txtCMNDBL.setName("txtCMNDBL"); // NOI18N

        lblLicPlate.setText(resourceMap.getString("lblLicPlate.text")); // NOI18N
        lblLicPlate.setName("lblLicPlate"); // NOI18N

        txtLicPlate.setEditable(false);
        txtLicPlate.setName("txtLicPlate"); // NOI18N

        lblTrailerPlate.setText(resourceMap.getString("lblTrailerPlate.text")); // NOI18N
        lblTrailerPlate.setName("lblTrailerPlate"); // NOI18N

        txtTrailerPlate.setEditable(false);
        txtTrailerPlate.setName("txtTrailerPlate"); // NOI18N

        lblRegCat.setText(resourceMap.getString("lblRegCat.text")); // NOI18N
        lblRegCat.setName("lblRegCat"); // NOI18N

        grbCat.add(rbtInward);
        rbtInward.setText(resourceMap.getString("rbtInward.text")); // NOI18N
        rbtInward.setEnabled(false);
        rbtInward.setName("rbtInward"); // NOI18N

        grbCat.add(rbtOutward);
        rbtOutward.setText(resourceMap.getString("rbtOutward.text")); // NOI18N
        rbtOutward.setEnabled(false);
        rbtOutward.setName("rbtOutward"); // NOI18N

        lblRegItem.setText(resourceMap.getString("lblRegItem.text")); // NOI18N
        lblRegItem.setName("lblRegItem"); // NOI18N

        txtRegItem.setEditable(false);
        txtRegItem.setName("txtRegItem"); // NOI18N

        lblMatnr.setText(resourceMap.getString("lblMatnr.text")); // NOI18N
        lblMatnr.setName("lblMatnr"); // NOI18N

        lblDelNum.setText(resourceMap.getString("lblDelNum.text")); // NOI18N
        lblDelNum.setName("lblDelNum"); // NOI18N

        txtDelNum.setEditable(false);
        txtDelNum.setName("txtDelNum"); // NOI18N

        lblSLoc.setText(resourceMap.getString("lblSLoc.text")); // NOI18N
        lblSLoc.setName("lblSLoc"); // NOI18N

        cbxSLoc.setModel(SAP2Local.getSlocModel(config, entityManager));
        cbxSLoc.setRenderer(new DefaultListCellRenderer() {
            @Override
            public Component getListCellRendererComponent(
                JList list, Object value, int index, boolean isSelected, boolean cellHasFocus) {
                super.getListCellRendererComponent(list, value, index, isSelected, cellHasFocus);
                if (value instanceof SLoc) {
                    SLoc sloc = (SLoc)value;
                    setText(sloc.getLgobe());
                }
                return this;
            }
        });
        cbxSLoc.setName("cbxSLoc"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${formEnable}"), cbxSLoc, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        cbxSLoc.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                cbxSLocItemStateChanged(evt);
            }
        });

        lblBatch.setText(resourceMap.getString("lblBatch.text")); // NOI18N
        lblBatch.setName("lblBatch"); // NOI18N

        cbxBatch.setAction(actionMap.get("acceptBatch")); // NOI18N
        cbxBatch.setName("cbxBatch"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${formEnable}"), cbxBatch, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        cbxBatch.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                cbxBatchKeyReleased(evt);
            }
        });

        lblReason.setText(resourceMap.getString("lblReason.text")); // NOI18N
        lblReason.setName("lblReason"); // NOI18N

        cbxReason.setModel(getReasonModel());
        cbxReason.setRenderer(new DefaultListCellRenderer() {
            @Override
            public Component getListCellRendererComponent(
                JList list, Object value, int index, boolean isSelected, boolean cellHasFocus) {
                super.getListCellRendererComponent(list, value, index, isSelected, cellHasFocus);
                if (value instanceof Reason) {
                    Reason r = (Reason)value;
                    setText(r.getGrtxt());
                }
                return this;
            }
        });
        cbxReason.setEnabled(false);
        cbxReason.setName("cbxReason"); // NOI18N
        cbxReason.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                cbxReasonItemStateChanged(evt);
            }
        });

        lblCementDesc.setText(resourceMap.getString("lblCementDesc.text")); // NOI18N
        lblCementDesc.setName("lblCementDesc"); // NOI18N

        txtCementDesc.setText(resourceMap.getString("txtCementDesc.text")); // NOI18N
        txtCementDesc.setName("txtCementDesc"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${formEnable}"), txtCementDesc, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        lblGRText.setText(resourceMap.getString("lblGRText.text")); // NOI18N
        lblGRText.setName("lblGRText"); // NOI18N

        txtGRText.setEnabled(false);
        txtGRText.setName("txtGRText"); // NOI18N
        txtGRText.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txtGRTextKeyReleased(evt);
            }
        });

        lblComplete.setText(resourceMap.getString("lblComplete.text")); // NOI18N
        lblComplete.setName("lblComplete"); // NOI18N

        cbxCompleted.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Auto", "Set", "NotSet" }));
        cbxCompleted.setEnabled(false);
        cbxCompleted.setName("cbxCompleted"); // NOI18N
        cbxCompleted.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                cbxCompletedItemStateChanged(evt);
            }
        });

        chkDissolved.setText(resourceMap.getString("chkDissolved.text")); // NOI18N
        chkDissolved.setName("chkDissolved"); // NOI18N
        chkDissolved.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                chkDissolvedItemStateChanged(evt);
            }
        });

        txtMatnr.setEditable(false);
        txtMatnr.setText(resourceMap.getString("txtMatnr.text")); // NOI18N
        txtMatnr.setName("txtMatnr"); // NOI18N

        javax.swing.GroupLayout pnWTicketLayout = new javax.swing.GroupLayout(pnWTicket);
        pnWTicket.setLayout(pnWTicketLayout);
        pnWTicketLayout.setHorizontalGroup(
            pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnWTicketLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pnWTicketLayout.createSequentialGroup()
                        .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                            .addComponent(lblGRText)
                            .addComponent(lblSLoc)
                            .addComponent(lblTrailerPlate)
                            .addComponent(lblLicPlate)
                            .addComponent(lblCMNDBL)
                            .addComponent(lblDName)
                            .addComponent(lblReason))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(cbxReason, 0, 199, Short.MAX_VALUE)
                            .addComponent(txtGRText, javax.swing.GroupLayout.DEFAULT_SIZE, 199, Short.MAX_VALUE)
                            .addComponent(cbxSLoc, javax.swing.GroupLayout.Alignment.TRAILING, 0, 199, Short.MAX_VALUE)
                            .addComponent(txtLicPlate, javax.swing.GroupLayout.DEFAULT_SIZE, 199, Short.MAX_VALUE)
                            .addComponent(txtCMNDBL, javax.swing.GroupLayout.DEFAULT_SIZE, 199, Short.MAX_VALUE)
                            .addComponent(txtDName, javax.swing.GroupLayout.DEFAULT_SIZE, 199, Short.MAX_VALUE)
                            .addComponent(txtTrailerPlate, javax.swing.GroupLayout.DEFAULT_SIZE, 199, Short.MAX_VALUE))
                        .addGap(49, 49, 49)
                        .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                            .addComponent(lblRegItem)
                            .addComponent(lblRegCat)
                            .addComponent(lblMatnr)
                            .addComponent(lblDelNum)
                            .addComponent(lblBatch)
                            .addComponent(lblCementDesc)
                            .addComponent(lblComplete))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(pnWTicketLayout.createSequentialGroup()
                                .addComponent(rbtInward)
                                .addGap(18, 18, 18)
                                .addComponent(rbtOutward))
                            .addComponent(txtRegItem, javax.swing.GroupLayout.DEFAULT_SIZE, 199, Short.MAX_VALUE)
                            .addComponent(txtDelNum, javax.swing.GroupLayout.DEFAULT_SIZE, 199, Short.MAX_VALUE)
                            .addComponent(cbxBatch, 0, 199, Short.MAX_VALUE)
                            .addComponent(txtCementDesc, javax.swing.GroupLayout.DEFAULT_SIZE, 199, Short.MAX_VALUE)
                            .addComponent(cbxCompleted, 0, 199, Short.MAX_VALUE)
                            .addComponent(txtMatnr, javax.swing.GroupLayout.DEFAULT_SIZE, 199, Short.MAX_VALUE)))
                    .addComponent(chkDissolved, javax.swing.GroupLayout.Alignment.TRAILING))
                .addContainerGap())
        );
        pnWTicketLayout.setVerticalGroup(
            pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnWTicketLayout.createSequentialGroup()
                .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblDName)
                    .addComponent(txtDName, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblRegCat)
                    .addComponent(rbtInward)
                    .addComponent(rbtOutward))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(pnWTicketLayout.createSequentialGroup()
                        .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(lblCMNDBL)
                            .addComponent(txtCMNDBL, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(lblLicPlate)
                            .addComponent(txtLicPlate, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(lblTrailerPlate)
                            .addComponent(txtTrailerPlate, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
                    .addGroup(pnWTicketLayout.createSequentialGroup()
                        .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(lblRegItem)
                            .addComponent(txtRegItem, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(lblMatnr)
                            .addComponent(txtMatnr, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(lblDelNum)
                            .addComponent(txtDelNum, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(lblSLoc)
                        .addComponent(cbxSLoc, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(lblBatch)
                        .addComponent(cbxBatch, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(lblCementDesc)
                        .addComponent(txtCementDesc, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(lblReason)
                        .addComponent(cbxReason, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(lblGRText)
                        .addComponent(txtGRText, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(lblComplete)
                        .addComponent(cbxCompleted, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addComponent(chkDissolved))
        );

        btnSave.setAction(actionMap.get("saveWT")); // NOI18N
        btnSave.setFont(resourceMap.getFont("btnSave.font")); // NOI18N
        btnSave.setText(resourceMap.getString("btnSave.text")); // NOI18N
        btnSave.setName("btnSave"); // NOI18N

        btnReprint.setAction(actionMap.get("reprintWT")); // NOI18N
        btnReprint.setText(resourceMap.getString("btnReprint.text")); // NOI18N
        btnReprint.setName("btnReprint"); // NOI18N

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addComponent(pnWTFilter, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(pnCurScale, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addComponent(btnReprint)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(btnSave, javax.swing.GroupLayout.PREFERRED_SIZE, 73, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addComponent(pnScaleData, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(pnWTicket, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(pnWTFilter, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(pnCurScale, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(pnScaleData, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(pnWTicket, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnSave)
                    .addComponent(btnReprint))
                .addContainerGap(39, Short.MAX_VALUE))
        );

        bindingGroup.bind();

        pack();
    }// </editor-fold>//GEN-END:initComponents

    // <editor-fold defaultstate="expanded" desc="Event Handlers Area">
    private void rbtBridge1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_rbtBridge1ActionPerformed
        config = WeighBridgeApp.getApplication().getConfig();
        try {
            btnAccept.setEnabled(WeighBridgeApp.getApplication().connectWB(
                    config.getB1Port(),
                    config.getB1Speed(),
                    config.getB1DBits(),
                    config.getB1SBits().shortValue(),
                    config.getB1PC(),
                    config.getB1Mettler(),
                    txfCurScale));
            setSaveNeeded(isValidated());
        } catch (Exception ex) {
            JOptionPane.showMessageDialog(WeighBridgeApp.getApplication().getMainFrame(), "Exception weighing!!!");
        }

    }//GEN-LAST:event_rbtBridge1ActionPerformed

    private void rbtBridge2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_rbtBridge2ActionPerformed
        config = WeighBridgeApp.getApplication().getConfig();
        try {
            btnAccept.setEnabled(WeighBridgeApp.getApplication().connectWB(
                    config.getB2Port(),
                    config.getB2Speed(),
                    config.getB2DBits(),
                    config.getB2SBits().shortValue(),
                    config.getB2PC(),
                    config.getB2Mettler(),
                    txfCurScale));
            setSaveNeeded(isValidated());
        } catch (Exception ex) {
        }
    }//GEN-LAST:event_rbtBridge2ActionPerformed

    private void btnIScaleResetActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnIScaleResetActionPerformed
        txfInQty.setValue(null);
        txtInTime.setText(null);
        txfGoodsQty.setValue(null);
        //  Temporary enable Accept Button
//        btnAccept.setEnabled(true);
        grbBridge.clearSelection();
        setSaveNeeded(isValidated());
    }//GEN-LAST:event_btnIScaleResetActionPerformed

    private void btnOScaleResetActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnOScaleResetActionPerformed
        txfOutQty.setValue(null);
        txtOutTime.setText(null);
        txfGoodsQty.setValue(null);
        //  Temporary enable Accept Button
//        btnAccept.setEnabled(true);
        grbBridge.clearSelection();
        setSaveNeeded(isValidated());
    }//GEN-LAST:event_btnOScaleResetActionPerformed

    private void cbxSLocItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_cbxSLocItemStateChanged
        if (cbxSLoc.getSelectedIndex() == -1) {
            return;
        }
        config = WeighBridgeApp.getApplication().getConfig();
        SLoc selSloc = (SLoc) cbxSLoc.getSelectedItem();
        weightTicket.setLgort(selSloc.getSLocPK().getLgort());
        if (selSloc != null && (txtMatnr.getText() != null && !txtMatnr.getText().trim().isEmpty())) {
            lblSLoc.setForeground(Color.black);
            TypedQuery<BatchStocks> tBatchQ = entityManager.createQuery("SELECT b FROM BatchStocks b WHERE b.batchStocksPK.mandt = :mandt AND b.batchStocksPK.werks = :werks AND b.batchStocksPK.lgort = :lgort  AND b.batchStocksPK.matnr = :matnr", BatchStocks.class);
            tBatchQ.setParameter("mandt", config.getsClient());
            tBatchQ.setParameter("werks", config.getwPlant());
            tBatchQ.setParameter("lgort", selSloc.getSLocPK().getLgort());
            tBatchQ.setParameter("matnr", txtMatnr.getText());
            List<BatchStocks> batchs = tBatchQ.getResultList();
            List<BatchStocksStructure> bBatchStocks = SAP2Local.getBatchStocks(selSloc.getSLocPK().getLgort(), weightTicket.getMatnrRef());
            entityManager.getTransaction().begin();
            for (BatchStocksStructure b : bBatchStocks) {
                BatchStocks bs = new BatchStocks(new BatchStocksPK(config.getsClient(), config.getwPlant(), b.getLgort(), b.getMatnr(), b.getCharg()));
                bs.setLvorm(b.getLvorm() == null || b.getLvorm().trim().isEmpty() ? ' ' : b.getLvorm().charAt(0));
                if (batchs.indexOf(bs) == -1) {
                    entityManager.persist(bs);
                } else {
                    entityManager.merge(bs);
                }
                if (batchs.indexOf(bs) == -1 && b.getLgort().equalsIgnoreCase(weightTicket.getLgort())) {
                    batchs.add(bs);
                }
            }
            entityManager.getTransaction().commit();
            entityManager.clear();

            DefaultComboBoxModel result = new DefaultComboBoxModel();
            for (BatchStocks b : batchs) {
                if (b.getLvorm() == null || b.getLvorm().toString().trim().isEmpty()) {
                    result.addElement(b.getBatchStocksPK().getCharg());
                }
            }
            cbxBatch.setModel(result);
            cbxBatch.setSelectedIndex(-1);
        }
        setSaveNeeded(isValidated());
    }//GEN-LAST:event_cbxSLocItemStateChanged

    private void cbxReasonItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_cbxReasonItemStateChanged
        if (cbxReason.getSelectedIndex() == -1) {
            return;
        }
        Reason r = (Reason) cbxReason.getSelectedItem();
        weightTicket.setMoveReas(r.getReasonPK().getGrund());
        setSaveNeeded(isValidated());
    }//GEN-LAST:event_cbxReasonItemStateChanged

    private void txtGRTextKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txtGRTextKeyReleased
        if (weightTicket != null) {
            weightTicket.setText(txtGRText.getText());
        }
        setSaveNeeded(isValidated());
    }//GEN-LAST:event_txtGRTextKeyReleased

    private void cbxCompletedItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_cbxCompletedItemStateChanged
        if (weightTicket != null) {
            if (cbxCompleted.getSelectedIndex() == 1) {
                weightTicket.setNoMoreGr('2');
            } else {
                weightTicket.setNoMoreGr(' ');
            }
        }
        setSaveNeeded(isValidated());
    }//GEN-LAST:event_cbxCompletedItemStateChanged

    private void rbtMiscItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_rbtMiscItemStateChanged
        if (!rbtMisc.isSelected()) {
            if (weightTicket != null && (weightTicket.getRegItemText() != null && !weightTicket.getRegItemText().trim().isEmpty())) {
                txtRegItem.setText(weightTicket.getRegItemText());
            } else if (purOrder != null) {
                txtRegItem.setText(purOrder.getShortText());
            }
        }
    }//GEN-LAST:event_rbtMiscItemStateChanged

    private void chkDissolvedItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_chkDissolvedItemStateChanged
        weightTicket.setDissolved(chkDissolved.isSelected());
        setSaveNeeded(isValidated());
    }//GEN-LAST:event_chkDissolvedItemStateChanged

    private void rbtPOItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_rbtPOItemStateChanged
//        if (rbtPO.isEnabled() && rbtMisc.isEnabled() && rbtMb1b.isEnabled() && grbType.getSelection() != null) {
//            rbtPO.setForeground(Color.black);
//            rbtMisc.setForeground(Color.black);
//            rbtMb1b.setForeground(Color.black);
//        }
//        setSaveNeeded(isValidated());
    }//GEN-LAST:event_rbtPOItemStateChanged

    private void cbxBatchKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_cbxBatchKeyReleased
        setSaveNeeded(isValidated());
    }//GEN-LAST:event_cbxBatchKeyReleased

    private void rbtMb1bItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_rbtMb1bItemStateChanged
        if (!rbtMb1b.isSelected()) {
            grbType.clearSelection();
            if (weightTicket == null) {
                return;
            }
            weightTicket.setRecvLgort(null);
            weightTicket.setRecvPlant(null);
            weightTicket.setRecvCharg(null);
            weightTicket.setRecvPo(null);
            weightTicket.setRecvMatnr(null);
            weightTicket.setMatnrRef(null);
//            weightTicket.setRegItemText(null);
            weightTicket.setUnit(null);
            weightTicket.setMoveType(null);
            weightTicket.setMoveReas(null);
        }
    }//GEN-LAST:event_rbtMb1bItemStateChanged

    private void rbtMvt311ItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_rbtMvt311ItemStateChanged
        if (!rbtMvt311.isSelected()) {
            grbType.clearSelection();
            if (weightTicket == null) {
                return;
            }
            weightTicket.setRecvLgort(null);
            weightTicket.setRecvPlant(null);
            weightTicket.setRecvCharg(null);
            weightTicket.setRecvMatnr(null);
            weightTicket.setMatnrRef(null);
//            weightTicket.setRegItemText(null);
            weightTicket.setUnit(null);
            weightTicket.setMoveType(null);
            weightTicket.setMoveReas(null);
        }
    }//GEN-LAST:event_rbtMvt311ItemStateChanged

    @Action
    public void showMB1BOption() {
        if (weightTicket == null) {
            return;
        }
        if (rbtMb1b.isSelected() && rbtInward.isSelected()) {
            grbType.clearSelection();
            return;
        }
        if (rbtMb1b.isSelected() && weightTicket.getRegCategory() == 'O') {
            RecvSlocView rsview = new RecvSlocView(WeighBridgeApp.getApplication().getMainFrame(), weightTicket.getRecvLgort(), weightTicket.getRecvPo());
            rsview.setLocationRelativeTo(WeighBridgeApp.getApplication().getMainFrame());
            WeighBridgeApp.getApplication().show(rsview);
            if (!rsview.isShowing()) {
                if (rsview.getRecSloc() != null) {
                    weightTicket.setRecvLgort(rsview.getRecSloc().getSLocPK().getLgort());
                } else {
                    weightTicket.setRecvLgort(null);
                }
                if (rsview.getRefPO() != null) {
                    weightTicket.setRecvPo(rsview.getRefPO());
                } else {
                    weightTicket.setRecvPo(null);
                }
                weightTicket.setRecvPlant(config.getwPlant());
                weightTicket.setRecvCharg(weightTicket.getCharg());
                weightTicket.setRecvMatnr(setting.getMatnrClinker());
                weightTicket.setMatnrRef(setting.getMatnrClinker());
                weightTicket.setRegItemText("Clinker gia cng");
                weightTicket.setUnit("TO");
                weightTicket.setMoveType("313");
                weightTicket.setMoveReas("0003");
                rsview.dispose();
                rsview = null;
                txtRegItem.setText(weightTicket.getRegItemText());
            }
        }
        txtMatnr.setText(weightTicket.getRecvMatnr());
        if (rbtPO.isEnabled() && rbtMisc.isEnabled() && rbtMb1b.isEnabled() && rbtMvt311.isEnabled()
                && grbType.getSelection() != null) {
            rbtPO.setForeground(Color.black);
            rbtMisc.setForeground(Color.black);
            rbtMb1b.setForeground(Color.black);
            rbtMvt311.setForeground(Color.black);
        }
        setSaveNeeded(isValidated());
    }

    @Action
    public void selectRbtMvt311() {
        if (weightTicket == null) {
            return;
        }
        if (rbtMvt311.isSelected() && rbtInward.isSelected()) {
            grbType.clearSelection();
            return;
        }
        txtRegItem.setText(weightTicket.getRegItemText());
        if (rbtMvt311.isSelected() && weightTicket.getRegCategory() == 'O') {
            Mvt311View mvt311View = new Mvt311View(WeighBridgeApp.getApplication().getMainFrame(), weightTicket.getRecvLgort(), null);
            mvt311View.setLocationRelativeTo(WeighBridgeApp.getApplication().getMainFrame());
            WeighBridgeApp.getApplication().show(mvt311View);
            if (!mvt311View.isShowing()) {
                if (mvt311View.getRecSloc() != null) {
                    weightTicket.setRecvLgort(mvt311View.getRecSloc().getSLocPK().getLgort());
                } else {
                    weightTicket.setRecvLgort(null);
                }
                if (mvt311View.getSelMaterial() != null) {
                    material = mvt311View.getSelMaterial();
                    weightTicket.setRecvMatnr(material.getMaterialPK().getMatnr());
                    weightTicket.setMatnrRef(material.getMaterialPK().getMatnr());
                    weightTicket.setRegItemText(material.getMaktx());
                } else {
                    material = null;
                    weightTicket.setRecvMatnr(null);
                    weightTicket.setMatnrRef(null);
//                    weightTicket.setRegItemText(null);
                }
                weightTicket.setRecvPlant(config.getwPlant());
                weightTicket.setRecvCharg(weightTicket.getCharg());
                weightTicket.setUnit("TO");
                weightTicket.setMoveType("311");
                weightTicket.setMoveReas(null);
                mvt311View.dispose();
                mvt311View = null;
                txtRegItem.setText(weightTicket.getRegItemText());
            }
        }
        txtMatnr.setText(weightTicket.getRecvMatnr());
        if (rbtPO.isEnabled() && rbtMisc.isEnabled() && rbtMb1b.isEnabled() && rbtMvt311.isEnabled()
                && grbType.getSelection() != null) {
            rbtPO.setForeground(Color.black);
            rbtMisc.setForeground(Color.black);
            rbtMb1b.setForeground(Color.black);
            rbtMvt311.setForeground(Color.black);
        }
        setSaveNeeded(isValidated());
    }

    @Action
    public void selectRbtPO() {
        if (rbtPO.isEnabled() && rbtMisc.isEnabled() && rbtMb1b.isEnabled() && rbtMvt311.isEnabled()
                && grbType.getSelection() != null) {
            rbtPO.setForeground(Color.black);
            rbtMisc.setForeground(Color.black);
            rbtMb1b.setForeground(Color.black);
            rbtMvt311.setForeground(Color.black);
        }
        setSaveNeeded(isValidated());
    }

    @Action
    public void selectRbtMisc() {
        if (rbtMisc.isSelected()) {
            txtRegItem.setText(weightTicket.getRegItemText());
            weightTicket.setEbeln(null);
            weightTicket.setItem(null);
            weightTicket.setRecvLgort(null);
            weightTicket.setRecvPlant(null);
            weightTicket.setRecvCharg(null);
            weightTicket.setRecvPo(null);
            weightTicket.setRecvMatnr(null);
            weightTicket.setMatnrRef(null);
            weightTicket.setUnit(null);
        }
        if (rbtPO.isEnabled() && rbtMisc.isEnabled() && rbtMb1b.isEnabled() && rbtMvt311.isEnabled()
                && grbType.getSelection() != null) {
            rbtPO.setForeground(Color.black);
            rbtMisc.setForeground(Color.black);
            rbtMb1b.setForeground(Color.black);
            rbtMvt311.setForeground(Color.black);
        }
        setSaveNeeded(isValidated());
    }

    @Action(block = Task.BlockingScope.ACTION)
    public Task acceptScale() {
        if (weightTicket == null || txfCurScale.getValue() == null || ((Number) txfCurScale.getValue()).intValue() == 0) {
            return null;
        }
        if (!rbtMisc.isSelected() && weightTicket.getMatnrRef() == null) {
            return null;
        }
        if (!isStage1() && !isStage2()) {
            return null;
        }
        return new AcceptScaleTask(WeighBridgeApp.getApplication());
    }

    @Action(block = Task.BlockingScope.ACTION)
    public Task readWT() {
        String txt = txtWTNum.getText();
        if (isEnteredValidWTNum()) {
            String sID = txt.substring(0, 10);
            String sSeq = txt.substring(10);
            clearForm();
            return new ReadWTTask(WeighBridgeApp.getApplication(), sID, sSeq);
        } else {
            clearForm();
            return null;
        }
    }

    @Action(block = Task.BlockingScope.ACTION)
    public Task readPO() {
        if (isEnteredValidPONum()) {
            return new ReadPOTask(WeighBridgeApp.getApplication(), txtPONum.getText().trim());
        } else {
            return null;
        }
    }

    @Action
    public Task acceptBatch() {
        if ((cbxBatch.getSelectedIndex() == -1 && !cbxBatch.isEditable()) || (cbxBatch.isEditable() && cbxBatch.getEditor().getItem().toString().trim().isEmpty())) {
            setSaveNeeded(isValidated());
            return null;
        }
        return new AcceptBatchTask(WeighBridgeApp.getApplication());
    }

    @Action(block = Task.BlockingScope.ACTION, enabledProperty = "reprintable")
    public Task reprintWT() {
        if (weightTicket == null) {
            return null;
        } else {
            //if (weightTicket.getDissolved() == null)
                //    {
                  //      weightTicket.setDissolved(false);
                  //  }
            if ((weightTicket.getDissolved() == null) || (weightTicket.getDissolved() == false )){ //+20100112#01 Phieu bi huy khong dc in lai
            return new ReprintWTTask(WeighBridgeApp.getApplication());
            }else{ //+20100112#01 Phieu bi huy khong dc in lai
                JOptionPane.showMessageDialog(WeighBridgeApp.getApplication().getMainFrame(), "Phiu cn  b hy!");
                return null;
            } //+20100112#01 Phieu bi huy khong dc in lai
        }
    }

    @Action(enabledProperty = "saveNeeded")
    public Task saveWT() {
        //{+20101203#01 Cheat code, adjust date to posting - be deleted
       //weightTicket.setSScale(new BigDecimal(((Number) txfOutQty.getValue()).doubleValue()));
       // Date now = Calendar.getInstance().getTime();
       // final long ONE_DAY_MILLISCONDS = now.getTime() - (long) 25 * 60 * 60 * 1000 * 30;
       // Date lastMonth = new Date( ONE_DAY_MILLISCONDS );
       // weightTicket.setSTime(lastMonth);
        //}+20101203#01
        if (isValidated()) {
            if (outbDel != null
                    && outbDel.getMatnr().equalsIgnoreCase(setting.getMatnrPcb40())
                    && rbtOutward.isSelected() && isStage2()) {
                //{+20101202#02 check material availability
                //setMessage("ang kim tra tn kho trong SAP...");
                    //Double result = (Double) txfGoodsQty.getValue();
                    //Double remaining = CheckMatStock(weightTicket.getMatnrRef(), config.getwPlant(), weightTicket.getLgort(), "");
                    Double result = (double) 1;
                    Double remaining = (double) 0;

                    if ( result != null && remaining != null ){
                    if (result > remaining) {
                //}+20101202#02 check material availability
                        //JOptionPane.showMessageDialog(WeighBridgeApp.getApplication().getMainFrame(), "Khng  tn kho XM PCB40!!!");
                        ProcOrdView procoView = new ProcOrdView(WeighBridgeApp.getApplication().getMainFrame(), weightTicket.getPpProcord());
                        procoView.setLocationRelativeTo(WeighBridgeApp.getApplication().getMainFrame());
                        WeighBridgeApp.getApplication().show(procoView);
                        if (!procoView.isShowing()) {
                            if (procoView.getProcOrd() != null) {
                                weightTicket.setPpProcord(procoView.getProcOrd());
                            } else {
                                weightTicket.setPpProcord(null);
                            }
                            procoView.dispose();
                            procoView = null;
                            if (weightTicket.getPpProcord() == null) {
                                JOptionPane.showMessageDialog(WeighBridgeApp.getApplication().getMainFrame(), "Cn nhp Process Order  thc hin thao tc xut XM PCB40 !!!");
                                return null;
                            }
                        }
                //{+20101202#02 check material availability
                    } }
                //}+20101202#02 check material availability
            }
            return new SaveWTTask(WeighBridgeApp.getApplication());
        } else {
            return null;
        }
    }

    private void checkWTNum(DocumentEvent e) {
        try {
            String text = e.getDocument().getText(0, e.getDocument().getLength()).trim();
            boolean valid = text.matches("\\d{13}");
            setEnteredValidWTNum(valid);
            if (valid) {
                lblWTNum.setForeground(Color.BLACK);
            } else {
                lblWTNum.setForeground(Color.RED);
            }
        } catch (BadLocationException ex) {
        } finally {
        }
    }

    private void checkPONum(DocumentEvent e) {
        try {
            String text = e.getDocument().getText(0, e.getDocument().getLength()).trim();
            boolean valid = text.matches("\\d{10}");
            setEnteredValidPONum(valid);
            setValidPONum(false);
            if (valid || text.length() == 0) {
                rbtPO.setForeground(Color.BLACK);
            } else {
                rbtPO.setForeground(Color.RED);
            }
        } catch (BadLocationException ex) {
        } finally {
        }
    }
    // </editor-fold>
    // <editor-fold defaultstate="collapsed" desc="Form's properties">
    private boolean stage1 = false;
    public static final String PROP_STAGE1 = "stage1";
    private boolean stage2 = false;
    public static final String PROP_STAGE2 = "stage2";
    private boolean saveNeeded = false;
    public static final String PROP_SAVENEEDED = "saveNeeded";
    private boolean bridge1 = false;
    public static final String PROP_BRIDGE1 = "bridge1";
    private boolean bridge2 = false;
    public static final String PROP_BRIDGE2 = "bridge2";
    private boolean validPONum = false;
    public static final String PROP_VALIDPONUM = "validPONum";
    private boolean dissolved = false;
    public static final String PROP_DISSOLVED = "dissolved";
    private boolean reprintable = false;
    public static final String PROP_REPRINTABLE = "reprintable";
    private boolean enteredValidPONum = false;
    public static final String PROP_ENTEREDVALIDPONUM = "enteredValidPONum";
    private boolean enteredValidWTNum = false;
    public static final String PROP_ENTEREDVALIDWTNUM = "enteredValidWTNum";
    private boolean withoutDO = false;
    public static final String PROP_WITHOUTDO = "withoutDO";
    private boolean formEnable = false;
    public static final String PROP_FORMENABLE = "formEnable";
    private boolean subContract = false;
    public static final String PROP_SUBCONTRACT = "subContract";
    private boolean materialAvailable = false;
    public static final String PROP_MATERIALAVAILABLE = "materialAvailable";
    private Double matAvailStocks = null;
    public static final String PROP_MATAVAILSTOCKS = "matAvailStocks";
    private boolean mvt311 = false;
    public static final String PROP_MVT311 = "mvt311";

    /**
     * Get the value of stage2
     *
     * @return the value of stage2
     */
    public boolean isStage2() {
        return stage2;
    }

    /**
     * Get the value of stage1
     *
     * @return the value of stage1
     */
    public boolean isStage1() {
        return stage1;
    }

    public boolean isSaveNeeded() {
        return saveNeeded;
    }

    /**
     * Get the value of bridge1
     *
     * @return the value of bridge1
     */
    public boolean isBridge1() {
        return bridge1;
    }

    /**
     * Get the value of bridge2
     *
     * @return the value of bridge2
     */
    public boolean isBridge2() {
        return bridge2;
    }

    /**
     * Get the value of enteredValidWTNum
     *
     * @return the value of enteredValidWTNum
     */
    public boolean isEnteredValidWTNum() {
        return enteredValidWTNum;
    }

    /**
     * Get the value of validPONum
     *
     * @return the value of validPONum
     */
    public boolean isValidPONum() {
        return validPONum;
    }

    /**
     * Get the value of enteredValidPONum
     *
     * @return the value of enteredValidPONum
     */
    public boolean isEnteredValidPONum() {
        return enteredValidPONum;
    }

    /**
     * Get the value of withoutDO
     *
     * @return the value of withoutDO
     */
    public boolean isWithoutDO() {
        return withoutDO;
    }

    /**
     * Get the value of dissolved
     *
     * @return the value of dissolved
     */
    public boolean isDissolved() {
        return dissolved;
    }

    public boolean isReprintable() {
        return reprintable;
    }

    public boolean isFormEnable() {
        return formEnable;
    }

    public boolean isSubContract() {
        return subContract;
    }

    public boolean isMaterialAvailable() {
        return materialAvailable;
    }

    public Double getMatAvailStocks() {
        return matAvailStocks;
    }

    /**
     * Get the value of mvt311
     *
     * @return the value of mvt311
     */
    public boolean isMvt311() {
        return mvt311;
    }

    /**
     * Set the value of stage1
     *
     * @param stage1 new value of stage1
     */
    public void setStage1(boolean stage1) {
        boolean oldStage1 = this.stage1;
        this.stage1 = stage1;
        firePropertyChange(PROP_STAGE1, oldStage1, stage1);
    }

    /**
     * Set the value of stage2
     *
     * @param stage2 new value of stage2
     */
    public void setStage2(boolean stage2) {
        boolean oldStage2 = this.stage2;
        this.stage2 = stage2;
        firePropertyChange(PROP_STAGE2, oldStage2, stage2);
    }

    public void setSaveNeeded(boolean b) {
        boolean old = isSaveNeeded();
        this.saveNeeded = b;
        firePropertyChange(PROP_SAVENEEDED, old, isSaveNeeded());
    }

    /**
     * Set the value of bridge1
     *
     * @param bridge1 new value of bridge1
     */
    private void setBridge1(boolean bridge1) {
        boolean oldBridge1 = this.bridge1;
        this.bridge1 = bridge1;
        firePropertyChange(PROP_BRIDGE1, oldBridge1, bridge1);
    }

    /**
     * Set the value of bridge2
     *
     * @param bridge2 new value of bridge2
     */
    private void setBridge2(boolean bridge2) {
        boolean oldBridge2 = this.bridge2;
        this.bridge2 = bridge2;
        firePropertyChange(PROP_BRIDGE2, oldBridge2, bridge2);
    }

    /**
     * Set the value of enteredValidWTNum
     *
     * @param enteredValidWTNum new value of enteredValidWTNum
     */
    public void setEnteredValidWTNum(boolean enteredValidWTNum) {
        boolean oldEnteredValidWTNum = this.enteredValidWTNum;
        this.enteredValidWTNum = enteredValidWTNum;
        firePropertyChange(PROP_ENTEREDVALIDWTNUM, oldEnteredValidWTNum, enteredValidWTNum);
    }

    /**
     * Set the value of validPONum
     *
     * @param validPONum new value of validPONum
     */
    public void setValidPONum(boolean validPONum) {
        boolean oldValidPONum = this.validPONum;
        this.validPONum = validPONum;
        firePropertyChange(PROP_VALIDPONUM, oldValidPONum, validPONum);
    }

    /**
     * Set the value of enteredValidPONum
     *
     * @param enteredValidPONum new value of enteredValidPONum
     */
    public void setEnteredValidPONum(boolean enteredValidPONum) {
        boolean oldEnteredValidPONum = this.enteredValidPONum;
        this.enteredValidPONum = enteredValidPONum;
        firePropertyChange(PROP_ENTEREDVALIDPONUM, oldEnteredValidPONum, enteredValidPONum);
    }

    /**
     * Set the value of withoutDO
     *
     * @param withoutDO new value of withoutDO
     */
    public void setWithoutDO(boolean withoutDO) {
        boolean oldWithoutDO = this.withoutDO;
        this.withoutDO = withoutDO;
        firePropertyChange(PROP_WITHOUTDO, oldWithoutDO, withoutDO);
    }

    /**
     * Set the value of dissolved
     *
     * @param dissolved new value of dissolved
     */
    public void setDissolved(boolean dissolved) {
        boolean oldDissolved = this.dissolved;
        this.dissolved = dissolved;
        firePropertyChange(PROP_DISSOLVED, oldDissolved, dissolved);
    }

    public void setReprintable(boolean b) {
        boolean old = isReprintable();
        this.reprintable = b;
        firePropertyChange(PROP_REPRINTABLE, old, isReprintable());
    }

    public void setFormEnable(boolean formEnable) {
        boolean oldFormEnable = this.formEnable;
        this.formEnable = formEnable;
        firePropertyChange(PROP_FORMENABLE, oldFormEnable, formEnable);
    }

    public void setSubContract(boolean subContract) {
        boolean oldSubContract = this.subContract;
        this.subContract = subContract;
        firePropertyChange(PROP_SUBCONTRACT, oldSubContract, subContract);
    }

    public void setMaterialAvailable(boolean materialAvailable) {
        boolean oldMaterialAvailable = this.materialAvailable;
        this.materialAvailable = materialAvailable;
        firePropertyChange(PROP_MATERIALAVAILABLE, oldMaterialAvailable, materialAvailable);
    }

    public void setMatAvailStocks(Double matAvailStocks) {
        Double oldMatAvailStocks = this.matAvailStocks;
        this.matAvailStocks = matAvailStocks;
        firePropertyChange(PROP_MATAVAILSTOCKS, oldMatAvailStocks, matAvailStocks);
    }

    /**
     * Set the value of mvt311
     *
     * @param mvt311 new value of mvt311
     */
    public void setMvt311(boolean mvt311) {
        boolean oldMvt311 = this.mvt311;
        this.mvt311 = mvt311;
        firePropertyChange(PROP_MVT311, oldMvt311, mvt311);
    }
    // </editor-fold>
    // <editor-fold defaultstate="collapsed" desc="Util. Classes/Methods">

    private class ReadWTTask extends Task<Object, Void> {

        String id;
        Integer seq;

        ReadWTTask(Application app, String id, String seq) {
            super(app);
            this.id = id;
            this.seq = Integer.valueOf(seq);
            setReprintable(false);
            grbType.clearSelection();
            grbCat.clearSelection();
            config = WeighBridgeApp.getApplication().getConfig();
        }

        @Override
        protected Object doInBackground() {
            weightTicket = entityManager.find(WeightTicket.class, new WeightTicketPK(config.getsClient(), config.getwPlant(), id, seq));
            entityManager.clear();
            if (weightTicket == null) {
                failed(new Exception("Khng c phiu cn s: " + txtWTNum.getText()));
            } else {
                if (weightTicket.getRegCategory() == 'I') {
                    rbtInward.setSelected(true);
                } else {

                    rbtOutward.setSelected(true);
                }
                // <editor-fold defaultstate="collapsed" desc="Determine state of Weight Ticket">
                if (weightTicket.getFScale() == null && weightTicket.getSScale() == null) {
                    setStage1(true);
                    setStage2(false);
                } else if (weightTicket.getFScale() != null && weightTicket.getSScale() == null) {
                    setStage1(false);
                    setStage2(true);
                } else {
                    setStage1(false);
                    setStage2(false);
                }
                // </editor-fold>
                // <editor-fold defaultstate="collapsed" desc="Load D.O/P.O details">
                if ((weightTicket.getDelivNumb() == null || weightTicket.getDelivNumb().trim().isEmpty())
                        || ((weightTicket.getPosted() == null || !weightTicket.getPosted()) && (weightTicket.getEbeln() != null && !weightTicket.getEbeln().trim().isEmpty()))
                        || (weightTicket.getDelivNumb() == null && weightTicket.getEbeln() == null)) {
                    setWithoutDO(true);
                } else {
                    setWithoutDO(false);
                }
                if (isStage1() && isWithoutDO()) {
                    rbtPO.setForeground(Color.red);
                    rbtMisc.setForeground(Color.red);
                    rbtMb1b.setForeground(Color.red);
                } else {
                    rbtPO.setForeground(Color.black);
                    rbtMisc.setForeground(Color.black);
                    rbtMb1b.setForeground(Color.black);
                }

                if (!isWithoutDO()) {
                    outbDel = entityManager.find(OutbDel.class, new OutbDelPK(config.getsClient(), weightTicket.getDelivNumb()));
                    OutbDel sapOutbDel = SAP2Local.getOutboundDelivery(weightTicket.getDelivNumb());
                    if (sapOutbDel != null && outbDel == null) {
                        entityManager.getTransaction().begin();
                        entityManager.persist(sapOutbDel);
                        entityManager.getTransaction().commit();
                        entityManager.clear();
                    } else if (sapOutbDel != null && outbDel != null) {
                        entityManager.getTransaction().begin();
                        entityManager.merge(sapOutbDel);
                        entityManager.getTransaction().commit();
                        entityManager.clear();
                    }
                    outbDel = sapOutbDel;
                    weightTicket.setRegItemText(outbDel.getArktx());
                    weightTicket.setMatnrRef(outbDel.getMatnr());
                    weightTicket.setItem(outbDel.getDelivItem());
//                    weightTicket.setUnit(outbDel.getVrkme());
                    weightTicket.setUnit("TO");
                }
                if (weightTicket.getEbeln() != null && !weightTicket.getEbeln().trim().isEmpty()) {
                    purOrder = entityManager.find(PurOrder.class, new PurOrderPK(config.getsClient(), weightTicket.getEbeln()));
                    txtPONum.setText(weightTicket.getEbeln());
                    setValidPONum(true);
                    rbtPO.setSelected(true);
                    setSubContract(false);
                    if (rbtOutward.isSelected() && purOrder.getItemCat() == '3' && purOrder.getMaterial().equalsIgnoreCase(setting.getMatnrPcb40())) {
                        setSubContract(true);
                    }
                }
                if (weightTicket.getMoveType() != null && weightTicket.getMoveReas() != null
                        && weightTicket.getMoveType().equalsIgnoreCase("313")
                        && weightTicket.getMoveReas().equalsIgnoreCase("0003")) {
                    rbtMb1b.setSelected(true);
                    setSubContract(true);
                } else if (weightTicket.getMoveType() != null && weightTicket.getMoveType().equalsIgnoreCase("311")) {
                    rbtMvt311.setSelected(true);
                    setMvt311(true);
                } else if (isWithoutDO() && (weightTicket.getEbeln() == null || weightTicket.getEbeln().trim().isEmpty())) {
                    rbtMisc.setSelected(true);
                }
                if (weightTicket.getRegCategory() == 'I' && ((!isWithoutDO() && !outbDel.getLfart().equalsIgnoreCase("LF") && !outbDel.getLfart().equalsIgnoreCase("LR") && !outbDel.getLfart().equalsIgnoreCase("ZTLF") && !outbDel.getLfart().equalsIgnoreCase("ZTLR")) || isWithoutDO())) {
                    cbxReason.setEnabled(true);
                    cbxCompleted.setEnabled(true);
                    txtGRText.setEnabled(true);
                    cbxBatch.setEditable(true);
                } else {
                    cbxReason.setEnabled(false);
                    cbxCompleted.setEnabled(false);
                    txtGRText.setEnabled(false);
                    cbxBatch.setEditable(false);
                }
                // </editor-fold>
                // <editor-fold defaultstate="collapsed" desc="Bind Weight Ticket">
                if (weightTicket.getMatnrRef() != null) {
                    txtMatnr.setText(weightTicket.getMatnrRef());
                }
                txtRegItem.setText(weightTicket.getRegItemText());
                formatter.applyPattern(WeighBridgeApp.DATE_TIME_DISPLAY_FORMAT);
                if (weightTicket.getFScale() != null) {
                    txfInQty.setValue(weightTicket.getFScale());
                    txtInTime.setText(formatter.format(weightTicket.getFTime()));
                }
                if (weightTicket.getSScale() != null) {
                    txfOutQty.setValue(weightTicket.getSScale());
                    txtOutTime.setText(formatter.format(weightTicket.getSTime()));
                    if (weightTicket.getGQty() != null) {
                        txfGoodsQty.setValue(weightTicket.getGQty());
                    }
                }
                txtDName.setText(weightTicket.getTenTaiXe());
                txtCMNDBL.setText(weightTicket.getCmndBl());
                txtLicPlate.setValue(weightTicket.getSoXe());
                txtTrailerPlate.setValue(weightTicket.getSoRomooc());
                if (weightTicket.getLgort() != null && !weightTicket.getLgort().trim().isEmpty()) {
                    entityManager.clear();
                    SLoc sloc = entityManager.find(SLoc.class, new SLocPK(config.getsClient(), config.getwPlant(), weightTicket.getLgort()));
                    if (sloc != null) {
                      try{
                        cbxSLoc.setSelectedItem(sloc);
                        }catch (Exception e){
                        }
                    }
                } else if (outbDel != null && outbDel.getLgort() != null && !outbDel.getLgort().trim().isEmpty()) {
                SLoc   sloc = entityManager.find(SLoc.class, new SLocPK(config.getsClient(), config.getwPlant(), outbDel.getLgort()));
                    if (sloc != null) {
                        cbxSLoc.setSelectedItem(sloc);
                    }
                } else {
                    cbxSLoc.setSelectedIndex(-1);
                }
                if (weightTicket.getMoveType() != null && weightTicket.getMoveType().equalsIgnoreCase("101") && weightTicket.getMoveReas() != null && !weightTicket.getMoveReas().trim().isEmpty()) {
                    Reason reason = entityManager.find(Reason.class, new ReasonPK(config.getsClient(), "101", weightTicket.getMoveReas()));
                    if (reason != null) {
                        cbxReason.setSelectedItem(reason);
                    }
                }
                txtGRText.setText(weightTicket.getText());

                txtDelNum.setText(weightTicket.getDelivNumb());
                txtCementDesc.setText(weightTicket.getSoNiemXa());
                if (weightTicket.getNoMoreGr() != null && weightTicket.getNoMoreGr() == '2') {
                    cbxCompleted.setSelectedIndex(1);
                } else {
                    cbxCompleted.setSelectedIndex(0);
                }
                chkDissolved.setSelected(weightTicket.getDissolved() == null ? false : weightTicket.getDissolved());
                if (chkDissolved.isSelected() || (!isStage1() && !isStage2() && weightTicket.getPosted() != null && weightTicket.getPosted() == true)) {
                    chkDissolved.setEnabled(false);
                } else {
                    chkDissolved.setEnabled(true);
                }
                setDissolved(chkDissolved.isSelected());
                if (isDissolved() || (!isStage1() && !isStage2() && weightTicket.getPosted() != null && weightTicket.getPosted())) {
                    setValidPONum(false);
                    setWithoutDO(false);
                    cbxReason.setEnabled(false);
                    cbxCompleted.setEnabled(false);
                    txtGRText.setEnabled(false);
                    cbxBatch.setEditable(false);
                    setStage1(false);
                    setStage2(false);
                    setFormEnable(false);
                } else {
                    if (!isWithoutDO() && (outbDel.getLfart().equalsIgnoreCase("LF") || outbDel.getLfart().equalsIgnoreCase("LR") || outbDel.getLfart().equalsIgnoreCase("ZTLF") || outbDel.getLfart().equalsIgnoreCase("ZTLR"))) {
                        setFormEnable(false);
                    } else {
                        setFormEnable(true);
                    }
                }
                if (isDissolved() || (!isStage1() && isStage2()) || (!isStage1() && !isStage2() && weightTicket.getPosted() != null && weightTicket.getPosted())) {
                    setReprintable(true);
                }
                // <editor-fold defaultstate="collapsed" desc="bind batch">
                if (cbxSLoc.getSelectedIndex() > -1
                        && ((weightTicket.getCharg() != null && !weightTicket.getCharg().trim().isEmpty())
                        || (!isWithoutDO() && outbDel != null && outbDel.getCharg() != null && !outbDel.getCharg().trim().isEmpty()))
                        && weightTicket.getMatnrRef() != null && !weightTicket.getMatnrRef().trim().isEmpty()) {
                    String lgort = ((SLoc) cbxSLoc.getSelectedItem()).getSLocPK().getLgort();
                    BatchStocks batch = null;
                    if (weightTicket.getCharg() != null && !weightTicket.getCharg().trim().isEmpty()) {
                        batch = entityManager.find(BatchStocks.class, new BatchStocksPK(config.getsClient(), config.getwPlant(), lgort, weightTicket.getMatnrRef(), weightTicket.getCharg()));
                    } else if (!isWithoutDO() && outbDel.getCharg() != null && !outbDel.getCharg().trim().isEmpty()) {
                        batch = entityManager.find(BatchStocks.class, new BatchStocksPK(config.getsClient(), config.getwPlant(), lgort, weightTicket.getMatnrRef(), outbDel.getCharg()));
                    }
                    if (cbxBatch.getModel().getSize() == 0) {
                        TypedQuery<BatchStocks> tBatchQ = entityManager.createQuery("SELECT b FROM BatchStocks b WHERE b.batchStocksPK.mandt = :mandt AND b.batchStocksPK.werks = :werks AND b.batchStocksPK.lgort = :lgort  AND b.batchStocksPK.matnr = :matnr", BatchStocks.class);
                        tBatchQ.setParameter("mandt", config.getsClient());
                        tBatchQ.setParameter("werks", config.getwPlant());
                        tBatchQ.setParameter("lgort", lgort);
                        tBatchQ.setParameter("matnr", weightTicket.getMatnrRef());
                        List<BatchStocks> batchs = tBatchQ.getResultList();
                        List<BatchStocksStructure> bBatchStocks = SAP2Local.getBatchStocks(lgort, weightTicket.getMatnrRef());
                        entityManager.getTransaction().begin();
                        for (BatchStocksStructure b : bBatchStocks) {
                            BatchStocks bs = new BatchStocks(new BatchStocksPK(config.getsClient(), config.getwPlant(), b.getLgort(), b.getMatnr(), b.getCharg()));
                            bs.setLvorm(b.getLvorm() == null || b.getLvorm().trim().isEmpty() ? ' ' : b.getLvorm().charAt(0));
                            if (batchs.indexOf(bs) == -1) {
                                entityManager.persist(bs);
                            } else {
                                entityManager.merge(bs);
                            }
                            if (batchs.indexOf(bs) == -1 && b.getLgort().equalsIgnoreCase(weightTicket.getLgort())) {
                                batchs.add(bs);
                            }
                        }
                        entityManager.getTransaction().commit();
                        entityManager.clear();
                        DefaultComboBoxModel result = new DefaultComboBoxModel();
                        for (BatchStocks b : batchs) {
                            if (b.getLvorm() == null || b.getLvorm().toString().trim().isEmpty()) {
                                result.addElement(b.getBatchStocksPK().getCharg());
                            }
                        }
                        cbxBatch.setModel(result);
                    }
                    if (batch != null) {
                        cbxBatch.setSelectedItem(batch.getBatchStocksPK().getCharg());
                    } else if (weightTicket.getCharg() != null && cbxBatch.isEditable()) {
                        cbxBatch.setSelectedItem(weightTicket.getCharg());
                    } else {
                        cbxBatch.setSelectedIndex(-1);
                    }
                }
                // </editor-fold>
                // </editor-fold>
            }
            return null;  // return your result
        }

        @Override
        protected void failed(Throwable cause) {
            if (cause instanceof SapException) {
                for (SapException.SapError error : ((SapException) cause).getErrors()) {
                    logger.error(null, new Exception(error.toString()));
                    String transformedMsg = SAPErrorTransform.getMessage(error);
                    if (transformedMsg == null) {
                        JOptionPane.showMessageDialog(rootPane, error.getMessage());
                    } else {
                        JOptionPane.showMessageDialog(rootPane, transformedMsg);
                    }
                }
            } else {
                if (cause instanceof HibersapException && cause.getCause() instanceof JCoException) {
                    cause = cause.getCause();
                }
                logger.error(null, cause);
                JOptionPane.showMessageDialog(rootPane, cause.getMessage());
            }
            clearForm();
        }

        @Override
        protected void finished() {
            setSaveNeeded(isValidated());
        }
    }

    private class ReadPOTask extends Task<Object, Void> {

        String poNum;
        PurOrder sapPurOrder = null;
        Vendor vendor = null;
        Vendor supVendor = null;
        Customer customer = null;
        Vendor sapVendor = null;
        Vendor sapSupVendor = null;
        Customer sapCustomer = null;

        ReadPOTask(Application app, String poNum) {
            super(app);
            this.poNum = poNum;
            config = WeighBridgeApp.getApplication().getConfig();
        }

        @Override
        protected Object doInBackground() {
            setMessage("ang c P.O t CSDL ...");
            setProgress(0, 0, 3);
            purOrder = entityManager.find(PurOrder.class, new PurOrderPK(config.getsClient(), poNum));
            setMessage("Tm d liu ca P.O trong SAP ...");
            setProgress(1, 0, 3);
            try {
                sapPurOrder = SAP2Local.getPurchaseOrder(poNum);
            } catch (Exception ex) {
                failed(ex);
            }
            if (sapPurOrder != null) {
                if (sapPurOrder.getVendor() != null && !sapPurOrder.getVendor().trim().isEmpty()) {
                    vendor = entityManager.find(
                            Vendor.class,
                            new VendorPK(config.getsClient(), sapPurOrder.getVendor()));
                    sapVendor = SAP2Local.getVendor(sapPurOrder.getVendor());
                }
                if (sapPurOrder.getSupplVend() != null && !sapPurOrder.getSupplVend().trim().isEmpty()) {
                    supVendor = entityManager.find(
                            Vendor.class,
                            new VendorPK(config.getsClient(), sapPurOrder.getSupplVend()));
                    sapSupVendor = SAP2Local.getVendor(sapPurOrder.getSupplVend());
                }
                if (sapPurOrder.getCustomer() != null && !sapPurOrder.getCustomer().trim().isEmpty()) {
                    customer = entityManager.find(
                            Customer.class,
                            new CustomerPK(config.getsClient(), sapPurOrder.getCustomer()));
                    sapCustomer = SAP2Local.getCustomer(sapPurOrder.getCustomer());
                }
            }
            setMessage("Lu d liu P.O vo CSDL ...");
            setProgress(2, 0, 3);
            entityManager.getTransaction().begin();
            //Store Ship to party Info
            if (sapVendor != null && vendor == null) {
                entityManager.persist(sapVendor);
            } else if (sapVendor != null && vendor != null) {
                entityManager.merge(sapVendor);
            } else if (sapVendor == null && vendor != null) {
                entityManager.remove(vendor);
            }
            //Store Sold to party Info
            if (sapSupVendor != null && supVendor == null && !sapPurOrder.getVendor().equalsIgnoreCase(sapPurOrder.getSupplVend())) {
                entityManager.persist(sapSupVendor);
            } else if (sapSupVendor != null && supVendor != null) {
                entityManager.merge(sapSupVendor);
            } else if (sapSupVendor == null && supVendor != null && !sapPurOrder.getVendor().equalsIgnoreCase(sapPurOrder.getSupplVend())) {
                entityManager.remove(supVendor);
            }
            //Store Vendor Info
            if (sapCustomer != null && customer == null) {
                entityManager.persist(sapCustomer);
            } else if (sapCustomer != null && customer != null) {
                entityManager.merge(sapCustomer);
            } else if (sapCustomer == null && customer != null) {
                entityManager.remove(customer);
            }
            if (sapPurOrder != null && purOrder == null) {
                entityManager.persist(sapPurOrder);
            } else if (sapPurOrder != null && purOrder != null) {
                entityManager.merge(sapPurOrder);
            } else if (sapPurOrder == null && purOrder != null) {
                entityManager.remove(purOrder);
            }
            entityManager.getTransaction().commit();
            entityManager.clear();
            if (sapPurOrder != null) {
                purOrder = entityManager.find(PurOrder.class, sapPurOrder.getPurOrderPK());
                entityManager.refresh(purOrder);
                entityManager.clear();
                setValidPONum(true);
            } else {
                purOrder = null;
                setValidPONum(false);
            }
            if (isValidPONum()) {
                setSubContract(false);
                if ((rbtInward.isSelected() && purOrder.getPlant().equalsIgnoreCase(config.getwPlant()))
                        || (rbtOutward.isSelected() && purOrder.getSupplPlnt().equalsIgnoreCase(config.getwPlant()))) {
                    setValidPONum(true);
                } else if (rbtOutward.isSelected() && purOrder.getItemCat() == '3' && purOrder.getMaterial().equalsIgnoreCase(setting.getMatnrPcb40())) {
                    purOrder.setMaterial(setting.getMatnrClinker());
                    purOrder.setShortText("Clinker gia cng");
                    purOrder.setPoUnit("TO");
                    setValidPONum(true);
                    setSubContract(true);
                } else {
                    //{+20101206#01
                    setValidPONum(true); 
                    //}+20101206#01
                    //{-20101206#01
                    //setValidPONum(false);
                    //String mode = rbtInward.isSelected() ? "nhp" : "xut";
                    //String msg = "PO \" " + this.poNum + " \" khng c php s dng  " + mode + " hng ti Plant \" " + config.getwPlant() + "\"";
                    //failed(new Exception(msg));
                    //}-20101206#01
                }
            }
            return null;  // return your result
        }

        @Override
        protected void failed(Throwable cause) {
            setValidPONum(false);
            if (cause instanceof SapException) {
                for (SapException.SapError error : ((SapException) cause).getErrors()) {
                    logger.error(null, new Exception(error.toString()));
                    String transformedMsg = SAPErrorTransform.getMessage(error);
                    if (transformedMsg == null) {
                        JOptionPane.showMessageDialog(rootPane, error.getMessage());
                    } else {
                        JOptionPane.showMessageDialog(rootPane, transformedMsg);
                    }
                }
            } else {
                if (cause instanceof HibersapException && cause.getCause() instanceof JCoException) {
                    cause = cause.getCause();
                }
                logger.error(null, cause);
                JOptionPane.showMessageDialog(rootPane, cause.getMessage());
            }
        }

        @Override
        protected void finished() {
            setProgress(3, 0, 3);
            if (isValidPONum()) {
                setSaveNeeded(isValidated());
                txtRegItem.setText(purOrder.getShortText());
                txtMatnr.setText(purOrder.getMaterial());
                weightTicket.setEbeln(purOrder.getPurOrderPK().getPoNumber());
                weightTicket.setItem(purOrder.getPoItem());
                weightTicket.setRegItemText(purOrder.getShortText());
                weightTicket.setMatnrRef(purOrder.getMaterial());
//                weightTicket.setUnit(purOrder.getPoUnit());
                weightTicket.setUnit("TO");
            } else {
                txtRegItem.setText(null);
                txtMatnr.setText(null);
                weightTicket.setEbeln(null);
                weightTicket.setItem(null);
                weightTicket.setMatnrRef(null);
                weightTicket.setUnit(null);
            }
        }
    }

    private class ReprintWTTask extends Task<Object, Void> {

        ReprintWTTask(org.jdesktop.application.Application app) {
            super(app);
        }

        @Override
        protected Object doInBackground() {
            printWT(weightTicket, true);
            return null;  // return your result
        }
    }

    private class SaveWTTask extends Task<Object, Void> {

        Session sapSession = null;
        Object objBapi = null;
        boolean completed = true;

        SaveWTTask(org.jdesktop.application.Application app) {
            super(app);
            if (((isStage2() || (!isStage1() && !isStage2())) && (weightTicket.getDissolved() == null || weightTicket.getDissolved() == false))
                    || ( !isStage1() && !isStage2() && (weightTicket.getDissolved() == null || weightTicket.getDissolved() == false)
                    && (weightTicket != null && (weightTicket.getPosted() == null || (weightTicket.getPosted() != null && weightTicket.getPosted() == false))))) {
                sapSession = WeighBridgeApp.getApplication().getSAPSession();
            }
            setSaveNeeded(false);
        }

        @Override
        protected Object doInBackground() {
            entityManager.getTransaction().begin();
            entityManager.merge(weightTicket);
            if (((isStage2() || (!isStage1() && !isStage2())) && (weightTicket.getDissolved() == null || weightTicket.getDissolved() == false))
                    || ( !isStage1() && !isStage2() && (weightTicket.getDissolved() == null || weightTicket.getDissolved() == false)
                    && (weightTicket != null && (weightTicket.getPosted() == null || (weightTicket.getPosted() != null && weightTicket.getPosted() == false))))) {
                if (rbtInward.isSelected()) {
                    if (weightTicket.getDelivNumb() == null) {
                        objBapi = getGrPoMigoBapi(weightTicket);
                    } else if (outbDel != null && outbDel.getLfart().equalsIgnoreCase("LR") && outbDel.getLfart().equalsIgnoreCase("ZTLR")) {
                        objBapi = getPgmVl02nBapi(weightTicket);
                    } else {
                        objBapi = getGrDoMigoBapi(weightTicket);
                    }
                } else {
                    if (isSubContract() || isMvt311()) {
                        if (rbtPO.isSelected()) {
                            objBapi = getGi541MigoBapi(weightTicket);
                        } else {
                            objBapi = getGiMB1BBapi(weightTicket);
                        }
                    } else if (weightTicket.getDelivNumb() != null) {
                        objBapi = getPgmVl02nBapi(weightTicket);
                    } else {
                        objBapi = getDoCreate2PGI(weightTicket);
                    }
                }
                if (objBapi != null) {
                    sapSession.execute(objBapi);
                    if (objBapi instanceof DOCreate2PGIBapi) {
                        weightTicket.setDelivNumb(((DOCreate2PGIBapi) objBapi).getDelivery());
                        weightTicket.setMatDoc(((DOCreate2PGIBapi) objBapi).getMatDoc());
                        weightTicket.setDocYear(Integer.valueOf(((DOCreate2PGIBapi) objBapi).getDocYear()));
                    }
                    if (objBapi instanceof GoodsMvtPoCreateBapi) {
                        weightTicket.setMatDoc(((GoodsMvtPoCreateBapi) objBapi).getMatDoc());
                        weightTicket.setDocYear(Integer.valueOf(((GoodsMvtPoCreateBapi) objBapi).getMatYear()));
                    }
                    if (objBapi instanceof GoodsMvtDoCreateBapi) {
                        weightTicket.setMatDoc(((GoodsMvtDoCreateBapi) objBapi).getMatDoc());
                        weightTicket.setDocYear(Integer.valueOf(((GoodsMvtDoCreateBapi) objBapi).getMatYear()));
                    }
                    if (objBapi instanceof WsDeliveryUpdateBapi) {
                        weightTicket.setMatDoc(((WsDeliveryUpdateBapi) objBapi).getMat_doc());
                        weightTicket.setDocYear(Integer.valueOf(((WsDeliveryUpdateBapi) objBapi).getDoc_year()));
                        if (weightTicket.getPpProcord() != null && weightTicket.getPpProcord().length() == 12) {
                            weightTicket.setPpProcordcnf(((WsDeliveryUpdateBapi) objBapi).getConf_no());
                            weightTicket.setPpProcordcnfcnt(((WsDeliveryUpdateBapi) objBapi).getConf_cnt());
                        }
                    }
                }
                weightTicket.setPosted(true);
                // <editor-fold defaultstate="collapsed" desc="Update D.O from SAP to DB">
                if (outbDel != null) {
                    OutbDel sapOutb = SAP2Local.getOutboundDelivery(outbDel.getOutbDelPK().getDelivNumb());
                    Customer kunnr = null, sapKunnr = null, kunag = null, sapKunag = null;
                    Vendor lifnr = null, sapLifnr = null;
                    if (sapOutb != null) {
                        if (sapOutb.getKunnr() != null && !sapOutb.getKunnr().trim().isEmpty()) {
                            kunnr = entityManager.find(
                                    Customer.class,
                                    new CustomerPK(WeighBridgeApp.getApplication().getConfig().getsClient(), sapOutb.getKunnr()));
                            sapKunnr = SAP2Local.getCustomer(sapOutb.getKunnr());
                        }
                        if (sapOutb.getKunag() != null && !sapOutb.getKunag().trim().isEmpty()) {
                            kunag = entityManager.find(
                                    Customer.class,
                                    new CustomerPK(WeighBridgeApp.getApplication().getConfig().getsClient(), sapOutb.getKunag()));
                            sapKunag = SAP2Local.getCustomer(sapOutb.getKunag());
                        }
                        if (sapOutb.getLifnr() != null && !sapOutb.getLifnr().trim().isEmpty()) {
                            lifnr = entityManager.find(
                                    Vendor.class,
                                    new VendorPK(WeighBridgeApp.getApplication().getConfig().getsClient(), sapOutb.getLifnr()));
                            sapLifnr = SAP2Local.getVendor(sapOutb.getLifnr());
                        }
                    }
                    //Store Ship to party Info
                    if (sapKunnr != null && kunnr == null) {
                        entityManager.persist(sapKunnr);
                    } else if (sapKunnr != null && kunnr != null) {
                        entityManager.merge(sapKunnr);
                    } else if (sapKunnr == null && kunnr != null) {
                        entityManager.remove(kunnr);
                    }
                    //Store Sold to party Info
                    if (sapKunag != null && kunag == null && !sapKunnr.getCustomerPK().getKunnr().equalsIgnoreCase(sapKunag.getCustomerPK().getKunnr())) {
                        entityManager.persist(sapKunag);
                    } else if (sapKunag != null && kunag != null) {
                        entityManager.merge(sapKunag);
                    } else if (sapKunag == null && kunag != null && !sapKunnr.getCustomerPK().getKunnr().equalsIgnoreCase(sapKunag.getCustomerPK().getKunnr())) {
                        entityManager.remove(kunag);
                    }
                    //Store Vendor Info
                    if (sapLifnr != null && lifnr == null) {
                        entityManager.persist(sapLifnr);
                    } else if (sapLifnr != null && lifnr != null) {
                        entityManager.merge(sapLifnr);
                    } else if (sapLifnr == null && lifnr != null) {
                        entityManager.remove(lifnr);
                    }
                    entityManager.merge(sapOutb);
                    outbDel = sapOutb;
                }
                // </editor-fold>
            }
            entityManager.merge(weightTicket);
            entityManager.getTransaction().commit();
            entityManager.clear();
            if (completed) {
                if (weightTicket.getDissolved() == null || weightTicket.getDissolved() == false){ //+20100111#01 khong in neu huy phieu
                setMessage("ang in phiu cn...");
                printWT(weightTicket, false);
                }
            }
            return null;  // return your result
        }

        @Override
        protected void failed(Throwable cause) {
            completed = false;
            if ((isStage2() && (weightTicket.getDissolved() == null || weightTicket.getDissolved() == false))
                    || (weightTicket != null && (weightTicket.getPosted() == null || (weightTicket.getPosted() != null && weightTicket.getPosted() == false)))) {
                weightTicket.setPosted(false);
            }
            entityManager.merge(weightTicket);
            entityManager.getTransaction().commit();
            entityManager.clear();
            if (cause instanceof SapException) {
                for (SapException.SapError error : ((SapException) cause).getErrors()) {
                    logger.error(null, new Exception(error.toString()));
                    String transformedMsg = SAPErrorTransform.getMessage(error);
                    if (transformedMsg == null) {
                        JOptionPane.showMessageDialog(rootPane, error.getMessage());
                    } else {
                        JOptionPane.showMessageDialog(rootPane, transformedMsg);
                    }
                }
            } else {
                if (cause instanceof HibersapException && cause.getCause() instanceof JCoException) {
                    cause = cause.getCause();
                }
                logger.error(null, cause);
                JOptionPane.showMessageDialog(rootPane, cause.getMessage());
            }
            setSaveNeeded(true);
        }

        @Override
        protected void finished() {
            clearForm();
            setSaveNeeded(isValidated());
        }
    }

    private class AcceptBatchTask extends org.jdesktop.application.Task<Object, Void> {

        AcceptBatchTask(org.jdesktop.application.Application app) {
            super(app);
            config = WeighBridgeApp.getApplication().getConfig();
        }

        @Override
        protected Object doInBackground() {
            String charg = cbxBatch.getSelectedIndex() == -1 && cbxBatch.isEditable()
                    ? cbxBatch.getEditor().getItem().toString().trim().isEmpty() ? null : cbxBatch.getEditor().getItem().toString().trim()
                    : cbxBatch.getSelectedItem().toString();
            weightTicket.setCharg(charg);
            if (rbtMb1b.isSelected() || rbtMvt311.isSelected()) {
                weightTicket.setRecvCharg(charg);
            }
            lblBatch.setForeground(Color.black);
            if (isSubContract() && txfGoodsQty.getValue() != null) {
                setMessage("ang kim tra tn kho trong SAP...");
                Double remaining = CheckMatStock(weightTicket.getMatnrRef(), config.getwPlant(), weightTicket.getLgort(), weightTicket.getCharg());
                if (weightTicket.getGQty().doubleValue() > remaining) {
                    JOptionPane.showMessageDialog(rootPane, "K.L xut ln hn K.L tn kho!!!");
                    txfOutQty.setValue(null);
                    txfGoodsQty.setValue(null);
                    weightTicket.setGQty(null);
                }
            }
            return null;  // return your result
        }

        @Override
        protected void finished() {
            setSaveNeeded(isValidated());
        }
    }

    private class AcceptScaleTask extends Task<Object, Void> {

        AcceptScaleTask(org.jdesktop.application.Application app) {
            super(app);
            config = WeighBridgeApp.getApplication().getConfig();
        }

        @Override
        protected Object doInBackground() {
            WeighBridgeApp.getApplication().disconnectWB();
            formatter.applyPattern(WeighBridgeApp.DATE_TIME_DISPLAY_FORMAT);
            Date now = Calendar.getInstance().getTime();
            if (isStage1()) {
                txfInQty.setValue(txfCurScale.getValue());
                txtInTime.setText(formatter.format(now));
                weightTicket.setFCreator(WeighBridgeApp.getApplication().getLogin().getUserPK().getId());
                weightTicket.setFScale(new BigDecimal(((Number) txfInQty.getValue()).doubleValue()));
                weightTicket.setFTime(now);
                lblIScale.setForeground(Color.black);
            } else if (isStage2()) {
                txfOutQty.setValue(txfCurScale.getValue());
                txtOutTime.setText(formatter.format(now));
                weightTicket.setSCreator(WeighBridgeApp.getApplication().getLogin().getUserPK().getId());
                weightTicket.setSScale(new BigDecimal(((Number) txfOutQty.getValue()).doubleValue()));
                weightTicket.setSTime(now);
                lblOScale.setForeground(Color.black);
            }
            grbBridge.clearSelection();
            btnAccept.setEnabled(false);
            if (txfInQty.getValue() != null && txfOutQty.getValue() != null) {
                double dIn = ((Number) txfInQty.getValue()).doubleValue();
                double dOut = ((Number) txfOutQty.getValue()).doubleValue();
                double result = 0d;
                if (dIn > dOut) {
                    result = dIn - dOut;
                    if (weightTicket.getRegCategory() == 'O'){
                        JOptionPane.showMessageDialog(rootPane, "K.L nhp ln hn K.L xut!");
                        txfOutQty.setValue(null);
                        txfGoodsQty.setValue(null);
                        weightTicket.setGQty(null);
                        return null;
                    }
                } else {
                    result = dOut - dIn;
                    if (weightTicket.getRegCategory() == 'I'){
                        JOptionPane.showMessageDialog(rootPane, "K.L xut ln hn K.L nhp!");
                        txfOutQty.setValue(null);
                        txfGoodsQty.setValue(null);
                        weightTicket.setGQty(null);
                        return null;
                    }
                }
                if (result == 0){
                 JOptionPane.showMessageDialog(rootPane, "K.L hng khng hp l!");
                        txfOutQty.setValue(null);
                        txfGoodsQty.setValue(null);
                        weightTicket.setGQty(null);
                        return null;
                }
                //  Conver result from KG unit to TON unit
                result = result / 1000d;
                    double main_qty = 0;
                    double qty = 0;
                    if (outbDel != null){
                    try{
                      main_qty = outbDel.getLfimg().doubleValue();
                    } catch (Exception e ){

                    }
                    double free_qty = 0;
                    try{
                    free_qty = outbDel.getFreeQty().doubleValue();
                    } catch (Exception e ){

                    }
                    qty = main_qty + free_qty;
                }
                if (outbDel != null && ( outbDel.getLfart().equalsIgnoreCase("LF") || outbDel.getLfart().equalsIgnoreCase("ZTLF"))&& outbDel.getMatnr().equalsIgnoreCase(setting.getMatnrPcb40())) {
                    
                    double upper = qty + (qty * (config.getB1Port() != null ? WeighBridgeApp.getApplication().getSapSetting().getWb1Tol().doubleValue() : config.getB2Port() != null ? WeighBridgeApp.getApplication().getSapSetting().getWb2Tol().doubleValue() : 0d));
                    double lower = qty - (qty * (config.getB1Port() != null ? WeighBridgeApp.getApplication().getSapSetting().getWb1Tol().doubleValue() : config.getB2Port() != null ? WeighBridgeApp.getApplication().getSapSetting().getWb2Tol().doubleValue() : 0d));
                    if (lower <= result && result <= upper) {
                        txfGoodsQty.setValue(result);
                        weightTicket.setGQty(new BigDecimal(result));
                    } else {
                        JOptionPane.showMessageDialog(rootPane, "Khi lng vt qu sai s cho php!!!");
                        txfGoodsQty.setValue(null);
                        weightTicket.setGQty(null);
                    }
                } else if (outbDel != null && ( outbDel.getLfart().equalsIgnoreCase("LF") || outbDel.getLfart().equalsIgnoreCase("ZTLF") ) && outbDel.getMatnr().equalsIgnoreCase(setting.getMatnrXmxa())) {
                    if (result <= qty) {
                        txfGoodsQty.setValue(result);
                        weightTicket.setGQty(new BigDecimal(result));
                    } else {
                        JOptionPane.showMessageDialog(rootPane, "Khi lng vt qu mc cho php ly!!!");
                        txfGoodsQty.setValue(null);
                        weightTicket.setGQty(null);
                    }
                } else if (isSubContract() && weightTicket.getLgort() != null && weightTicket.getCharg() != null) {
                    setMessage("ang kim tra tn kho trong SAP...");
                    Double remaining = CheckMatStock(weightTicket.getMatnrRef(), config.getwPlant(), weightTicket.getLgort(), weightTicket.getCharg());
                    if (result <= remaining) {
                        txfGoodsQty.setValue(result);
                        weightTicket.setGQty(new BigDecimal(result));
                    } else {
                        JOptionPane.showMessageDialog(rootPane, "K.L xut ln hn K.L tn kho!!!");
                        txfOutQty.setValue(null);
                        txfGoodsQty.setValue(null);
                        weightTicket.setGQty(null);
                    }
                } else {
                    txfGoodsQty.setValue(result);
                    weightTicket.setGQty(new BigDecimal(result));
                }
            }

            return null;  // return your result
        }

        @Override
        protected void finished() {
            setSaveNeeded(isValidated());
        }
    }

    private Double CheckMatStock(String matnr, String plant, String sloc, String batch) {

        Double remaining = 0d;

        MatAvailableBapi bapi = new MatAvailableBapi();
        bapi.setMaterial(matnr);
        bapi.setPlant(plant);
        bapi.setSloc(sloc);
        bapi.setBatch(batch);
        bapi.setUnit("TO");
        try {
            WeighBridgeApp.getApplication().getSAPSession().execute(bapi);
            List<MatAvailableStructure> stocks = bapi.getWmdvex();
            if (!stocks.isEmpty() && stocks.get(0).getCom_qty() != null) {
                remaining = stocks.get(0).getCom_qty().doubleValue();
            }
        } catch (Throwable cause) {
            if (cause instanceof SapException) {
                for (SapException.SapError error : ((SapException) cause).getErrors()) {
                    logger.error(null, new Exception(error.toString()));
                    JOptionPane.showMessageDialog(rootPane, error.getMessage());
                }
            } else {
                if (cause instanceof HibersapException && cause.getCause() instanceof JCoException) {
                    cause = cause.getCause();
                }
                logger.error(null, cause);
                JOptionPane.showMessageDialog(rootPane, cause.getMessage());
            }
        }
        return remaining;
    }

    private void clearForm() {
        weightTicket = null;
        purOrder = null;
        outbDel = null;
        material = null;
        this.setDissolved(false);
        this.setEnteredValidPONum(false);
        this.setEnteredValidWTNum(false);
        this.setReprintable(false);
        this.setSaveNeeded(false);
        this.setStage1(false);
        this.setStage2(false);
        this.setValidPONum(false);
        this.setWithoutDO(false);
        cbxReason.setEnabled(false);
        cbxCompleted.setEnabled(false);
        txtGRText.setEnabled(false);
        cbxBatch.setEditable(false);
        this.setFormEnable(false);
        this.setSubContract(false);
        this.setMvt311(false);
        this.setMaterialAvailable(false);
        this.setMatAvailStocks(null);

        grbType.clearSelection();
        grbCat.clearSelection();

        txtPONum.setText(null);
        txfCurScale.setValue(null);
        txfInQty.setValue(null);
        txtInTime.setText(null);
        txfOutQty.setValue(null);
        txtOutTime.setText(null);
        txfGoodsQty.setValue(null);
        txtDName.setText(null);
        txtCMNDBL.setText(null);
        txtLicPlate.setValue(null);
        txtTrailerPlate.setValue(null);
        cbxSLoc.setSelectedIndex(-1);
        cbxReason.setSelectedIndex(-1);
        txtGRText.setText(null);
        txtRegItem.setText(null);
        txtMatnr.setText(null);
        txtDelNum.setText(null);
        cbxBatch.setModel(new DefaultComboBoxModel());
        txtCementDesc.setText(null);
        cbxCompleted.setSelectedIndex(-1);

        rbtPO.setForeground(Color.black);
        rbtMisc.setForeground(Color.black);
        rbtMb1b.setForeground(Color.black);
        lblIScale.setForeground(Color.black);
        lblOScale.setForeground(Color.black);
        lblGScale.setForeground(Color.black);
        lblSLoc.setForeground(Color.black);
        lblBatch.setForeground(Color.black);

        // Temporary enable btnAccept
//        btnAccept.setEnabled(true);
    }

    private Object getGrDoMigoBapi(WeightTicket wt) {
        config = WeighBridgeApp.getApplication().getConfig();
        String plateCombine = wt.getSoXe();
        if (wt.getSoRomooc() != null && !wt.getSoRomooc().trim().isEmpty()) {
            plateCombine += wt.getSoRomooc();
        }

        GoodsMvtDoCreateBapi bapi = new GoodsMvtDoCreateBapi();
        GoodsMvtHeaderStructure header = new GoodsMvtHeaderStructure();
        header.setDocDate(DateUtil.stripTime(wt.getSTime()));
        header.setPstngDate(DateUtil.stripTime(wt.getSTime()));
        header.setRefDocNo(wt.getDelivNumb());
        header.setBillOfLading(plateCombine);
        header.setGrGiSlipNo(wt.getCmndBl());
        header.setHeaderText(wt.getDelivNumb());

        GoodsMvtItemDoStructure tab_wa = new GoodsMvtItemDoStructure();
        List<GoodsMvtItemDoStructure> tab = new ArrayList<GoodsMvtItemDoStructure>();

        tab_wa.setDeliv_numb(wt.getDelivNumb());
        tab_wa.setDeliv_numb_to_search(wt.getDelivNumb());
        tab_wa.setDeliv_item(wt.getItem());
        tab_wa.setDeliv_item_to_search(wt.getItem());
        tab_wa.setMove_type("101");
        tab_wa.setPlant(config.getwPlant());
        tab_wa.setStge_loc(wt.getLgort());
        tab_wa.setBatch(wt.getCharg());
        tab_wa.setGr_rcpt(wt.getSCreator());
        tab_wa.setEntry_qnt(wt.getGQty());
        tab_wa.setEntry_uom(wt.getUnit());
//        tab_wa.setEntry_uom_iso(wt.getUnit());
        if (wt.getNoMoreGr() != null && wt.getNoMoreGr() == '2') {
            tab_wa.setNo_more_gr("X");
        } else {
            tab_wa.setNo_more_gr(null);
        }
        tab_wa.setMove_reas(wt.getMoveReas());
        tab_wa.setItem_text(wt.getText());
        tab.add(tab_wa);

        bapi.setHeader(header);
        bapi.setItems(tab);
        return bapi;
    }

    private Object getGrPoMigoBapi(WeightTicket wt) {
        config = WeighBridgeApp.getApplication().getConfig();
        //  TODO: Sum QTY of wt GR posted on this plant, then calculate the remaining Qty of Main Item and free Item if Existed
        String plateCombine = wt.getSoXe();
        if (wt.getSoRomooc() != null && !wt.getSoRomooc().trim().isEmpty()) {
            plateCombine += wt.getSoRomooc();
        }
        GoodsMvtPoCreateBapi bapi = new GoodsMvtPoCreateBapi();
        GoodsMvtHeaderStructure header = new GoodsMvtHeaderStructure();

        header.setDocDate(DateUtil.stripTime(wt.getSTime()));
        header.setPstngDate(DateUtil.stripTime(wt.getSTime()));
        header.setBillOfLading(plateCombine);
        header.setGrGiSlipNo(wt.getCmndBl());

        List<GoodsMvtItemPoStructure> tab = new ArrayList<GoodsMvtItemPoStructure>();
        GoodsMvtItemPoStructure tab_wa = new GoodsMvtItemPoStructure();

        tab_wa.setPo_number(wt.getEbeln());
        tab_wa.setPo_item(wt.getItem());
        tab_wa.setMove_type("101");
        tab_wa.setPlant(config.getwPlant());
        tab_wa.setStge_loc(wt.getLgort());
        tab_wa.setBatch(wt.getCharg());
        tab_wa.setGr_rcpt(wt.getSCreator());
        tab_wa.setEntry_qnt(wt.getGQty());
        tab_wa.setEntry_uom(wt.getUnit());
//        tab_wa.setEntry_uom_iso(wt.getUnit());

        if (wt.getNoMoreGr() != null && wt.getNoMoreGr() == '2') {
            tab_wa.setNo_more_gr("X");
        } else {
            tab_wa.setNo_more_gr(null);
        }
        tab_wa.setMove_reas(wt.getMoveReas());
        tab_wa.setItem_text(wt.getText());
        tab.add(tab_wa);

        if (purOrder != null && purOrder.getPoItemFree() != null) {
//            tab_wa.setPo_number(wt.getEbeln());
//            tab_wa.setPo_item(purOrder.getPoItemFree());
//            tab_wa.setMove_type("101");
//            tab_wa.setPlant(config.getwPlant());
//            tab_wa.setStge_loc(wt.getLgort());
//            tab_wa.setBatch(wt.getCharg());
//            tab_wa.setGr_rcpt(wt.getSCreator());
//            tab_wa.setEntry_qnt(wt.getGQty());
//            tab_wa.setEntry_uom(wt.getUnit());
//            tab_wa.setEntry_uom_iso(wt.getUnit());
//
//            if (wt.getNoMoreGr() != null && wt.getNoMoreGr() == '2') {
//                tab_wa.setNo_more_gr("X");
//            } else {
//                tab_wa.setNo_more_gr(null);
//            }
//            tab_wa.setMove_reas(wt.getMoveReas());
//            tab_wa.setItem_text(wt.getText());
//            tab.add(tab_wa);
        }

        bapi.setHeader(header);
        bapi.setItems(tab);
        return bapi;
    }

    private Object getGi541MigoBapi(WeightTicket wt) {
        config = WeighBridgeApp.getApplication().getConfig();
        String plateCombine = wt.getSoXe();
        if (wt.getSoRomooc() != null && !wt.getSoRomooc().trim().isEmpty()) {
            plateCombine += wt.getSoRomooc();
        }
        GoodsMvtPoCreateBapi bapi = new GoodsMvtPoCreateBapi(new GoodsMvtCodeStructure("04"));
        GoodsMvtHeaderStructure header = new GoodsMvtHeaderStructure();

        header.setDocDate(DateUtil.stripTime(wt.getSTime()));
        header.setPstngDate(DateUtil.stripTime(wt.getSTime()));
        header.setBillOfLading(plateCombine);
        header.setGrGiSlipNo(wt.getCmndBl());

        List<GoodsMvtItemPoStructure> tab = new ArrayList<GoodsMvtItemPoStructure>();
        GoodsMvtItemPoStructure tab_wa = new GoodsMvtItemPoStructure();

        tab_wa.setMaterial(wt.getMatnrRef());
        tab_wa.setPlant(config.getwPlant());
        tab_wa.setStge_loc(wt.getLgort());
        tab_wa.setMove_type("541");
        tab_wa.setMvt_ind(null);
        tab_wa.setEntry_qnt(wt.getGQty());
//        tab_wa.setEntry_uom_iso(wt.getUnit());

        tab_wa.setEntry_uom(wt.getUnit());
//        tab_wa.setGr_rcpt(wt.getSCreator());
        tab_wa.setBatch(wt.getCharg());
        tab_wa.setVendor(purOrder.getVendor());

        tab_wa.setNo_more_gr(null);

        tab_wa.setItem_text(wt.getText());
        tab.add(tab_wa);

        bapi.setHeader(header);
        bapi.setItems(tab);
        return bapi;
    }

    private Object getGiMB1BBapi(WeightTicket wt) {
        config = WeighBridgeApp.getApplication().getConfig();
        String vendorNo = null;
        String headertxt = null;
        String plateCombine = wt.getSoXe();
        if (wt.getSoRomooc() != null && !wt.getSoRomooc().trim().isEmpty()) {
            plateCombine += wt.getSoRomooc();
        }
        if (setting.getCheckTalp().booleanValue()) {
            Vehicle vehicle = entityManager.find(Vehicle.class, wt.getSoXe());
            vendorNo = vehicle.getTaAbbr();
            if (vendorNo.startsWith("00") && vendorNo.length() == 10) {
                vendorNo = vendorNo.substring(2);
            }
        }
        GoodsMvtPoCreateBapi bapi = new GoodsMvtPoCreateBapi(new GoodsMvtCodeStructure("04"));
        GoodsMvtHeaderStructure header = new GoodsMvtHeaderStructure();

        header.setDocDate(DateUtil.stripTime(wt.getSTime()));
        header.setPstngDate(DateUtil.stripTime(wt.getSTime()));
        header.setRefDocNo(weightTicket.getRecvPo());
        header.setGrGiSlipNo(wt.getCmndBl());
        if (vendorNo != null) {
            headertxt = plateCombine + "|" + vendorNo;
        } else {
            headertxt = plateCombine;
        }

        header.setHeaderText(headertxt);

        List<GoodsMvtItemPoStructure> tab = new ArrayList<GoodsMvtItemPoStructure>();
        GoodsMvtItemPoStructure tab_wa = new GoodsMvtItemPoStructure();

        tab_wa.setMaterial(wt.getMatnrRef());
        tab_wa.setPlant(config.getwPlant());
        tab_wa.setStge_loc(wt.getLgort());
        tab_wa.setBatch(wt.getCharg());
        tab_wa.setMove_type(wt.getMoveType());
        tab_wa.setMvt_ind(null);
        tab_wa.setEntry_qnt(wt.getGQty());
//        tab_wa.setEntry_uom_iso(wt.getUnit());
        tab_wa.setEntry_uom(wt.getUnit());

        tab_wa.setMoveMat(wt.getRecvMatnr());
        tab_wa.setMovePlant(wt.getRecvPlant());
        tab_wa.setMoveSLoc(wt.getRecvLgort());
        tab_wa.setMoveBatch(wt.getRecvCharg());

        tab_wa.setMove_reas(wt.getMoveReas());
        tab_wa.setItem_text(wt.getText());
        tab.add(tab_wa);

        bapi.setHeader(header);
        bapi.setItems(tab);
        return bapi;
    }

    private Object getDoCreate2PGI(WeightTicket wt) {
        config = WeighBridgeApp.getApplication().getConfig();
        DOCreate2PGIBapi bapi = new DOCreate2PGIBapi();

        String plateCombine = wt.getSoXe();
        if (wt.getSoRomooc() != null && !wt.getSoRomooc().trim().isEmpty()) {
            plateCombine += "|" + wt.getSoRomooc();
        }
        if (setting.getCheckTalp().booleanValue()) {
            Vehicle vehicle = entityManager.find(Vehicle.class, wt.getSoXe());
            if (vehicle != null) {
                bapi.setIdParnr(vehicle.getTaAbbr());
            }
        }

        VbkokStructure wa = new VbkokStructure();
        wa.setVbeln_vl(wt.getDelivNumb());
        wa.setKodat(DateUtil.stripTime(wt.getFTime()));
        wa.setKouhr(DateUtil.stripDate(wt.getFTime()));
        wa.setKomue("X");
        wa.setWabuc("X");
        wa.setWadat_ist(DateUtil.stripTime(wt.getSTime()));
        wa.setWadat(DateUtil.stripTime(wt.getSTime()));
        wa.setWauhr(DateUtil.stripDate(wt.getSTime()));
        wa.setLfdat(DateUtil.stripTime(wt.getSTime()));
        wa.setLfuhr(DateUtil.stripDate(wt.getSTime()));
        wa.setTraty("0004");
        wa.setTraid(plateCombine);
        wa.setLifex(wt.getTenTaiXe());
        bapi.setVbkok_wa(wa);

        List<OutbDeliveryCreateStoStructure> _StockTransItems = new ArrayList<OutbDeliveryCreateStoStructure>();
        _StockTransItems.add(new OutbDeliveryCreateStoStructure(wt.getEbeln(), wt.getItem(), wt.getGQty(), wt.getUnit()));
        bapi.setStockTransItems(_StockTransItems);

        List<VbpokStructure> tab = new ArrayList<VbpokStructure>();
        VbpokStructure tab_wa = new VbpokStructure();
        tab_wa.setVbeln_vl(wt.getDelivNumb());
        tab_wa.setPosnr_vl(wt.getItem());
        tab_wa.setVbeln(tab_wa.getVbeln_vl());
        tab_wa.setPosnn(tab_wa.getPosnr_vl());
        tab_wa.setMatnr(wt.getMatnrRef());
        tab_wa.setWerks(config.getwPlant());
        tab_wa.setLgort(wt.getLgort());
        tab_wa.setCharg(wt.getCharg());
        tab_wa.setLianp("X");
        tab_wa.setPikmg(wt.getGQty());
        tab_wa.setLfimg(wt.getGQty());
        tab_wa.setVrkme(wt.getUnit());
        tab_wa.setMeins(wt.getUnit());
        tab.add(tab_wa);
        bapi.setVbpok_tab(tab);

        return bapi;
    }

    private Object getPgmVl02nBapi(WeightTicket wt) {
        config = WeighBridgeApp.getApplication().getConfig();
        String plateCombine = wt.getSoXe();
        if (wt.getSoRomooc() != null && !wt.getSoRomooc().trim().isEmpty()) {
            plateCombine += "|" + wt.getSoRomooc();
        }
        WsDeliveryUpdateBapi bapi = new WsDeliveryUpdateBapi();
        bapi.setDelivery(wt.getDelivNumb());
        bapi.setUpdate_picking("X");

        if (wt.getPpProcord() != null && wt.getPpProcord().length() == 12) {
            bapi.setProc_ord_id(wt.getPpProcord());
            bapi.setYield(wt.getGQty());
            bapi.setAct1(setting.getBact1Val().multiply(wt.getGQty()));
            bapi.setAct2(setting.getBact2Val().multiply(wt.getGQty()));
            bapi.setAct3(setting.getBact3Val().multiply(wt.getGQty()));
            bapi.setAct4(setting.getBact4Val().multiply(wt.getGQty()));
        }
        //{+20101203#01 set confirm quantity = goods qty on scale
        bapi.setYield(wt.getGQty());
        //}+20101203#01
        VbkokStructure wa = new VbkokStructure();
        wa.setVbeln_vl(wt.getDelivNumb());
        wa.setKodat(DateUtil.stripTime(wt.getFTime()));
        wa.setKouhr(DateUtil.stripDate(wt.getFTime()));
        wa.setKomue("X");
        wa.setWabuc("X");
        wa.setWadat_ist(DateUtil.stripTime(wt.getSTime()));
        wa.setWadat(DateUtil.stripTime(wt.getSTime()));
        wa.setWauhr(DateUtil.stripDate(wt.getSTime()));
        wa.setLfdat(DateUtil.stripTime(wt.getSTime()));
        wa.setLfuhr(DateUtil.stripDate(wt.getSTime()));
        wa.setTraty("0004");
        wa.setTraid(plateCombine);
        wa.setLifex(wt.getTenTaiXe());
        bapi.setVbkok_wa(wa);

        List<VbpokStructure> tab = new ArrayList<VbpokStructure>();
        VbpokStructure tab_wa = new VbpokStructure();
        tab_wa.setVbeln_vl(wt.getDelivNumb());
        tab_wa.setPosnr_vl(wt.getItem());
        tab_wa.setVbeln(tab_wa.getVbeln_vl());
        tab_wa.setPosnn(tab_wa.getPosnr_vl());
        tab_wa.setMatnr(wt.getMatnrRef());
        tab_wa.setWerks(config.getwPlant());
        tab_wa.setLgort(wt.getLgort());
        tab_wa.setCharg(wt.getCharg());
        tab_wa.setLianp("X");
        if (outbDel != null && ( outbDel.getLfart().equalsIgnoreCase("LF") || outbDel.getLfart().equalsIgnoreCase("ZTLF") ) && wt.getMatnrRef().equalsIgnoreCase(setting.getMatnrPcb40())) {
            tab_wa.setPikmg(outbDel.getLfimg());
            tab_wa.setLfimg(outbDel.getLfimg());
        } else {
            /*{-20101203#01 comment
            tab_wa.setPikmg(wt.getGQty());
            tab_wa.setLfimg(wt.getGQty());
            }-20101203#01 comment */
            //{+20101203#01 freeGoods qty
            BigDecimal qty = new BigDecimal(0);
            BigDecimal qtyfree = new BigDecimal(0);
            try{
            qtyfree = (BigDecimal) outbDel.getFreeQty();
            } catch (Exception ex){
               // qtyfree = 0;
            }
            qty = wt.getGQty().subtract(qtyfree);
            tab_wa.setPikmg(qty);
            tab_wa.setLfimg(qty);
            //}+20101203#01 freeGoods qty
        }
        tab_wa.setVrkme(wt.getUnit());
        tab_wa.setMeins(outbDel.getMeins());
        tab.add(tab_wa);
        //{+20101203#01 add free goods item
        VbpokStructure tab_wa_f = new VbpokStructure();

        tab_wa_f.setMatnr(wt.getMatnrRef());
        tab_wa_f.setWerks(config.getwPlant());
        tab_wa_f.setLgort(wt.getLgort());
        tab_wa_f.setCharg(wt.getCharg());
        tab_wa_f.setLianp("X");
        tab_wa_f.setVrkme(wt.getUnit());
        tab_wa_f.setMeins(outbDel.getMeins());

        if (outbDel.getDelivItemFree() != null && (outbDel.getDelivItemFree() == null ? "" != null : !outbDel.getDelivItemFree().equals(""))){
            tab_wa_f.setVbeln_vl(wt.getDelivNumb());
            tab_wa_f.setPosnr_vl(outbDel.getDelivItemFree());
            tab_wa_f.setVbeln(tab_wa_f.getVbeln_vl());
            tab_wa_f.setPosnn(tab_wa_f.getPosnr_vl());
            //if (outbDel != null && ( outbDel.getLfart().equalsIgnoreCase("LF") || outbDel.getLfart().equalsIgnoreCase("ZTLF") ) && wt.getMatnrRef().equalsIgnoreCase(setting.getMatnrPcb40())) {
                tab_wa_f.setPikmg(outbDel.getFreeQty());
                tab_wa_f.setLfimg(outbDel.getFreeQty());
            //} else {
            //    tab_wa.setPikmg(wt.getGQty());
            //    tab_wa.setLfimg(wt.getGQty());
            //}
            tab.add(tab_wa_f);
        }
        //}+20101203#01 add free goods item

        bapi.setVbpok_tab(tab);
        return bapi;
    }

    private DefaultComboBoxModel getReasonModel() {
        config = WeighBridgeApp.getApplication().getConfig();
        Movement mvt = null;
        try {
            TypedQuery<Movement> tMvtQ = entityManager.createNamedQuery("Movement.findByMandtBwartSpras", Movement.class);
            tMvtQ.setParameter("mandt", config.getsClient());
            tMvtQ.setParameter("bwart", "101");
            tMvtQ.setParameter("spras", WeighBridgeApp.getApplication().getLogin().getLanguP().toString());
            mvt = tMvtQ.getSingleResult();
        } catch (NoResultException ex) {
            MvtGetDetailBapi bMvt = new MvtGetDetailBapi(config.getsClient(), "101");
            WeighBridgeApp.getApplication().getSAPSession().execute(bMvt);
            mvt = new Movement(new MovementPK(config.getsClient(), bMvt.getItem().getBwart()), bMvt.getItem().getSpras());
            mvt.setBtext(bMvt.getItem().getBtext());
            entityManager.getTransaction().begin();
            entityManager.persist(mvt);
            entityManager.getTransaction().commit();
            entityManager.clear();
        }

        TypedQuery<Reason> tReasonQ = entityManager.createNamedQuery("Reason.findByMandtBwart", Reason.class);
        tReasonQ.setParameter("mandt", config.getsClient());
        tReasonQ.setParameter("bwart", mvt.getMovementPK().getBwart());
        List<Reason> reasons = tReasonQ.getResultList();
        if (reasons.isEmpty()) {
            MvtReasonsGetListBapi bReason = new MvtReasonsGetListBapi(config.getsClient(), "101");
            WeighBridgeApp.getApplication().getSAPSession().execute(bReason);
            List<MvtReasonsGetListStructure> brReasons = bReason.getTdMvtsReasons();
            entityManager.getTransaction().begin();
            for (MvtReasonsGetListStructure r : brReasons) {
                Reason reason = new Reason(r.getMandt(), r.getBwart(), r.getGrund());
                reason.setGrtxt(r.getGrtxt());
                entityManager.persist(reason);
                reasons.add(reason);
            }
            entityManager.getTransaction().commit();
            entityManager.clear();
        }
        return new DefaultComboBoxModel(reasons.toArray());
    }

    private void printWT(WeightTicket wt, boolean reprint) {
        config = WeighBridgeApp.getApplication().getConfig();
        try {
            Map<String, Object> map = new HashMap<String, Object>();
            Long bags = null;
            if (outbDel != null && ( outbDel.getLfart().equalsIgnoreCase("LF") ||  outbDel.getLfart().equalsIgnoreCase("ZTLF") ) && wt.getMatnrRef().equalsIgnoreCase(setting.getMatnrPcb40())) {
                Double tmp = (outbDel.getLfimg().doubleValue() * 1000d) / 50d;
                bags = tmp.longValue();
            }
            map.put("P_MANDT", WeighBridgeApp.getApplication().getConfig().getsClient());
            map.put("P_WPlant", WeighBridgeApp.getApplication().getConfig().getwPlant());
            map.put("P_ID", wt.getWeightTicketPK().getId());
            map.put("P_DAYSEQ", wt.getWeightTicketPK().getSeqByDay());
            map.put("P_REPRINT", reprint);
            if (bags != null) {
                map.put("P_PCB40BAG", bags);
            }

            String reportName = null;
            reportName = "./rpt/WeightTicket.jasper";
            Class.forName((String) JpaProperties.getProperties().get(PersistenceUnitProperties.JDBC_DRIVER));
            Connection jdbcCon = DriverManager.getConnection(
                    (String) JpaProperties.getProperties().get(PersistenceUnitProperties.JDBC_URL),
                    (String) JpaProperties.getProperties().get(PersistenceUnitProperties.JDBC_USER),
                    (String) JpaProperties.getProperties().get(PersistenceUnitProperties.JDBC_PASSWORD));
            JasperPrint jasperPrint = JasperFillManager.fillReport(reportName, map, jdbcCon);
            JasperViewer jv = new JasperViewer(jasperPrint, false);
            jv.setVisible(true);
        } catch (Exception ex) {
            logger.error(null, ex);
            JOptionPane.showMessageDialog(rootPane, ex);
        }
    }

    private void getSAPMatData(DocumentEvent e) {
        if (weightTicket == null) {
            return;
        }
        try {
            String val = e.getDocument().getText(0, e.getDocument().getLength()).trim();
            if (!val.isEmpty()) {
                material = SAP2Local.getMaterialDetail(val);
            }
        } catch (Exception ex) {
            logger.error(null, ex);
        } finally {
            setSaveNeeded(isValidated());
        }
    }

    public boolean isValidated() {
        config = WeighBridgeApp.getApplication().getConfig();
        boolean result = false, bMisc = false, bPO = false, bMB1B = false, bMvt311 = false, bScale = false, bSLoc = false, bBatch = false;
        boolean bMaterial = false, bBatchMng = false;
        if (chkDissolved.isSelected()) {
            bMisc = bPO = bMB1B = bMvt311 = bScale = bSLoc = bBatch = !isDissolved();
            rbtMisc.setForeground(Color.black);
            rbtPO.setForeground(Color.black);
            rbtMb1b.setForeground(Color.black);
            rbtMvt311.setForeground(Color.black);
            lblIScale.setForeground(Color.black);
            lblOScale.setForeground(Color.black);
            lblGScale.setForeground(Color.black);
            lblSLoc.setForeground(Color.black);
            lblBatch.setForeground(Color.black);
        } else {
            if (grbType.getSelection() == null && isWithoutDO()) {
                rbtMisc.setForeground(Color.red);
                rbtPO.setForeground(Color.red);
                rbtMb1b.setForeground(Color.red);
                rbtMvt311.setForeground(Color.red);
            } else {
                rbtMisc.setForeground(Color.black);
                rbtPO.setForeground(Color.black);
                rbtMb1b.setForeground(Color.black);
                rbtMvt311.setForeground(Color.black);
                bMisc = rbtMisc.isSelected();
                bPO = true;
                bMB1B = true;
                bMvt311 = true;
            }
            if (rbtPO.isSelected() && isEnteredValidPONum() && isValidPONum()) {
                rbtPO.setForeground(Color.black);
                bPO = true;
            } else if (rbtPO.isSelected() && (!isEnteredValidPONum() || isValidPONum())) {
                rbtPO.setForeground(Color.red);
                bPO = false;
            }

            if (rbtMb1b.isSelected() && weightTicket.getRecvLgort() == null) {
                rbtMb1b.setForeground(Color.red);
                bMB1B = false;
            } else {
                rbtMb1b.setForeground(Color.black);
                bMB1B = true;
            }

            if (rbtMvt311.isSelected() && (weightTicket.getRecvLgort() == null || weightTicket.getRecvMatnr() == null)) {
                rbtMvt311.setForeground(Color.red);
                bMvt311 = false;
            } else {
                rbtMvt311.setForeground(Color.black);
                bMvt311 = true;
            }

            if (!txtMatnr.getText().trim().isEmpty() && material != null) {
                bMaterial = true;
                if (material.getXchpf() != null && material.getXchpf().charValue() == 'X') {
                    bBatchMng = true;
                } else {
                    bBatchMng = false;
                }
            } else {
                bMaterial = bBatchMng = false;
            }

            if (!isStage1() && !isStage2()) {
                bScale = true;
            }
            if (isStage1()) {
                bScale = !(txfInQty.getValue() == null);
                if (bScale) {
                    lblIScale.setForeground(Color.black);
                } else {
                    lblIScale.setForeground(Color.red);
                }
            } else if (isStage2()) {
                bScale = !(txfOutQty.getValue() == null && txfGoodsQty.getValue() == null);
                if (bScale) {
                    lblOScale.setForeground(Color.black);
                    lblGScale.setForeground(Color.black);
                } else {
                    lblOScale.setForeground(Color.red);
                    lblGScale.setForeground(Color.red);
                }
            }
            bSLoc = !(cbxSLoc.getSelectedIndex() == -1);
            bBatch = !((cbxBatch.getSelectedIndex() == -1 && !cbxBatch.isEditable()) || (cbxBatch.isEditable() && cbxBatch.getEditor().getItem().toString().trim().isEmpty()));
            if (bMisc) {
                bSLoc = true;
                bBatch = true;
            }
            if (!bBatch && bMaterial && !bBatchMng) {
                bBatch = true;
            }
            if (bSLoc) {
                lblSLoc.setForeground(Color.black);
            } else {
                lblSLoc.setForeground(Color.red);
            }
            if (bBatch) {
                lblBatch.setForeground(Color.black);
            } else {
                lblBatch.setForeground(Color.red);
            }
        }

        result = (bMisc || bPO || bMB1B || bMvt311) && bScale && bSLoc && bBatch && (isStage1() || isStage2() || (!isStage1() && !isStage2() && weightTicket != null && (weightTicket.getPosted() == null || !weightTicket.getPosted())));
        return result;
    }
    // </editor-fold>
    //<editor-fold defaultstate="collapsed" desc="Variables declaration Area">
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnAccept;
    private javax.swing.JButton btnIScaleReset;
    private javax.swing.JButton btnOScaleReset;
    private javax.swing.JButton btnReprint;
    private javax.swing.JButton btnSave;
    private javax.swing.JComboBox cbxBatch;
    private javax.swing.JComboBox cbxCompleted;
    private javax.swing.JComboBox cbxReason;
    private javax.swing.JComboBox cbxSLoc;
    private javax.swing.JCheckBox chkDissolved;
    private com.gcs.wb.model.AppConfig config;
    private javax.persistence.EntityManager entityManager;
    private javax.swing.ButtonGroup grbBridge;
    private javax.swing.ButtonGroup grbCat;
    private javax.swing.ButtonGroup grbType;
    private javax.swing.JLabel lblBatch;
    private javax.swing.JLabel lblCMNDBL;
    private javax.swing.JLabel lblCementDesc;
    private javax.swing.JLabel lblComplete;
    private javax.swing.JLabel lblDName;
    private javax.swing.JLabel lblDelNum;
    private javax.swing.JLabel lblGRText;
    private javax.swing.JLabel lblGScale;
    private javax.swing.JLabel lblGUnit;
    private javax.swing.JLabel lblIScale;
    private javax.swing.JLabel lblITime;
    private javax.swing.JLabel lblIUnit;
    private javax.swing.JLabel lblKG;
    private javax.swing.JLabel lblLicPlate;
    private javax.swing.JLabel lblMatnr;
    private javax.swing.JLabel lblOScale;
    private javax.swing.JLabel lblOTime;
    private javax.swing.JLabel lblOUnit;
    private javax.swing.JLabel lblReason;
    private javax.swing.JLabel lblRegCat;
    private javax.swing.JLabel lblRegItem;
    private javax.swing.JLabel lblSLoc;
    private javax.swing.JLabel lblTrailerPlate;
    private javax.swing.JLabel lblWTNum;
    private com.gcs.wb.jpa.entity.Material material;
    private com.gcs.wb.jpa.entity.OutbDel outbDel;
    private javax.swing.JPanel pnCurScale;
    private javax.swing.JPanel pnCurScaleData;
    private javax.swing.JPanel pnScaleData;
    private javax.swing.JPanel pnWTFilter;
    private javax.swing.JPanel pnWTicket;
    private com.gcs.wb.jpa.entity.PurOrder purOrder;
    private javax.swing.JRadioButton rbtBridge1;
    private javax.swing.JRadioButton rbtBridge2;
    private javax.swing.JRadioButton rbtInward;
    private javax.swing.JRadioButton rbtMb1b;
    private javax.swing.JRadioButton rbtMisc;
    private javax.swing.JRadioButton rbtMvt311;
    private javax.swing.JRadioButton rbtOutward;
    private javax.swing.JRadioButton rbtPO;
    private com.gcs.wb.jpa.entity.SAPSetting setting;
    private javax.swing.JFormattedTextField txfCurScale;
    private javax.swing.JFormattedTextField txfGoodsQty;
    private javax.swing.JFormattedTextField txfInQty;
    private javax.swing.JFormattedTextField txfOutQty;
    private javax.swing.JTextField txtCMNDBL;
    private javax.swing.JTextField txtCementDesc;
    private javax.swing.JTextField txtDName;
    private javax.swing.JTextField txtDelNum;
    private javax.swing.JTextField txtGRText;
    private javax.swing.JTextField txtInTime;
    private javax.swing.JFormattedTextField txtLicPlate;
    private javax.swing.JTextField txtMatnr;
    private javax.swing.JTextField txtOutTime;
    private javax.swing.JTextField txtPONum;
    private javax.swing.JTextField txtRegItem;
    private javax.swing.JFormattedTextField txtTrailerPlate;
    private javax.swing.JTextField txtWTNum;
    private com.gcs.wb.jpa.entity.WeightTicket weightTicket;
    private org.jdesktop.beansbinding.BindingGroup bindingGroup;
    // End of variables declaration//GEN-END:variables
    private static Logger logger = Logger.getLogger(WeightTicketView.class);
    SimpleDateFormat formatter = new SimpleDateFormat();
    // </editor-fold>
}
