/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * WTRegView.java
 *
 * Created on 10-04-2010, 10:06:26
 */
package com.gcs.wb.views;

import com.gcs.wb.WeighBridgeApp;
import com.gcs.wb.bapi.helper.SAP2Local;
import com.gcs.wb.jpa.JpaProperties;
import com.gcs.wb.jpa.controller.WeightTicketJpaController;
import com.gcs.wb.jpa.entity.Customer;
import com.gcs.wb.jpa.entity.CustomerPK;
import com.gcs.wb.jpa.entity.OutbDel;
import com.gcs.wb.jpa.entity.OutbDelPK;
import com.gcs.wb.jpa.entity.SAPSetting;
import com.gcs.wb.jpa.entity.TransportAgent;
import com.gcs.wb.jpa.entity.Vehicle;
import com.gcs.wb.jpa.entity.Vendor;
import com.gcs.wb.jpa.entity.VendorPK;
import com.gcs.wb.jpa.entity.WeightTicket;
import com.gcs.wb.jpa.entity.WeightTicketPK;
import com.gcs.wb.model.AppConfig;
import com.gcs.wb.utils.Conversion_Exit;
import com.gcs.wb.utils.RegexFormatter;
import com.sap.conn.jco.JCoException;
import java.awt.Color;
import java.awt.event.KeyEvent;
import java.math.BigDecimal;
import java.sql.Connection;
import java.sql.DriverManager;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import javax.persistence.TypedQuery;
import javax.swing.JOptionPane;
import net.sf.jasperreports.engine.JasperFillManager;
import net.sf.jasperreports.engine.JasperPrint;
import net.sf.jasperreports.engine.data.JRTableModelDataSource;
import net.sf.jasperreports.view.JasperViewer;
import org.apache.log4j.Logger;
import org.eclipse.persistence.config.PersistenceUnitProperties;
import org.hibersap.HibersapException;
import org.jdesktop.application.Action;
import org.jdesktop.application.Task;

/**
 *
 * @author vunguyent
 */
public class WTRegView extends javax.swing.JInternalFrame {

    /** Creates new form WTRegView */
    public WTRegView(String _mode) {
        this.mode = _mode;
        initComponents();
        weightTicketList = new ArrayList<WeightTicket>();
        ListWeightTicketsTask t = new ListWeightTicketsTask(WeighBridgeApp.getApplication());
        t.execute();
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {
        bindingGroup = new org.jdesktop.beansbinding.BindingGroup();

        rbtRegCatGroup = new javax.swing.ButtonGroup();
        newWeightTicket = new com.gcs.wb.jpa.entity.WeightTicket();
        selectedRow = new com.gcs.wb.jpa.entity.WeightTicket();
        entityManager = WeighBridgeApp.getApplication().getEm();
        outbDel = new com.gcs.wb.jpa.entity.OutbDel();
        pnFilter = new javax.swing.JPanel();
        lblFrom = new javax.swing.JLabel();
        dpFrom = new org.jdesktop.swingx.JXDatePicker();
        lblTo = new javax.swing.JLabel();
        dpTo = new org.jdesktop.swingx.JXDatePicker();
        btnFind = new javax.swing.JButton();
        pnWTs = new javax.swing.JScrollPane();
        tabWTs = new org.jdesktop.swingx.JXTable();
        pnPrintControl = new javax.swing.JPanel();
        btnReprint = new javax.swing.JButton();
        btnPrintRpt = new javax.swing.JButton();
        pnWTicket = new javax.swing.JPanel();
        lblDName = new javax.swing.JLabel();
        txtDName = new javax.swing.JTextField();
        lblCMNDBL = new javax.swing.JLabel();
        txtCMNDBL = new javax.swing.JTextField();
        lblLicPlate = new javax.swing.JLabel();
        txtLicPlate = new javax.swing.JTextField();
        lblTrailerPlate = new javax.swing.JLabel();
        txtTrailerPlate = new javax.swing.JFormattedTextField(new RegexFormatter("\\d{2}[A-Z]-\\d{4}"));
        lblRegCat = new javax.swing.JLabel();
        rbtInward = new javax.swing.JRadioButton();
        rbtOutward = new javax.swing.JRadioButton();
        lblRegItem = new javax.swing.JLabel();
        txtRegItem = new javax.swing.JTextField();
        lblRegQty = new javax.swing.JLabel();
        lblUnit = new javax.swing.JLabel();
        txfRegQty = new javax.swing.JFormattedTextField();
        lblDelNum = new javax.swing.JLabel();
        txtDelNum = new javax.swing.JTextField();
        pnControl = new javax.swing.JPanel();
        btnNew = new javax.swing.JButton();
        btnClear = new javax.swing.JButton();
        btnSave = new javax.swing.JButton();

        setClosable(true);
        setMaximizable(true);
        setResizable(true);
        org.jdesktop.application.ResourceMap resourceMap = org.jdesktop.application.Application.getInstance(com.gcs.wb.WeighBridgeApp.class).getContext().getResourceMap(WTRegView.class);
        setTitle(resourceMap.getString("Form.title")); // NOI18N
        setName("Form"); // NOI18N

        pnFilter.setBorder(javax.swing.BorderFactory.createTitledBorder(resourceMap.getString("pnFilter.border.title"))); // NOI18N
        pnFilter.setName("pnFilter"); // NOI18N
        pnFilter.setLayout(new javax.swing.BoxLayout(pnFilter, javax.swing.BoxLayout.LINE_AXIS));

        lblFrom.setText(resourceMap.getString("lblFrom.text")); // NOI18N
        lblFrom.setName("lblFrom"); // NOI18N
        pnFilter.add(lblFrom);

        dpFrom.setDate(Calendar.getInstance().getTime());
        dpFrom.setName("dpFrom"); // NOI18N
        pnFilter.add(dpFrom);

        lblTo.setText(resourceMap.getString("lblTo.text")); // NOI18N
        lblTo.setName("lblTo"); // NOI18N
        pnFilter.add(lblTo);

        dpTo.setDate(Calendar.getInstance().getTime());
        dpTo.setName("dpTo"); // NOI18N
        pnFilter.add(dpTo);

        javax.swing.ActionMap actionMap = org.jdesktop.application.Application.getInstance(com.gcs.wb.WeighBridgeApp.class).getContext().getActionMap(WTRegView.class, this);
        btnFind.setAction(actionMap.get("listWeightTickets")); // NOI18N
        btnFind.setText(resourceMap.getString("btnFind.text")); // NOI18N
        btnFind.setName("btnFind"); // NOI18N
        pnFilter.add(btnFind);

        if(this.mode.equalsIgnoreCase(this.MODE_REG)){
            pnWTs.setBorder(javax.swing.BorderFactory.createTitledBorder(resourceMap.getString("pnWTs.border.title"))); // NOI18N
        }else if(this.mode.equalsIgnoreCase(this.MODE_RPT)){
            pnWTs.setBorder(javax.swing.BorderFactory.createTitledBorder("Kết quả")); // NOI18N
        }
        pnWTs.setName("pnWTs"); // NOI18N

        tabWTs.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {},
                {},
                {},
                {}
            },
            new String [] {

            }
        ));
        tabWTs.setEditable(false);
        tabWTs.setName("tabWTs"); // NOI18N
        tabWTs.setShowGrid(true);
        pnWTs.setViewportView(tabWTs);

        pnPrintControl.setName("pnPrintControl"); // NOI18N
        pnPrintControl.setLayout(new javax.swing.BoxLayout(pnPrintControl, javax.swing.BoxLayout.LINE_AXIS));

        btnReprint.setAction(actionMap.get("reprintRecord")); // NOI18N
        btnReprint.setText(resourceMap.getString("btnReprint.text")); // NOI18N
        btnReprint.setName("btnReprint"); // NOI18N
        pnPrintControl.add(btnReprint);
        btnReprint.setVisible(this.mode.equalsIgnoreCase(this.MODE_REG));

        btnPrintRpt.setAction(actionMap.get("printReport")); // NOI18N
        btnPrintRpt.setText(resourceMap.getString("btnPrintRpt.text")); // NOI18N
        btnPrintRpt.setName("btnPrintRpt"); // NOI18N
        pnPrintControl.add(btnPrintRpt);
        btnPrintRpt.setVisible(this.mode.equalsIgnoreCase(this.MODE_RPT));

        pnWTicket.setName("pnWTicket"); // NOI18N

        lblDName.setText(resourceMap.getString("lblDName.text")); // NOI18N
        lblDName.setName("lblDName"); // NOI18N

        txtDName.setName("txtDName"); // NOI18N

        org.jdesktop.beansbinding.Binding binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, newWeightTicket, org.jdesktop.beansbinding.ELProperty.create("${tenTaiXe}"), txtDName, org.jdesktop.beansbinding.BeanProperty.create("text"));
        bindingGroup.addBinding(binding);
        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${formEditable}"), txtDName, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        txtDName.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txtDNameKeyReleased(evt);
            }
        });

        lblCMNDBL.setText(resourceMap.getString("lblCMNDBL.text")); // NOI18N
        lblCMNDBL.setName("lblCMNDBL"); // NOI18N

        txtCMNDBL.setName("txtCMNDBL"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, newWeightTicket, org.jdesktop.beansbinding.ELProperty.create("${cmndBl}"), txtCMNDBL, org.jdesktop.beansbinding.BeanProperty.create("text"));
        bindingGroup.addBinding(binding);
        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${formEditable}"), txtCMNDBL, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        txtCMNDBL.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txtCMNDBLKeyReleased(evt);
            }
        });

        lblLicPlate.setText(resourceMap.getString("lblLicPlate.text")); // NOI18N
        lblLicPlate.setName("lblLicPlate"); // NOI18N

        txtLicPlate.setName("txtLicPlate"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, newWeightTicket, org.jdesktop.beansbinding.ELProperty.create("${soXe}"), txtLicPlate, org.jdesktop.beansbinding.BeanProperty.create("text"));
        bindingGroup.addBinding(binding);
        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${formEditable}"), txtLicPlate, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        txtLicPlate.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtLicPlateActionPerformed(evt);
            }
        });
        txtLicPlate.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txtLicPlateKeyReleased(evt);
            }
        });

        lblTrailerPlate.setText(resourceMap.getString("lblTrailerPlate.text")); // NOI18N
        lblTrailerPlate.setName("lblTrailerPlate"); // NOI18N

        txtTrailerPlate.setName("txtTrailerPlate"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, newWeightTicket, org.jdesktop.beansbinding.ELProperty.create("${soRomooc}"), txtTrailerPlate, org.jdesktop.beansbinding.BeanProperty.create("value"));
        bindingGroup.addBinding(binding);
        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${formEditable}"), txtTrailerPlate, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        lblRegCat.setText(resourceMap.getString("lblRegCat.text")); // NOI18N
        lblRegCat.setName("lblRegCat"); // NOI18N

        rbtRegCatGroup.add(rbtInward);
        rbtInward.setText(resourceMap.getString("rbtInward.text")); // NOI18N
        rbtInward.setName("rbtInward"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${rbtEnabled}"), rbtInward, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        rbtInward.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                rbtInwardItemStateChanged(evt);
            }
        });

        rbtRegCatGroup.add(rbtOutward);
        rbtOutward.setText(resourceMap.getString("rbtOutward.text")); // NOI18N
        rbtOutward.setName("rbtOutward"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${rbtEnabled}"), rbtOutward, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        rbtOutward.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                rbtOutwardItemStateChanged(evt);
            }
        });

        lblRegItem.setText(resourceMap.getString("lblRegItem.text")); // NOI18N
        lblRegItem.setName("lblRegItem"); // NOI18N

        txtRegItem.setName("txtRegItem"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, newWeightTicket, org.jdesktop.beansbinding.ELProperty.create("${regItemText}"), txtRegItem, org.jdesktop.beansbinding.BeanProperty.create("text"));
        bindingGroup.addBinding(binding);
        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${formEditable}"), txtRegItem, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        txtRegItem.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txtRegItemKeyReleased(evt);
            }
        });

        lblRegQty.setText(resourceMap.getString("lblRegQty.text")); // NOI18N
        lblRegQty.setName("lblRegQty"); // NOI18N

        lblUnit.setText(resourceMap.getString("lblUnit.text")); // NOI18N
        lblUnit.setName("lblUnit"); // NOI18N

        txfRegQty.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter()));
        txfRegQty.setName("txfRegQty"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${formEditable}"), txfRegQty, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        txfRegQty.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txfRegQtyKeyReleased(evt);
            }
        });

        lblDelNum.setText(resourceMap.getString("lblDelNum.text")); // NOI18N
        lblDelNum.setName("lblDelNum"); // NOI18N

        txtDelNum.setAction(actionMap.get("checkDO")); // NOI18N
        txtDelNum.setName("txtDelNum"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, newWeightTicket, org.jdesktop.beansbinding.ELProperty.create("${delivNumb}"), txtDelNum, org.jdesktop.beansbinding.BeanProperty.create("text"));
        bindingGroup.addBinding(binding);
        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, this, org.jdesktop.beansbinding.ELProperty.create("${formValid}"), txtDelNum, org.jdesktop.beansbinding.BeanProperty.create("enabled"));
        bindingGroup.addBinding(binding);

        txtDelNum.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txtDelNumKeyReleased(evt);
            }
        });

        javax.swing.GroupLayout pnWTicketLayout = new javax.swing.GroupLayout(pnWTicket);
        pnWTicket.setLayout(pnWTicketLayout);
        pnWTicketLayout.setHorizontalGroup(
            pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnWTicketLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(lblTrailerPlate)
                    .addComponent(lblLicPlate)
                    .addComponent(lblCMNDBL)
                    .addComponent(lblDName))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(txtLicPlate, javax.swing.GroupLayout.DEFAULT_SIZE, 212, Short.MAX_VALUE)
                    .addComponent(txtCMNDBL, javax.swing.GroupLayout.DEFAULT_SIZE, 212, Short.MAX_VALUE)
                    .addComponent(txtDName, javax.swing.GroupLayout.DEFAULT_SIZE, 212, Short.MAX_VALUE)
                    .addComponent(txtTrailerPlate, javax.swing.GroupLayout.DEFAULT_SIZE, 212, Short.MAX_VALUE))
                .addGap(49, 49, 49)
                .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(lblRegItem)
                    .addComponent(lblRegCat)
                    .addComponent(lblRegQty)
                    .addComponent(lblDelNum))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(pnWTicketLayout.createSequentialGroup()
                        .addComponent(rbtInward)
                        .addGap(18, 18, 18)
                        .addComponent(rbtOutward))
                    .addComponent(txtRegItem, javax.swing.GroupLayout.DEFAULT_SIZE, 212, Short.MAX_VALUE)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pnWTicketLayout.createSequentialGroup()
                        .addComponent(txfRegQty, javax.swing.GroupLayout.DEFAULT_SIZE, 173, Short.MAX_VALUE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(lblUnit))
                    .addComponent(txtDelNum, javax.swing.GroupLayout.DEFAULT_SIZE, 212, Short.MAX_VALUE))
                .addContainerGap())
        );
        pnWTicketLayout.setVerticalGroup(
            pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnWTicketLayout.createSequentialGroup()
                .addContainerGap(11, Short.MAX_VALUE)
                .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblDName)
                    .addComponent(txtDName, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblRegCat)
                    .addComponent(rbtInward)
                    .addComponent(rbtOutward))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(pnWTicketLayout.createSequentialGroup()
                        .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(lblCMNDBL)
                            .addComponent(txtCMNDBL, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(lblLicPlate)
                            .addComponent(txtLicPlate, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(lblTrailerPlate)
                            .addComponent(txtTrailerPlate, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
                    .addGroup(pnWTicketLayout.createSequentialGroup()
                        .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(lblRegItem)
                            .addComponent(txtRegItem, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(lblRegQty)
                            .addComponent(lblUnit)
                            .addComponent(txfRegQty, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(pnWTicketLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(lblDelNum)
                            .addComponent(txtDelNum, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))))
        );

        pnControl.setName("pnControl"); // NOI18N
        pnControl.setLayout(new javax.swing.BoxLayout(pnControl, javax.swing.BoxLayout.LINE_AXIS));

        btnNew.setAction(actionMap.get("newRecord")); // NOI18N
        btnNew.setText(resourceMap.getString("btnNew.text")); // NOI18N
        btnNew.setName("btnNew"); // NOI18N
        pnControl.add(btnNew);

        btnClear.setAction(actionMap.get("clearForm")); // NOI18N
        btnClear.setText(resourceMap.getString("btnClear.text")); // NOI18N
        btnClear.setName("btnClear"); // NOI18N
        pnControl.add(btnClear);

        btnSave.setAction(actionMap.get("saveRecord")); // NOI18N
        btnSave.setText(resourceMap.getString("btnSave.text")); // NOI18N
        btnSave.setName("btnSave"); // NOI18N
        pnControl.add(btnSave);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(pnFilter, javax.swing.GroupLayout.DEFAULT_SIZE, 624, Short.MAX_VALUE)
            .addComponent(pnControl, javax.swing.GroupLayout.DEFAULT_SIZE, 624, Short.MAX_VALUE)
            .addComponent(pnWTicket, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addComponent(pnPrintControl, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, 624, Short.MAX_VALUE)
            .addComponent(pnWTs, javax.swing.GroupLayout.DEFAULT_SIZE, 624, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(pnFilter, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(pnWTs, javax.swing.GroupLayout.DEFAULT_SIZE, 248, Short.MAX_VALUE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(pnPrintControl, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(pnWTicket, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(pnControl, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );

        pnWTicket.setVisible(this.mode.equalsIgnoreCase(this.MODE_REG));
        pnControl.setVisible(this.mode.equalsIgnoreCase(this.MODE_REG));

        bindingGroup.bind();

        pack();
    }// </editor-fold>//GEN-END:initComponents

    // <editor-fold defaultstate="collapsed" desc="Event methods">
    private void txtDNameKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txtDNameKeyReleased
        setSaveNeeded(isValidated());
}//GEN-LAST:event_txtDNameKeyReleased

    private void txtCMNDBLKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txtCMNDBLKeyReleased
        setSaveNeeded(isValidated());
}//GEN-LAST:event_txtCMNDBLKeyReleased

    private void rbtInwardItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_rbtInwardItemStateChanged
        setSaveNeeded(isValidated());
}//GEN-LAST:event_rbtInwardItemStateChanged

    private void rbtOutwardItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_rbtOutwardItemStateChanged
        setSaveNeeded(isValidated());
}//GEN-LAST:event_rbtOutwardItemStateChanged

    private void txtRegItemKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txtRegItemKeyReleased
        setSaveNeeded(isValidated());
}//GEN-LAST:event_txtRegItemKeyReleased

    private void txfRegQtyKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txfRegQtyKeyReleased
        setSaveNeeded(isValidated());
}//GEN-LAST:event_txfRegQtyKeyReleased

    private void txtDelNumKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txtDelNumKeyReleased
        if (txtDelNum.getText() == null) {
            return;
        }
        String val = txtDelNum.getText().trim();
        //val = Conversion_Exit.Conv_output_num(val, 10); //+20100112#01 conversion number output
        if (val.length() == 0 || (validDO && val.length() >= 7 && validDO && val.length() <= 10)) {
            if ((evt.isControlDown() && evt.getKeyCode() == KeyEvent.VK_V) || (evt.isShiftDown() && evt.getKeyCode() == KeyEvent.VK_INSERT)) {
                validDO = false;
                lblDelNum.setForeground(Color.red);
            } else {
                lblDelNum.setForeground(Color.black);
            }
        } else {
            validDO = false;
            lblDelNum.setForeground(Color.red);
        }
        if (val.length() == 0) {
            validDO = true;
            setRbtEnabled(true);
        } else {
            setRbtEnabled(false);
        }
        setSaveNeeded(isValidated() && validDO);
}//GEN-LAST:event_txtDelNumKeyReleased

    private void txtLicPlateKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txtLicPlateKeyReleased
        if (!evt.isActionKey() && evt.getKeyCode() != KeyEvent.VK_ENTER && evt.getKeyCode() != KeyEvent.VK_ESCAPE) {
            setSaveNeeded(isValidated());
        }
    }//GEN-LAST:event_txtLicPlateKeyReleased

    private void txtLicPlateActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtLicPlateActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_txtLicPlateActionPerformed

    @Action(block = Task.BlockingScope.ACTION)
    public Task listWeightTickets() {
        return new ListWeightTicketsTask(WeighBridgeApp.getApplication());
    }

    @Action(block = Task.BlockingScope.ACTION)
    public Task reprintRecord() {
        if (tabWTs.getSelectedRow() == -1) {
            return null;
        } else {
            return new ReprintRecordTask(WeighBridgeApp.getApplication());
        }
    }

    @Action(block = Task.BlockingScope.ACTION)
    public Task printReport() {
        if (tabWTs.getModel().getRowCount() == 0) {
            return null;
        } else {
            return new PrintReportTask(org.jdesktop.application.Application.getInstance(com.gcs.wb.WeighBridgeApp.class));
        }
    }

    @Action(block = Task.BlockingScope.ACTION)
    public Task checkDO() {
        String val = txtDelNum.getText().trim();
        //+20100106 convert DO number to SAP format
        val = Conversion_Exit.Conv_output_num(val, 10);
        //+20100106 convert DO number to SAP format
        if (val.length() == 10) {
            return new CheckDOTask(WeighBridgeApp.getApplication());
        } else if (val.length() == 0) {
            lblDelNum.setForeground(Color.black);
            validDO = true;
            setSaveNeeded(isValidated() && validDO);
            return null;
        } else {
            lblDelNum.setForeground(Color.red);
            validDO = false;
            setSaveNeeded(isValidated() && validDO);
            return null;
        }
    }

    @Action(enabledProperty = "creatable")
    public void newRecord() {
        setFormEditable(true);
        setRbtEnabled(true);
        setCreatable(false);
        setClearable(true);
        setSaveNeeded(isValidated());
    }

    @Action(enabledProperty = "clearable")
    public void clearForm() {
        cleanData();
        setCreatable(true);
        setFormEditable(false);
        setRbtEnabled(false);
        setSaveNeeded(false);
        setClearable(false);
    }

    @Action(enabledProperty = "saveNeeded")
    public Task saveRecord() {
        int answer = -1;
        if (txtDelNum.getText().trim().isEmpty()) {
            answer = JOptionPane.showConfirmDialog(
                    this.getRootPane(),
                    "Bạn có muốn tiếp lục lưu phiếu đăng tài không có số D.O???",
                    JOptionPane.OPTIONS_PROPERTY,
                    JOptionPane.YES_NO_OPTION,
                    JOptionPane.QUESTION_MESSAGE);
        } else {
            answer = JOptionPane.YES_OPTION;
        }
        if (answer == JOptionPane.YES_OPTION) {
            return new SaveRecordTask(WeighBridgeApp.getApplication());
        } else {
            return null;
        }
    }
    // </editor-fold>
    // <editor-fold defaultstate="collapsed" desc="Task Classes">

    private class ListWeightTicketsTask extends org.jdesktop.application.Task<Object, Void> {

        ListWeightTicketsTask(org.jdesktop.application.Application app) {
            // Runs on the EDT.  Copy GUI state that
            // doInBackground() depends on from parameters
            // to ListWeightTicketsTask fields, here.
            super(app);
        }

        @SuppressWarnings("unchecked")
        @Override
        protected Object doInBackground() {
            try {
                setProgress(0, 0, 4);
                weightTicketList.clear();

                setProgress(1, 0, 4);
                setMessage("Đang lấy dữ liệu...");
                AppConfig config = WeighBridgeApp.getApplication().getConfig();
                WeightTicketJpaController conWTicket = new WeightTicketJpaController(entityManager);
                List<WeightTicket> data = conWTicket.findByCreateDateRange(dpFrom.getDate(), dpTo.getDate());

                setProgress(2, 0, 4);
                setMessage("Đang xử lý dữ liệu...");
                weightTicketList.addAll(data);
                if (getMode().equalsIgnoreCase(WTRegView.MODE_REG)) {
                    wtData = new Object[weightTicketList.size()][wtCols.length];
                } else if (getMode().equalsIgnoreCase(WTRegView.MODE_RPT)) {
                    wtRptData = new Object[weightTicketList.size()][wtRptCols.length];
                }
                for (int i = 0; i < weightTicketList.size(); i++) {
                    WeightTicket item = weightTicketList.get(i);
                    if (getMode().equalsIgnoreCase(WTRegView.MODE_REG)) {
                        WeightTicketPK pk = item.getWeightTicketPK();
                        if (!pk.getMandt().equalsIgnoreCase(config.getsClient()) && !pk.getWPlant().equalsIgnoreCase(config.getwPlant().toString())) {
                            continue;
                        }
                        wtData[i][0] = pk.getSeqByDay();
                        wtData[i][1] = item.getTenTaiXe();
                        wtData[i][2] = item.getCmndBl();
                        wtData[i][3] = item.getSoXe();
                        wtData[i][4] = item.getSoRomooc();
                        wtData[i][5] = item.getRegCategory();
                        wtData[i][6] = item.getRegItemText();
                        wtData[i][7] = item.getRegItemQty();
                        wtData[i][8] = item.getDelivNumb();
                        wtData[i][9] = item.getCreator();
                        wtData[i][10] = item.getSeqByMonth();
                        wtData[i][11] = item.getCreateDate();
                        String hh;
                        String mm;
                        String ss;
                        hh = item.getCreateTime().substring(0, 2);
                        mm = item.getCreateTime().substring(2, 4);
                        ss = item.getCreateTime().substring(4);
                        wtData[i][12] = hh + ":" + mm + ":" + ss;
                        wtData[i][13] = item.getDissolved();
                        wtData[i][14] = item.getPosted();
                    } else if (getMode().equalsIgnoreCase(WTRegView.MODE_RPT)) {
                        String hh;
                        String mm;
                        String ss;
                        hh = item.getCreateTime().substring(0, 2);
                        mm = item.getCreateTime().substring(2, 4);
                        ss = item.getCreateTime().substring(4);
                        Calendar create_date = Calendar.getInstance();
                        create_date.setTime(item.getCreateDate());
                        create_date.set(Calendar.HOUR_OF_DAY, Integer.valueOf(hh));
                        create_date.set(Calendar.MINUTE, Integer.valueOf(mm));
                        create_date.set(Calendar.SECOND, Integer.valueOf(ss));
                        wtRptData[i][0] = i + 1;// item.getSeqByMonth();
                        wtRptData[i][1] = item.getWeightTicketPK().getSeqByDay();
                        wtRptData[i][2] = item.getTenTaiXe();
                        wtRptData[i][3] = item.getCmndBl();
                        wtRptData[i][4] = item.getSoXe();
                        wtRptData[i][5] = item.getSoRomooc();
                        wtRptData[i][6] = item.getCreator();
                        wtRptData[i][7] = create_date.getTime();
                        wtRptData[i][8] = item.getRegCategory();
                        wtRptData[i][9] = item.getRegItemText();
                        wtRptData[i][10] = item.getFTime();
                        wtRptData[i][11] = item.getFScale() == null ? item.getFScale() : item.getFScale().doubleValue() / 1000d;
                        wtRptData[i][12] = item.getSTime();
                        wtRptData[i][13] = item.getSScale() == null ? item.getSScale() : item.getSScale().doubleValue() / 1000d;
                        wtRptData[i][14] = item.getGQty();
                        wtRptData[i][15] = item.getDelivNumb();
                        wtRptData[i][16] = item.getMatDoc();
                        wtRptData[i][17] = item.getDissolved();
                        wtRptData[i][18] = item.getPosted();
                        Vehicle v = entityManager.find(Vehicle.class, item.getSoXe());
                        if (v != null && v.getTaAbbr() != null) {
                            TransportAgent tagent = entityManager.find(TransportAgent.class, v.getTaAbbr());
                            if (tagent != null) {
                                wtRptData[i][19] = tagent.getName();
                            }
                        }
                        wtRptData[i][20] = item.getEbeln();
                    }
                }
                setProgress(3, 0, 4);
                editable = new boolean[getMode().equalsIgnoreCase(WTRegView.MODE_REG) ? wtCols.length : wtRptCols.length];
                for (int i = 0; i < editable.length; i++) {
                    editable[i] = false;
                }
                setProgress(4, 0, 4);
            } catch (Exception ex) {
                failed(ex);
            }
            return null; // return your result
        }

        @Override
        protected void succeeded(Object result) {
            // Runs on the EDT.  Update the GUI based on
            // the result computed by doInBackground().
        }

        @Override
        protected void finished() {
            setMessage("Hoàn tất...");
            if (getMode().equalsIgnoreCase(WTRegView.MODE_REG)) {
                WeighBridgeApp.getApplication().bindJTableModel(tabWTs, wtData, wtCols, wtTypes, editable);
            } else if (getMode().equalsIgnoreCase(WTRegView.MODE_RPT)) {
                WeighBridgeApp.getApplication().bindJTableModel(tabWTs, wtRptData, wtRptCols, wtRptTypes, editable);
            }
            setCreatable(true);
            setFormEditable(false);
            setRbtEnabled(false);
            setClearable(false);
            setSaveNeeded(false);
            clearForm();
        }

        @Override
        protected void failed(Throwable cause) {
            logger.error(null, cause);
            JOptionPane.showMessageDialog(rootPane, cause.getMessage());
        }
    }

    private class ReprintRecordTask extends org.jdesktop.application.Task<Object, Void> {

        ReprintRecordTask(org.jdesktop.application.Application app) {
            // Runs on the EDT.  Copy GUI state that
            // doInBackground() depends on from parameters
            // to ReprintRecordTask fields, here.
            super(app);
        }

        @Override
        protected Object doInBackground() {
            selectedRow = weightTicketList.get(tabWTs.convertRowIndexToModel(tabWTs.getSelectedRow()));
            if (selectedRow != null) {
                try {
                   // if (selectedRow.getDissolved() == null)
                  //  {
                  //      selectedRow.setDissolved(false);
                   // }
                   if ((selectedRow.getDissolved() == null) ||(selectedRow.getDissolved() == false)){ //+20100112#01 Không cho in khi phiếu đăng tài bị hủy
                        setMessage("Đang in lại phiếu đăng tài...");
                        printWT(selectedRow, true);
                    } else { //+20100112#01  Không cho in khi phiếu đăng tài bị hủy
                        setMessage("Phiếu đăng tài đã bị hủy...");
                    } //+20100112#01  Không cho in khi phiếu đăng tài bị hủy
                } catch (Exception ex) {
                    failed(ex);
                }
            }
            return null;  // return your result
        }

        @Override
        protected void failed(Throwable cause) {
            JOptionPane.showMessageDialog(rootPane, cause);
        }

        @Override
        protected void succeeded(Object result) {
            // Runs on the EDT.  Update the GUI based on
            // the result computed by doInBackground().
        }

        @Override
        protected void finished() {
            setMessage("Hoàn tất...");
        }
    }

    private class PrintReportTask extends org.jdesktop.application.Task<Object, Void> {

        PrintReportTask(org.jdesktop.application.Application app) {
            // Runs on the EDT.  Copy GUI state that
            // doInBackground() depends on from parameters
            // to PrintReportTask fields, here.
            super(app);
        }

        @Override
        protected Object doInBackground() {
            try {
                Map<String, Object> params = new HashMap<String, Object>();
                params.put("P_PNAME_RPT", WeighBridgeApp.getApplication().getSapSetting().getNameRpt());
                params.put("P_PADDRESS", WeighBridgeApp.getApplication().getSapSetting().getAddress());
                params.put("P_PPHONE", WeighBridgeApp.getApplication().getSapSetting().getPhone());
                params.put("P_PFAX", WeighBridgeApp.getApplication().getSapSetting().getFax());
                params.put("P_FROM", dpFrom.getDate());
                params.put("P_TO", dpTo.getDate());
                String reportName = null;
                reportName = "./rpt/WTList.jasper";
                JasperPrint jasperPrint = JasperFillManager.fillReport(reportName, params, new JRTableModelDataSource(tabWTs.getModel()));
                JasperViewer jv = new JasperViewer(jasperPrint, false);
                jv.setVisible(true);
            } catch (Exception ex) {
                failed(ex);
            }
            return null;  // return your result
        }

        @Override
        protected void failed(Throwable cause) {
            logger.error(null, cause);
            JOptionPane.showMessageDialog(rootPane, cause.getMessage());
        }
    }

    private class CheckDOTask extends org.jdesktop.application.Task<Object, Void> {

        private OutbDel outb = null;
        private OutbDelPK outbPK = null;
        private String mode = null;
        private Customer kunnr = null;
        private Customer kunag = null;
        private Vendor lifnr = null;
        private Customer sapKunnr = null;
        private Customer sapKunag = null;
        private Vendor sapLifnr = null;

        CheckDOTask(org.jdesktop.application.Application app) {
            // Runs on the EDT.  Copy GUI state that
            // doInBackground() depends on from parameters
            // to CheckDOTask fields, here.
            super(app);
            outbDel = null;
        }

        @Override
        protected Object doInBackground() {
            setMessage("Kiểm tra D.O trong CSDL ...");
            setProgress(1, 1, 4);
            String val = txtDelNum.getText().trim();
            //+20100106 convert DO number to SAP format
            val = Conversion_Exit.Conv_output_num(val, 10);
            //+20100106 convert DO number to SAP format

            outbPK = new OutbDelPK(WeighBridgeApp.getApplication().getConfig().getsClient(), val);
            outb = entityManager.find(OutbDel.class, outbPK);
            setMessage("Kiểm tra D.O trong SAP ...");
            setProgress(2, 1, 4);
            OutbDel sapOutb = SAP2Local.getOutboundDelivery(val);
            if (sapOutb != null) {
                if (sapOutb.getKunnr() != null && !sapOutb.getKunnr().trim().isEmpty()) {
                    kunnr = entityManager.find(
                            Customer.class,
                            new CustomerPK(WeighBridgeApp.getApplication().getConfig().getsClient(), sapOutb.getKunnr()));
                    sapKunnr = SAP2Local.getCustomer(sapOutb.getKunnr());
                }
                if (sapOutb.getKunag() != null && !sapOutb.getKunag().trim().isEmpty()) {
                    kunag = entityManager.find(
                            Customer.class,
                            new CustomerPK(WeighBridgeApp.getApplication().getConfig().getsClient(), sapOutb.getKunag()));
                    sapKunag = SAP2Local.getCustomer(sapOutb.getKunag());
                }
                if (sapOutb.getLifnr() != null && !sapOutb.getLifnr().trim().isEmpty()) {
                    lifnr = entityManager.find(
                            Vendor.class,
                            new VendorPK(WeighBridgeApp.getApplication().getConfig().getsClient(), sapOutb.getLifnr()));
                    sapLifnr = SAP2Local.getVendor(sapOutb.getLifnr());
                }

            }
            setMessage("Lưu dữ liệu D.O xuống CSDL ...");
            setProgress(3, 1, 4);
            entityManager.getTransaction().begin();
            //Store Ship to party Info
            if (sapKunnr != null && kunnr == null) {
                entityManager.persist(sapKunnr);
            } else if (sapKunnr != null && kunnr != null) {
                entityManager.merge(sapKunnr);
            } else if (sapKunnr == null && kunnr != null) {
                entityManager.remove(kunnr);
            }
            //Store Sold to party Info
            if (sapKunag != null && kunag == null && !sapOutb.getKunnr().equalsIgnoreCase(sapOutb.getKunag())) {
                entityManager.persist(sapKunag);
            } else if (sapKunag != null && kunag != null) {
                entityManager.merge(sapKunag);
            } else if (sapKunag == null && kunag != null && !sapOutb.getKunnr().equalsIgnoreCase(sapOutb.getKunag())) {
                entityManager.remove(kunag);
            }
            //Store Vendor Info
            if (sapLifnr != null && lifnr == null) {
                entityManager.persist(sapLifnr);
            } else if (sapLifnr != null && lifnr != null) {
                entityManager.merge(sapLifnr);
            } else if (sapLifnr == null && lifnr != null) {
                entityManager.remove(lifnr);
            }
            if (sapOutb != null && outb == null) {
                entityManager.persist(sapOutb);
                outb = sapOutb;
                validDO = true;
            } else if (sapOutb != null && outb != null) {
                entityManager.merge(sapOutb);
                outb = sapOutb;
                validDO = true;
            } else {
                if (outb != null) {
                    entityManager.remove(outb);
                    outb = null;
                }
                validDO = false;
                String msg = "Số D.O \" " + val + " \" không tồn tại!";
                setMessage(msg);
                JOptionPane.showMessageDialog(rootPane, msg);
            }
            entityManager.getTransaction().commit();
            entityManager.clear();
            //Set Mode
            if (validDO && outb != null) {
                /**
                 * At this screen, if enter D.O type LF => Outward mode
                 * Otherwise, Inward mode.
                 */
                if (outb.getLfart().equalsIgnoreCase("LF") || outb.getLfart().equalsIgnoreCase("ZTLF")) {
                    rbtOutward.setSelected(true);
                    mode = "xuất";
                } else {
                    rbtInward.setSelected(true);
                    mode = "nhập";
                }
            }
            //Check suitable plant from D.O for In/Outward mode against working plant.
            if (validDO && outb != null) {
                String msg = null;
                //{-20101203#01 - comment logic to check plant
                /*
                if (((outb.getLfart().equalsIgnoreCase("LF") || outb.getLfart().equalsIgnoreCase("LR")||outb.getLfart().equalsIgnoreCase("ZTLF") || outb.getLfart().equalsIgnoreCase("ZTLR")) && (outb.getWerks() != null && !outb.getWerks().equalsIgnoreCase(WeighBridgeApp.getApplication().getConfig().getwPlant())))
                        || ((!outb.getLfart().equalsIgnoreCase("LF") && !outb.getLfart().equalsIgnoreCase("LR") && !outb.getLfart().equalsIgnoreCase("ZTLF") && !outb.getLfart().equalsIgnoreCase("ZTLR")) && (outb.getRecvPlant() != null && !outb.getRecvPlant().equalsIgnoreCase(WeighBridgeApp.getApplication().getConfig().getwPlant())))) {
                
                
                    msg = "D.O \" " + val + " \" không được phép dùng để " + mode
                            + " hàng trong Plant \" "
                            + WeighBridgeApp.getApplication().getConfig().getwPlant() + " \" !";
                    setMessage(msg);
                    JOptionPane.showMessageDialog(rootPane, msg);
                    validDO = false;
                    outb = null;
                } */
                //}-20101203#01 - comment logic to check plant
            }
            //Check if D.O was used already or not???
            if (validDO && outb != null) {
                WeightTicket wt = null;
                try {
                    TypedQuery<WeightTicket> tqWt = entityManager.createNamedQuery("WeightTicket.findByMandtWPlantDelivNumb", WeightTicket.class);
                    tqWt.setParameter("mandt", WeighBridgeApp.getApplication().getConfig().getsClient());
                    tqWt.setParameter("wPlant", WeighBridgeApp.getApplication().getConfig().getwPlant());
                    tqWt.setParameter("delivNumb", outb.getOutbDelPK().getDelivNumb());
                    wt = tqWt.getSingleResult();
                } catch (Exception ex) {
                    wt = null;
                }
                if (((outb.getLfart().equalsIgnoreCase("LF") || outb.getLfart().equalsIgnoreCase("LR") || outb.getLfart().equalsIgnoreCase("ZTLF") || outb.getLfart().equalsIgnoreCase("ZTLR")) && outb.getWbstk() == 'X')
                        || (wt != null && (wt.getDissolved() == null || wt.getDissolved() == false))) {
                    validDO = false;
                    outb = null;
                    String msg = "D.O \" " + val + " \" đã được dùng để " + mode + " hàng!";
                    setMessage(msg);
                    JOptionPane.showMessageDialog(rootPane, msg);
                }
            }

            if (validDO) {
                newWeightTicket.setItem(outb.getDelivItem());
                newWeightTicket.setMatnrRef(outb.getMatnr());
                newWeightTicket.setRegItemText(outb.getArktx());
                newWeightTicket.setUnit(outb.getVrkme());
                txtRegItem.setText(outb.getArktx());
                outbDel = outb;
            }
            setProgress(4, 1, 4);
            return null;  // return your result
        }

        @Override
        protected void failed(Throwable cause) {
            validDO = false;
            if (cause instanceof HibersapException && cause.getCause() instanceof JCoException) {
                cause = cause.getCause();
            }
            logger.error(null, cause);
            JOptionPane.showMessageDialog(rootPane, cause.getMessage());
        }

        @Override
        protected void finished() {
            if (validDO) {
                lblDelNum.setForeground(Color.black);
            } else {
                lblDelNum.setForeground(Color.red);
            }
            setRbtEnabled(!validDO);
            setSaveNeeded(isValidated() && validDO);
        }
    }

    private class SaveRecordTask extends org.jdesktop.application.Task<Object, Void> {

        SaveRecordTask(org.jdesktop.application.Application app) {
            // Runs on the EDT.  Copy GUI state that
            // doInBackground() depends on from parameters
            // to SaveRecordTask fields, here.
            super(app);
            setSaveNeeded(false);
            setClearable(false);
        }

        @Override
        protected Object doInBackground() {
            Date now = Calendar.getInstance().getTime();
            SimpleDateFormat formatter = new SimpleDateFormat();
            AppConfig sap = WeighBridgeApp.getApplication().getConfig();
            WeightTicketJpaController wCon = new WeightTicketJpaController(entityManager);

            int seqBDay = wCon.getNewSeqBDay();
            int seqBMonth = wCon.getNewSeqBMonth();

            formatter.applyPattern("yyMMddHHmm");
            String id = formatter.format(now);

            newWeightTicket.setWeightTicketPK(new WeightTicketPK(sap.getsClient(), sap.getwPlant().toString(), id, seqBDay));

            newWeightTicket.setSeqByMonth(seqBMonth);
            newWeightTicket.setCreateDate(now);
            formatter.applyPattern("HHmmss");
            newWeightTicket.setCreateTime(formatter.format(now));
            newWeightTicket.setCreator(WeighBridgeApp.getApplication().getLogin().getUserPK().getId());
            newWeightTicket.setOfflineMode(WeighBridgeApp.getApplication().isOfflineMode());
            newWeightTicket.setRegCategory(rbtInward.isSelected() ? 'I' : 'O');
            newWeightTicket.setRegItemQty(new BigDecimal(((Number) txfRegQty.getValue()).doubleValue()));

            if (newWeightTicket.getDelivNumb() != null && newWeightTicket.getDelivNumb().trim().isEmpty()) {
                newWeightTicket.setDelivNumb(null);
                newWeightTicket.setItem(null);
                newWeightTicket.setMatnrRef(null);
                newWeightTicket.setRegItemText(null);
                newWeightTicket.setUnit(null);
            }
            //+20100113#01
            if (newWeightTicket.getDelivNumb() != null && !newWeightTicket.getDelivNumb().trim().isEmpty()) {
              String val =   newWeightTicket.getDelivNumb();
              val = Conversion_Exit.Conv_output_num(val, 10);
              newWeightTicket.setDelivNumb(val);
            }
            //+20100113#01
            setMessage("Đang lưu dữ liệu...");
            entityManager.getTransaction().begin();
            entityManager.persist(newWeightTicket);
            entityManager.getTransaction().commit();
            try {
                setMessage("Đang in phiếu đăng tài...");
                printWT(newWeightTicket, false);
            } catch (Exception ex) {
            }
            ListWeightTicketsTask t = new ListWeightTicketsTask(this.getApplication());
            t.execute();
            return null;  // return your result
        }

        @Override
        protected void failed(Throwable cause) {
            entityManager.getTransaction().rollback();
            setSaveNeeded(true);
        }

        @Override
        protected void finished() {
            setMessage("Hoàn tất...");
            entityManager.clear();
            cleanData();
            setCreatable(true);
            setFormEditable(false);
            setRbtEnabled(false);
            setClearable(false);
            setSaveNeeded(false);
        }
    }
    // </editor-fold>
    // <editor-fold defaultstate="collapsed" desc="Form's properties">
    private boolean creatable = false;

    public boolean isCreatable() {
        return creatable;
    }

    public void setCreatable(boolean b) {
        boolean old = isCreatable();
        this.creatable = b;
        firePropertyChange("creatable", old, isCreatable());
    }
    private boolean clearable = false;

    public boolean isClearable() {
        return clearable;
    }

    public void setClearable(boolean b) {
        boolean old = isClearable();
        this.clearable = b;
        firePropertyChange("clearable", old, isClearable());
    }
    private boolean saveNeeded = false;

    public boolean isSaveNeeded() {
        return saveNeeded;
    }

    public void setSaveNeeded(boolean b) {
        boolean old = isSaveNeeded();
        this.saveNeeded = b;
        firePropertyChange("saveNeeded", old, isSaveNeeded());
    }
    // </editor-fold>
    // <editor-fold defaultstate="collapsed" desc="Util methods">

    public boolean isValidated() {
        boolean bDriName = false, bCMNDBL = false, bLicPlate = false,
                bRegCat = false, bRegITxt = false, bRegIQty = false,
                bResult = false;
        bDriName = !(txtDName.getText() == null || txtDName.getText().trim().isEmpty());
        if (bDriName) {
            lblDName.setForeground(Color.black);
        } else {
            lblDName.setForeground(Color.red);
        }
        bCMNDBL = !(txtCMNDBL.getText() == null || txtCMNDBL.getText().trim().isEmpty() || txtCMNDBL.getText().trim().length() > 9);
        if (bCMNDBL) {
            lblCMNDBL.setForeground(Color.black);
        } else {
            lblCMNDBL.setForeground(Color.red);
        }
        Matcher m = patLicPlate.matcher(txtLicPlate.getText().trim());
        bLicPlate = !(txtLicPlate.getText().trim().isEmpty() || !m.matches());
        if (bLicPlate) {
            if (txtDelNum.getText().trim().isEmpty() || outbDel == null) {
                bLicPlate = checkLicPlate(null, null);
            } else {
                bLicPlate = checkLicPlate(outbDel.getLfart(), outbDel.getTraid());
            }
        }
        if (bLicPlate) {
            lblLicPlate.setForeground(Color.black);
        } else {
            lblLicPlate.setForeground(Color.red);
        }
        bRegCat = rbtInward.isSelected() || rbtOutward.isSelected();
        if (bRegCat) {
            lblRegCat.setForeground(Color.black);
        } else {
            lblRegCat.setForeground(Color.red);
        }
        bRegITxt = !(txtRegItem.getText() == null || txtRegItem.getText().trim().isEmpty());
        if (bRegITxt) {
            lblRegItem.setForeground(Color.black);
        } else {
            lblRegItem.setForeground(Color.red);
        }
        bRegIQty = !(txfRegQty.getValue() == null || ((Number) txfRegQty.getValue()).doubleValue() <= 0d);
        if (bRegIQty) {
            lblRegQty.setForeground(Color.black);
        } else {
            lblRegQty.setForeground(Color.red);
        }

        bResult = bDriName && bCMNDBL && bLicPlate && bRegCat && bRegITxt && bRegIQty;
        setFormValid(bResult);
        return bResult && validDO;
    }

    private void printWT(WeightTicket wt, boolean reprint) throws Exception {
        try {
            Map<String, Object> map = new HashMap<String, Object>();
            map.put("P_CLIENT", WeighBridgeApp.getApplication().getConfig().getsClient());
            map.put("P_WPLANT", WeighBridgeApp.getApplication().getConfig().getwPlant());
            map.put("P_ID", wt.getWeightTicketPK().getId());
            map.put("P_DAYSEQ", wt.getWeightTicketPK().getSeqByDay());
            map.put("P_REPRINT", reprint);
            String reportName = null;
//            reportName = "./rpt/RegWT.jrxml";
            reportName = "./rpt/RegWT.jasper";
//            JasperDesign jasperDesign = JRXmlLoader.load(reportName);
//            JasperReport jasperReport = JasperCompileManager.compileReport(jasperDesign);
            Class.forName((String) JpaProperties.getProperties().get(PersistenceUnitProperties.JDBC_DRIVER));
            Connection jdbcCon = DriverManager.getConnection(
                    (String) JpaProperties.getProperties().get(PersistenceUnitProperties.JDBC_URL),
                    (String) JpaProperties.getProperties().get(PersistenceUnitProperties.JDBC_USER),
                    (String) JpaProperties.getProperties().get(PersistenceUnitProperties.JDBC_PASSWORD));

//            JasperPrint jasperPrint = JasperFillManager.fillReport(jasperReport, map, jdbcCon);
            JasperPrint jasperPrint = JasperFillManager.fillReport(reportName, map, jdbcCon);
            JasperViewer jv = new JasperViewer(jasperPrint, false);
            jv.setVisible(true);
        } catch (Exception ex) {
            logger.error(null, ex);
            throw ex;
        }
    }

    private boolean checkLicPlate(String lfart, String traid) {
        boolean result = false;
        if (lfart != null && ( lfart.equalsIgnoreCase("LF") || lfart.equalsIgnoreCase("ZTLF") ) ) {
            String txt = traid;
            String doLicPlate = null;
            int idx1 = txt.indexOf("|");
            int idx2 = txt.indexOf("\\");
            if (idx1 >= 0 || idx2 >= 0) {
                int splitPos = idx1 < 0 ? idx2 : idx1;
                int bIdx = splitPos - 8;
                int eIdx = -1;
                if (bIdx < 0) {
                    bIdx = 0;
                }
                doLicPlate = txt.substring(bIdx, splitPos);
                splitPos++;
                eIdx = splitPos + 8;
                if (eIdx >= txt.length()) {
                    eIdx = txt.length() - 1;
                }
                if (splitPos < eIdx) {
//                            outb.setSoRomooc(txt.substring(splitPos, eIdx));
                }
            } else {
                int countSpace = 0;
                int[] pos = new int[3];
                char[] chars = txt.toCharArray();
                for (int x = 0; x < chars.length; x++) {
                    char c = chars[x];
                    if (c == ' ') {
                        pos[countSpace] = x;
                        countSpace++;
                    }
                }
                if (countSpace == 3) {
                    int splitPos = pos[1];
                    int bIdx = splitPos - 8;
                    int eIdx = -1;
                    if (bIdx < 0) {
                        bIdx = 0;
                    }
                    doLicPlate = txt.substring(bIdx, splitPos);
                    splitPos++;
                    eIdx = splitPos + 8;
                    if (eIdx >= txt.length()) {
                        eIdx = txt.length() - 1;
                    }
                    if (splitPos < eIdx) {
//                        outb.setSoRomooc(txt.substring(splitPos, eIdx));
                    }
                } else {
                    doLicPlate = traid;
                }
            }
            if (doLicPlate.equalsIgnoreCase(newWeightTicket.getSoXe())) {
                result = true;
            } else {
                result = false;
                JOptionPane.showMessageDialog(rootPane, "Số xe \"" + newWeightTicket.getSoXe()
                        + "\" không khớp với số được đăng ký trong D.O: " + doLicPlate);
            }
        } else {
            //Do local check for entered Truck's License Plate
            SAPSetting sapSetting = WeighBridgeApp.getApplication().getSapSetting();
            Vehicle v = entityManager.find(Vehicle.class, newWeightTicket.getSoXe());
            if (v == null
                    && (sapSetting.getCheckTalp() != null && sapSetting.getCheckTalp().booleanValue() == true)) {
                result = false;
                JOptionPane.showMessageDialog(rootPane, "Số xe \" " + newWeightTicket.getSoXe()
                        + " \" chưa được đăng ký để xuất/nhập hàng!");
            } else {
                result = true;
            }
        }
        return result;
    }

    private void cleanData() {
        newWeightTicket.setWeightTicketPK(null);
        outbDel = null;
        txtDName.setText("");
        txtCMNDBL.setText("");
        txtLicPlate.setText("");
        txtTrailerPlate.setValue(null);
        rbtRegCatGroup.clearSelection();
        rbtInward.setEnabled(true);
        rbtOutward.setEnabled(true);
        txtRegItem.setText("");
        txfRegQty.setValue(null);
        txtDelNum.setText("");

        lblDName.setForeground(Color.black);
        lblCMNDBL.setForeground(Color.black);
        lblLicPlate.setForeground(Color.black);
        lblTrailerPlate.setForeground(Color.black);
        lblRegCat.setForeground(Color.black);
        lblRegItem.setForeground(Color.black);
        lblRegQty.setForeground(Color.black);
        lblDelNum.setForeground(Color.black);
        validDO = true;
    }
    // </editor-fold>
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnClear;
    private javax.swing.JButton btnFind;
    private javax.swing.JButton btnNew;
    private javax.swing.JButton btnPrintRpt;
    private javax.swing.JButton btnReprint;
    private javax.swing.JButton btnSave;
    private org.jdesktop.swingx.JXDatePicker dpFrom;
    private org.jdesktop.swingx.JXDatePicker dpTo;
    private javax.persistence.EntityManager entityManager;
    private javax.swing.JLabel lblCMNDBL;
    private javax.swing.JLabel lblDName;
    private javax.swing.JLabel lblDelNum;
    private javax.swing.JLabel lblFrom;
    private javax.swing.JLabel lblLicPlate;
    private javax.swing.JLabel lblRegCat;
    private javax.swing.JLabel lblRegItem;
    private javax.swing.JLabel lblRegQty;
    private javax.swing.JLabel lblTo;
    private javax.swing.JLabel lblTrailerPlate;
    private javax.swing.JLabel lblUnit;
    private com.gcs.wb.jpa.entity.WeightTicket newWeightTicket;
    private com.gcs.wb.jpa.entity.OutbDel outbDel;
    private javax.swing.JPanel pnControl;
    private javax.swing.JPanel pnFilter;
    private javax.swing.JPanel pnPrintControl;
    private javax.swing.JPanel pnWTicket;
    private javax.swing.JScrollPane pnWTs;
    private javax.swing.JRadioButton rbtInward;
    private javax.swing.JRadioButton rbtOutward;
    private javax.swing.ButtonGroup rbtRegCatGroup;
    private com.gcs.wb.jpa.entity.WeightTicket selectedRow;
    private org.jdesktop.swingx.JXTable tabWTs;
    private javax.swing.JFormattedTextField txfRegQty;
    private javax.swing.JTextField txtCMNDBL;
    private javax.swing.JTextField txtDName;
    private javax.swing.JTextField txtDelNum;
    private javax.swing.JTextField txtLicPlate;
    private javax.swing.JTextField txtRegItem;
    private javax.swing.JFormattedTextField txtTrailerPlate;
    private org.jdesktop.beansbinding.BindingGroup bindingGroup;
    // End of variables declaration//GEN-END:variables
    private static Logger logger = Logger.getLogger(WTRegView.class);
    private java.util.List<WeightTicket> weightTicketList;
    private boolean validDO = true;
    private static final Pattern patLicPlate = Pattern.compile("\\d{2}[A-Z]-\\d{4}");
    private boolean formValid;
    public static final String PROP_FORMVALID = "formValid";
    public static final String MODE_REG = "MODE_REG";
    public static final String MODE_RPT = "MODE_RPT";
    private String mode = null;

    /**
     * Get the value of mode
     *
     * @return the value of mode
     */
    public String getMode() {
        return mode;
    }

    /**
     * Set the value of mode
     *
     * @param mode new value of mode
     */
    public void setMode(String mode) {
        this.mode = mode;
    }

    /**
     * Get the value of formValid
     *
     * @return the value of formValid
     */
    public boolean isFormValid() {
        return formValid;
    }

    /**
     * Set the value of formValid
     *
     * @param formValid new value of formValid
     */
    public void setFormValid(boolean formValid) {
        boolean oldFormValid = this.formValid;
        this.formValid = formValid;
        firePropertyChange(PROP_FORMVALID, oldFormValid, formValid);
    }
    private boolean formEditable;
    public static final String PROP_FORMEDITABLE = "formEditable";

    /**
     * Get the value of formEditable
     *
     * @return the value of formEditable
     */
    public boolean isFormEditable() {
        return formEditable;
    }

    /**
     * Set the value of formEditable
     *
     * @param formEditable new value of formEditable
     */
    public void setFormEditable(boolean formEditable) {
        boolean oldFormEditable = this.formEditable;
        this.formEditable = formEditable;
        firePropertyChange(PROP_FORMEDITABLE, oldFormEditable, formEditable);
    }
    private boolean rbtEnabled;
    public static final String PROP_RBTENABLED = "rbtEnabled";

    /**
     * Get the value of rbtEnabled
     *
     * @return the value of rbtEnabled
     */
    public boolean isRbtEnabled() {
        return rbtEnabled;
    }

    /**
     * Set the value of rbtEnabled
     *
     * @param rbtEnabled new value of rbtEnabled
     */
    public void setRbtEnabled(boolean rbtEnabled) {
        boolean oldRbtEnabled = this.rbtEnabled;
        this.rbtEnabled = rbtEnabled;
        firePropertyChange(PROP_RBTENABLED, oldRbtEnabled, rbtEnabled);
    }
    private boolean[] editable = null;
    Object[][] wtData = null;
    Object[] wtCols = new String[]{
        "Số tài",
        "Tên tài xế",
        "CMND/BL",
        "B.S Xe",
        "B.S Rơmoóc",
        "Nhập/Xuất (I/O)",
        "Loại hàng đăng ký",
        "Trọng lượng đăng ký",
        "Số D.O",
        "Người tạo",
        "Số Phiếu trong tháng",
        "Ngày",
        "Giờ",
        "Hủy",
        "SAP Posted"};
    Class[] wtTypes = new Class[]{
        Integer.class,
        String.class,
        String.class,
        String.class,
        String.class,
        Character.class,
        String.class,
        BigDecimal.class,
        String.class,
        String.class,
        Integer.class,
        Date.class,
        String.class,
        Boolean.class,
        Boolean.class};
    Object[][] wtRptData = null;
    Object[] wtRptCols = new String[]{
        "STT",
        "S.Đ.Tài",
        "Tên tài xế",
        "CMND/BL",
        "Số Xe",
        "Số Rơmoóc",
        "Người tạo",
        "Ngày giờ tạo",
        "Nhập/Xuất(I/O)",
        "Loại hàng",
        "Ngày giờ vào",
        "T.L vào",
        "Ngày giờ ra",
        "T.L ra",
        "T.L Hàng",
        "Số D.O",
        "Số chứng từ SAP",
        "Hủy",
        "SAP Posted",
        "Đơn vị vân chuyển",
        "Số P.O"};
    Class[] wtRptTypes = new Class[]{
        Integer.class,
        Integer.class,
        String.class,
        String.class,
        String.class,
        String.class,
        String.class,
        Date.class,
        Character.class,
        String.class,
        Date.class,
        BigDecimal.class,
        Date.class,
        BigDecimal.class,
        BigDecimal.class,
        String.class,
        String.class,
        Boolean.class,
        Boolean.class,
        String.class,
        String.class};
}
