/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * SettingView.java
 *
 * Created on 17-06-2010, 14:41:08
 */
package com.gcs.wb.views;

import com.gcs.wb.WeighBridgeApp;
import com.gcs.wb.base.constant.Constants;
import com.gcs.wb.base.validator.LengthValidator;
import com.gcs.wb.base.validator.PhoneValidator;
import com.gcs.wb.jpa.JPAConnector;
import com.gcs.wb.jpa.entity.SAPSetting;
import java.awt.Color;
import javax.persistence.EntityManager;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import org.apache.log4j.Level;
import org.apache.log4j.Logger;
import org.jdesktop.application.Action;
import org.jdesktop.application.Task;

/**
 *
 * @author vunguyent
 */
public class SettingView extends javax.swing.JDialog {

    private EntityManager entityManager = JPAConnector.getInstance();
    private boolean isNamePRTValid = true;
    private boolean isAddressValid = true;
    private boolean isPhoneValid = true;
    private boolean isFaxValid = true;

    /** Creates new form SettingView */
    public SettingView(java.awt.Frame parent) {
        super(parent);
        initComponents();

        // set select for checkbox chkPOV
        chkPOV.setSelected(sapSetting.getCheckPov() != null && sapSetting.getCheckPov());
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {
        bindingGroup = new org.jdesktop.beansbinding.BindingGroup();

        sapSetting = java.beans.Beans.isDesignTime() ? null : WeighBridgeApp.getApplication().getSapSetting();
        pnWholeGroup = new javax.swing.JPanel();
        pnWPlant = new javax.swing.JPanel();
        lblNameRPT = new javax.swing.JLabel();
        txtNameRPT = new javax.swing.JTextField();
        lblAddress = new javax.swing.JLabel();
        txtAddress = new javax.swing.JTextField();
        lblPhone = new javax.swing.JLabel();
        txtPhone = new javax.swing.JTextField();
        lblFax = new javax.swing.JLabel();
        txtFax = new javax.swing.JTextField();
        pnPO = new javax.swing.JPanel();
        chkPOV = new javax.swing.JCheckBox();
        btnSave = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        org.jdesktop.application.ResourceMap resourceMap = org.jdesktop.application.Application.getInstance(com.gcs.wb.WeighBridgeApp.class).getContext().getResourceMap(SettingView.class);
        setTitle(resourceMap.getString("Form.title")); // NOI18N
        setModal(true);
        setName("Form"); // NOI18N
        setResizable(false);

        pnWholeGroup.setName("pnWholeGroup"); // NOI18N

        pnWPlant.setBorder(javax.swing.BorderFactory.createTitledBorder(resourceMap.getString("pnWPlant.border.title"))); // NOI18N
        pnWPlant.setName("pnWPlant"); // NOI18N

        lblNameRPT.setText(resourceMap.getString("lblNameRPT.text")); // NOI18N
        lblNameRPT.setName("lblNameRPT"); // NOI18N

        txtNameRPT.setName("txtNameRPT"); // NOI18N

        org.jdesktop.beansbinding.Binding binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, sapSetting, org.jdesktop.beansbinding.ELProperty.create("${nameRpt}"), txtNameRPT, org.jdesktop.beansbinding.BeanProperty.create("text"), "");
        bindingGroup.addBinding(binding);

        txtNameRPT.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txtNameRPTKeyReleased(evt);
            }
        });

        lblAddress.setText(resourceMap.getString("lblAddress.text")); // NOI18N
        lblAddress.setName("lblAddress"); // NOI18N

        txtAddress.setName("txtAddress"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, sapSetting, org.jdesktop.beansbinding.ELProperty.create("${address}"), txtAddress, org.jdesktop.beansbinding.BeanProperty.create("text"));
        bindingGroup.addBinding(binding);

        txtAddress.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txtAddressKeyReleased(evt);
            }
        });

        lblPhone.setText(resourceMap.getString("lblPhone.text")); // NOI18N
        lblPhone.setName("lblPhone"); // NOI18N

        txtPhone.setName("txtPhone"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, sapSetting, org.jdesktop.beansbinding.ELProperty.create("${phone}"), txtPhone, org.jdesktop.beansbinding.BeanProperty.create("text"));
        bindingGroup.addBinding(binding);

        txtPhone.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txtPhoneKeyReleased(evt);
            }
        });

        lblFax.setText(resourceMap.getString("lblFax.text")); // NOI18N
        lblFax.setName("lblFax"); // NOI18N

        txtFax.setName("txtFax"); // NOI18N

        binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ_WRITE, sapSetting, org.jdesktop.beansbinding.ELProperty.create("${fax}"), txtFax, org.jdesktop.beansbinding.BeanProperty.create("text"));
        bindingGroup.addBinding(binding);

        txtFax.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txtFaxKeyReleased(evt);
            }
        });

        javax.swing.GroupLayout pnWPlantLayout = new javax.swing.GroupLayout(pnWPlant);
        pnWPlant.setLayout(pnWPlantLayout);
        pnWPlantLayout.setHorizontalGroup(
            pnWPlantLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnWPlantLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pnWPlantLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(lblAddress)
                    .addComponent(lblNameRPT))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnWPlantLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(txtAddress, javax.swing.GroupLayout.DEFAULT_SIZE, 199, Short.MAX_VALUE)
                    .addComponent(txtNameRPT, javax.swing.GroupLayout.DEFAULT_SIZE, 199, Short.MAX_VALUE))
                .addGap(10, 10, 10)
                .addGroup(pnWPlantLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(lblPhone)
                    .addComponent(lblFax))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnWPlantLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(txtFax, javax.swing.GroupLayout.DEFAULT_SIZE, 164, Short.MAX_VALUE)
                    .addComponent(txtPhone, javax.swing.GroupLayout.DEFAULT_SIZE, 164, Short.MAX_VALUE))
                .addContainerGap())
        );
        pnWPlantLayout.setVerticalGroup(
            pnWPlantLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pnWPlantLayout.createSequentialGroup()
                .addContainerGap(17, Short.MAX_VALUE)
                .addGroup(pnWPlantLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblNameRPT)
                    .addComponent(txtNameRPT, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblPhone)
                    .addComponent(txtPhone, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnWPlantLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblAddress)
                    .addComponent(txtAddress, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txtFax, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblFax))
                .addContainerGap())
        );

        pnPO.setBorder(javax.swing.BorderFactory.createTitledBorder(resourceMap.getString("pnPO.border.title"))); // NOI18N
        pnPO.setName("pnPO"); // NOI18N

        chkPOV.setText(resourceMap.getString("chkPOV.text")); // NOI18N
        chkPOV.setToolTipText(resourceMap.getString("chkPOV.toolTipText")); // NOI18N
        chkPOV.setName("chkPOV"); // NOI18N

        javax.swing.GroupLayout pnPOLayout = new javax.swing.GroupLayout(pnPO);
        pnPO.setLayout(pnPOLayout);
        pnPOLayout.setHorizontalGroup(
            pnPOLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnPOLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(chkPOV, javax.swing.GroupLayout.PREFERRED_SIZE, 216, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(261, Short.MAX_VALUE))
        );
        pnPOLayout.setVerticalGroup(
            pnPOLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnPOLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(chkPOV)
                .addContainerGap(12, Short.MAX_VALUE))
        );

        javax.swing.ActionMap actionMap = org.jdesktop.application.Application.getInstance(com.gcs.wb.WeighBridgeApp.class).getContext().getActionMap(SettingView.class, this);
        btnSave.setAction(actionMap.get("save")); // NOI18N
        btnSave.setText(resourceMap.getString("btnSave.text")); // NOI18N
        btnSave.setName("btnSave"); // NOI18N

        javax.swing.GroupLayout pnWholeGroupLayout = new javax.swing.GroupLayout(pnWholeGroup);
        pnWholeGroup.setLayout(pnWholeGroupLayout);
        pnWholeGroupLayout.setHorizontalGroup(
            pnWholeGroupLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(pnWPlant, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addComponent(pnPO, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pnWholeGroupLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(btnSave))
        );
        pnWholeGroupLayout.setVerticalGroup(
            pnWholeGroupLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnWholeGroupLayout.createSequentialGroup()
                .addComponent(pnWPlant, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(pnPO, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(btnSave, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );

        pnPO.getAccessibleContext().setAccessibleName(resourceMap.getString("pnMaterials.AccessibleContext.accessibleName")); // NOI18N

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(pnWholeGroup, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(pnWholeGroup, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
        );

        bindingGroup.bind();

        pack();
    }// </editor-fold>//GEN-END:initComponents

private void txtFaxKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txtFaxKeyReleased
    this.isFaxValid = validatePhoneOrFax(this.txtFax.getText(), this.lblFax);
    validateForm();
}//GEN-LAST:event_txtFaxKeyReleased

private void txtNameRPTKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txtNameRPTKeyReleased
    this.isNamePRTValid = validateLength(
            Constants.LengthValidator.MAX_LENGTH_NAMEPRT,
            this.txtNameRPT.getText(), this.lblNameRPT);
    validateForm();
}//GEN-LAST:event_txtNameRPTKeyReleased

private void txtAddressKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txtAddressKeyReleased
    this.isAddressValid = validateLength(
            Constants.LengthValidator.MAX_LENGTH_ADDRESS,
            this.txtAddress.getText(), this.lblAddress);
    validateForm();
}//GEN-LAST:event_txtAddressKeyReleased

private void txtPhoneKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txtPhoneKeyReleased
    this.isPhoneValid = validatePhoneOrFax(this.txtPhone.getText(), this.lblPhone);
    validateForm();
}//GEN-LAST:event_txtPhoneKeyReleased

    void validateForm() {
        this.btnSave.setEnabled(isNamePRTValid && isAddressValid && isPhoneValid && isFaxValid);
    }

    boolean validateLength(int max, String input, JLabel label) {
        try {
            LengthValidator lengthValidator = new LengthValidator(0, max);
            lengthValidator.validate(input);
            label.setForeground(Color.black);
            return true;
        } catch (Exception ex) {
            label.setForeground(Color.red);
            return false;
        }
    }

    boolean validatePhoneOrFax(String input, JLabel label) {
        try {
            PhoneValidator phoneValidator = new PhoneValidator();
            phoneValidator.validate(input);
            label.setForeground(Color.black);
            return true;
        } catch (Exception ex) {
            label.setForeground(Color.red);
            return false;
        }
    }

    @Action
    public Task save() {
        return new SaveTask(WeighBridgeApp.getApplication());
    }

    private class SaveTask extends org.jdesktop.application.Task<Object, Void> {

        SaveTask(org.jdesktop.application.Application app) {
            // Runs on the EDT.  Copy GUI state that
            // doInBackground() depends on from parameters
            // to SaveTask fields, here.
            super(app);
        }

        @Override
        protected Object doInBackground() {
            String tmp = txtNameRPT.getText().trim();
            sapSetting.setNameRpt(tmp.isEmpty() ? null : tmp);
            tmp = txtAddress.getText().trim();
            sapSetting.setAddress(tmp.isEmpty() ? null : tmp);
            tmp = txtPhone.getText().trim();
            sapSetting.setPhone(tmp.isEmpty() ? null : tmp);
            tmp = txtFax.getText().trim();
            sapSetting.setFax(tmp.isEmpty() ? null : tmp);
            sapSetting.setCheckPov(chkPOV.isSelected() ? true : false);

            if (!entityManager.getTransaction().isActive()) {
                entityManager.getTransaction().begin();
            }

            // save sap setting
            entityManager.merge(sapSetting);
            entityManager.getTransaction().commit();
            entityManager.clear();

            sapSetting = entityManager.find(SAPSetting.class, sapSetting.getSAPSettingPK());
            entityManager.clear();

            return null;  // return your result
        }

        @Override
        protected void succeeded(Object result) {
            WeighBridgeApp.getApplication().setSapSetting(sapSetting);
            dispose();
        }

        @Override
        protected void failed(Throwable cause) {
            Logger.getLogger(LoginView.class.getName()).log(Level.ERROR, null, cause);
            JOptionPane.showMessageDialog(rootPane, cause.getMessage());
            done();
        }
    }
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnSave;
    private javax.swing.JCheckBox chkPOV;
    private javax.swing.JLabel lblAddress;
    private javax.swing.JLabel lblFax;
    private javax.swing.JLabel lblNameRPT;
    private javax.swing.JLabel lblPhone;
    private javax.swing.JPanel pnPO;
    private javax.swing.JPanel pnWPlant;
    private javax.swing.JPanel pnWholeGroup;
    private com.gcs.wb.jpa.entity.SAPSetting sapSetting;
    private javax.swing.JTextField txtAddress;
    private javax.swing.JTextField txtFax;
    private javax.swing.JTextField txtNameRPT;
    private javax.swing.JTextField txtPhone;
    private org.jdesktop.beansbinding.BindingGroup bindingGroup;
    // End of variables declaration//GEN-END:variables
}
